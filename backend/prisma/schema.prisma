// Xchange Database Schema
// This schema defines the core data models for the Xchange e-commerce platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Core Models
// ============================================

enum UserType {
  INDIVIDUAL
  BUSINESS
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model User {
  id                String      @id @default(uuid())
  email             String      @unique
  passwordHash      String      @map("password_hash")
  fullName          String      @map("full_name")
  phone             String?     @unique
  userType          UserType    @default(INDIVIDUAL) @map("user_type")
  status            UserStatus  @default(ACTIVE)
  emailVerified     Boolean     @default(false) @map("email_verified")
  phoneVerified     Boolean     @default(false) @map("phone_verified")

  // Profile info
  avatar            String?
  bio               String?
  address           String?
  city              String?
  governorate       String?
  postalCode        String?     @map("postal_code")

  // Primary location (for geographic clustering)
  primaryGovernorate  String?   @map("primary_governorate")
  primaryCity         String?   @map("primary_city")
  primaryLatitude     Float?    @map("primary_latitude")
  primaryLongitude    Float?    @map("primary_longitude")

  // Business info (if userType = BUSINESS)
  businessName      String?     @map("business_name")
  taxId             String?     @map("tax_id")
  commercialRegNo   String?     @map("commercial_reg_no")

  // Ratings
  rating            Float       @default(0.0)
  totalReviews      Int         @default(0) @map("total_reviews")

  // Timestamps
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  lastLoginAt       DateTime?   @map("last_login_at")

  // Relations
  items                     Item[]                    @relation("UserItems")
  listings                  Listing[]                 @relation("UserListings")
  barterOffersInitiated     BarterOffer[]             @relation("BarterInitiator")
  barterOffersReceived      BarterOffer[]             @relation("BarterRecipient")
  barterChainParticipations BarterParticipant[]
  auctionBids               AuctionBid[]
  reverseAuctionsCreated    ReverseAuction[]          @relation("ReverseAuctionBuyer")
  reverseAuctionBids        ReverseAuctionBid[]       @relation("ReverseAuctionSeller")
  transactionsAsBuyer       Transaction[]             @relation("Buyer")
  transactionsAsSeller      Transaction[]             @relation("Seller")
  reviewsGiven              Review[]                  @relation("Reviewer")
  reviewsReceived           Review[]                  @relation("Reviewed")
  wishListItems             WishListItem[]
  refreshTokens             RefreshToken[]
  notifications             Notification[]            @relation("UserNotifications")
  notificationPreferences   NotificationPreference?   @relation("UserPreferences")
  cart                      Cart?
  shippingAddresses         ShippingAddress[]
  orders                    Order[]
  pushSubscriptions         PushSubscription[]

  // New innovative features relations
  wallet                    Wallet?                   // محفظة XCoin
  reputation                UserReputation?           // السمعة متعددة الأبعاد
  userLevel                 UserLevel?                // المستوى والإنجازات
  facilitatorProfile        Facilitator?              // ملف الوسيط المعتمد

  // سوق التوالف - Scrap Marketplace Relations
  scrapDealerVerification   ScrapDealerVerification?  @relation("ScrapDealerUser")
  scrapDealerVerifications  ScrapDealerVerification[] @relation("ScrapDealerVerifier")
  scrapPurchaseRequests     ScrapPurchaseRequest[]    @relation("ScrapPurchaseBuyer")
  scrapSellerOffers         ScrapSellerOffer[]        @relation("ScrapSellerOffers")

  // سوق الذهب - Gold Marketplace Relations
  goldItems                 GoldItem[]                @relation("UserGoldItems")
  goldPurchases             GoldTransaction[]         @relation("UserGoldPurchases")
  goldSales                 GoldTransaction[]         @relation("UserGoldSales")

  // Search & Discovery Relations
  searchHistory             SearchHistory[]           @relation("UserSearchHistory")
  savedSearches             SavedSearch[]             @relation("UserSavedSearches")
  searchAlerts              SearchAlert[]             @relation("UserSearchAlerts")

  // Social Features Relations
  followers                 UserFollow[]              @relation("UserFollowing")
  following                 UserFollow[]              @relation("UserFollowers")
  activityFeed              ActivityFeed[]            @relation("UserActivityFeed")

  // Chat & Messaging Relations
  messagesSent              Message[]                 @relation("MessagesSent")
  messagesReceived          Message[]                 @relation("MessagesReceived")
  typingIndicators          TypingIndicator[]         @relation("UserTypingIndicators")
  blockedUsers              BlockedUser[]             @relation("UserBlocking")
  blockedBy                 BlockedUser[]             @relation("UserBlocked")
  presence                  UserPresence?             @relation("UserPresence")
  conversationsAsParticipant1 Conversation[]          @relation("ConversationParticipant1")
  conversationsAsParticipant2 Conversation[]          @relation("ConversationParticipant2")

  // Additional Relations
  priceAlerts               PriceAlert[]              @relation("UserPriceAlerts")
  challengeParticipations   ChallengeParticipation[]  @relation("UserChallengeParticipations")
  barterPoolParticipations  BarterPoolParticipant[]   @relation("UserBarterPoolParticipations")

  @@map("users")
  @@index([email])
  @@index([phone])
  @@index([userType])
  @@index([status])
}

model RefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  userId      String    @map("user_id")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
  @@index([userId])
  @@index([expiresAt])
}

// ============================================
// Categories
// ============================================

model Category {
  id          String      @id @default(uuid())
  nameAr      String      @map("name_ar")
  nameEn      String      @map("name_en")
  slug        String      @unique
  description String?
  icon        String?
  image       String?
  parentId    String?     @map("parent_id")
  order       Int         @default(0)
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Self-referencing for subcategories
  parent      Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]  @relation("CategoryHierarchy")

  // Relations
  items            Item[]
  itemsDesiring    Item[]           @relation("ItemDesiredCategory")
  reverseAuctions  ReverseAuction[]
  wishListItems    WishListItem[]
  itemRequests     ItemRequest[]
  pricePredictions PricePrediction[]

  @@map("categories")
  @@index([slug])
  @@index([parentId])
  @@index([isActive])
}

// ============================================
// Items (Products/Services)
// ============================================

enum ItemType {
  GOOD      // Physical product
  SERVICE   // Service offering
  CASH      // Cash/money
}

enum ItemCondition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

enum ItemStatus {
  DRAFT
  ACTIVE
  SOLD
  TRADED
  ARCHIVED
  DELETED
}

// ============================================
// Market Types (Geographic Levels)
// النطاق الجغرافي للعرض - المطابقة بالقرب الجغرافي
// ============================================

enum MarketType {
  DISTRICT      // سوق الحي
  CITY          // سوق المدينة
  GOVERNORATE   // سوق المحافظة
  NATIONAL      // السوق الشامل - كل مصر
}

// Promotion/Featured tiers
enum PromotionTier {
  BASIC         // Free listing
  FEATURED      // Featured/highlighted listing
  PREMIUM       // Premium listing with more visibility
  GOLD          // Gold tier - high visibility
  PLATINUM      // Platinum tier - maximum visibility
}

// ============================================
// سوق التوالف - Scrap Marketplace Enums
// ============================================

// طريقة التسعير
enum ScrapPricingType {
  PER_PIECE       // بالقطعة
  PER_KG          // بالكيلو
  PER_LOT         // بالجملة
  REVERSE_AUCTION // مزاد عكسي
}

// حالة التوالف
enum ScrapCondition {
  TOTALLY_DAMAGED   // تالف بالكامل
  NOT_WORKING       // لا يعمل
  PARTIALLY_WORKING // يعمل جزئياً
  WORKING_OLD       // قديم يعمل
}

// نوع المعدن
enum MetalType {
  COPPER          // نحاس
  ALUMINUM        // ألومنيوم
  IRON            // حديد
  STEEL           // صلب
  BRASS           // نحاس أصفر
  BRONZE          // برونز
  LEAD            // رصاص
  ZINC            // زنك
  NICKEL          // نيكل
  TIN             // قصدير
  GOLD            // ذهب
  SILVER          // فضة
  STAINLESS_STEEL // ستانلس ستيل
  MIXED           // مخلوط
}

// نوع التوالف
enum ScrapType {
  ELECTRONICS       // إلكترونيات
  HOME_APPLIANCES   // أجهزة منزلية
  COMPUTERS         // كمبيوترات ولابتوبات
  PHONES            // هواتف وتابلت
  CABLES_WIRES      // كابلات وأسلاك
  MOTORS            // موتورات
  BATTERIES         // بطاريات
  METAL_SCRAP       // خردة معادن
  CAR_PARTS         // قطع غيار سيارات
  FURNITURE_PARTS   // أجزاء أثاث
  WOOD              // خشب
  PLASTIC           // بلاستيك
  TEXTILES          // منسوجات
  PAPER             // ورق وكرتون
  GLASS             // زجاج
  CONSTRUCTION      // مواد بناء
  INDUSTRIAL        // معدات صناعية
  MEDICAL           // معدات طبية
  OTHER             // أخرى
}

// نوع تاجر التوالف
enum ScrapDealerType {
  INDIVIDUAL_COLLECTOR  // جامع فردي
  SCRAP_DEALER          // تاجر خردة
  RECYCLING_COMPANY     // شركة إعادة تدوير
  REPAIR_TECHNICIAN     // فني إصلاح
  FACTORY               // مصنع
  EXPORT_COMPANY        // شركة تصدير
}

// حالة تسجيل التاجر
enum ScrapDealerStatus {
  PENDING   // قيد المراجعة
  APPROVED  // موافق عليه
  REJECTED  // مرفوض
  SUSPENDED // موقوف
}

// ============================================
// العقارات - Real Estate Enums
// ============================================

// نوع العقار
enum PropertyType {
  APARTMENT           // شقة
  VILLA               // فيلا
  DUPLEX              // دوبلكس
  PENTHOUSE           // بنتهاوس
  STUDIO              // ستوديو
  CHALET              // شاليه
  TOWNHOUSE           // تاون هاوس
  LAND                // أرض
  COMMERCIAL_SHOP     // محل تجاري
  OFFICE              // مكتب
  WAREHOUSE           // مخزن
  BUILDING            // مبنى كامل
  FARM                // مزرعة
}

// تشطيب العقار
enum PropertyFinishing {
  NOT_FINISHED        // بدون تشطيب
  SEMI_FINISHED       // نصف تشطيب
  FULLY_FINISHED      // تشطيب كامل
  SUPER_LUX           // سوبر لوكس
  ULTRA_SUPER_LUX     // الترا سوبر لوكس
  FURNISHED           // مفروش
}

// إطلالة العقار
enum PropertyView {
  STREET              // شارع
  GARDEN              // حديقة
  SEA                 // بحر
  NILE                // نيل
  POOL                // حمام سباحة
  CITY                // مدينة
  DESERT              // صحراء
  CORNER              // ناصية
  MAIN_ROAD           // طريق رئيسي
  NO_VIEW             // بدون إطلالة
}

// نوع الإعلان العقاري
enum PropertyListingType {
  FOR_SALE            // للبيع
  FOR_RENT            // للإيجار
  FOR_EXCHANGE        // للمقايضة
}

// ============================================
// السيارات والمركبات - Vehicle Enums
// ============================================

// نوع الوقود
enum FuelType {
  PETROL              // بنزين
  DIESEL              // ديزل
  ELECTRIC            // كهرباء
  HYBRID              // هايبرد
  NATURAL_GAS         // غاز طبيعي
  LPG                 // غاز بترولي مسال
}

// نوع ناقل الحركة
enum TransmissionType {
  AUTOMATIC           // أوتوماتيك
  MANUAL              // مانيوال
  CVT                 // CVT
  SEMI_AUTOMATIC      // نصف أوتوماتيك
}

// حالة السيارة
enum VehicleCondition {
  NEW                 // جديدة (زيرو)
  USED                // مستعملة
  ACCIDENT_FREE       // بدون حوادث
  MINOR_ACCIDENT      // حادث بسيط
  MAJOR_ACCIDENT      // حادث كبير
}

// نوع الهيكل
enum BodyType {
  SEDAN               // سيدان
  HATCHBACK           // هاتشباك
  SUV                 // SUV
  CROSSOVER           // كروس أوفر
  COUPE               // كوبيه
  CONVERTIBLE         // كشف
  PICKUP              // بيك أب
  VAN                 // فان
  MINIVAN             // ميني فان
  WAGON               // ستيشن واجن
  TRUCK               // شاحنة
  BUS                 // أتوبيس
  MOTORCYCLE          // موتوسيكل
}

// ============================================
// شارات التحقق - Verification Badge Types
// ============================================

enum BadgeType {
  PHONE_VERIFIED      // رقم الهاتف موثق
  EMAIL_VERIFIED      // البريد الإلكتروني موثق
  ID_VERIFIED         // الهوية موثقة
  ADDRESS_VERIFIED    // العنوان موثق
  BUSINESS_VERIFIED   // النشاط التجاري موثق
  TRUSTED_SELLER      // بائع موثوق (10+ معاملات)
  TOP_RATED           // الأعلى تقييماً
  FAST_RESPONDER      // سريع الرد
  PREMIUM_MEMBER      // عضو مميز
}

// ============================================
// خدمات التوصيل - Delivery Enums
// ============================================

enum DeliveryProvider {
  SELF_DELIVERY       // توصيل ذاتي
  OPEX                // OPEX
  BOSTA               // بوسطة
  ARAMEX              // أرامكس
  FEDEX               // فيدكس
  DHL                 // DHL
  OTHER               // أخرى
}

enum DeliverySpeed {
  SAME_DAY            // نفس اليوم
  NEXT_DAY            // اليوم التالي
  TWO_TO_THREE_DAYS   // 2-3 أيام
  WEEK                // أسبوع
  PICKUP              // استلام من الموقع
}

// ============================================
// التقسيط - Installment Enums
// ============================================

enum InstallmentProvider {
  VALU                // فاليو
  CONTACT             // كونتكت
  SOUHOOLA            // سهولة
  PREMIUM             // بريميوم
  BANK_INSTALLMENT    // تقسيط بنكي
}

enum InstallmentStatus {
  PENDING             // قيد الانتظار
  APPROVED            // موافق عليه
  REJECTED            // مرفوض
  ACTIVE              // نشط
  COMPLETED           // مكتمل
  DEFAULTED           // متعثر
}

model Item {
  id              String        @id @default(uuid())
  sellerId        String        @map("seller_id")
  title           String
  description     String
  categoryId      String?       @map("category_id")

  // Item type classification
  itemType        ItemType      @default(GOOD) @map("item_type")

  // Listing type - determines if this is SUPPLY or DEMAND
  // SUPPLY: DIRECT_SALE, AUCTION, BARTER
  // DEMAND: DIRECT_BUY, REVERSE_AUCTION
  listingType     ListingType   @default(DIRECT_SALE) @map("listing_type")

  condition       ItemCondition @default(GOOD)
  estimatedValue  Float         @map("estimated_value") // In EGP
  images          String[]      // Array of image URLs

  // Type-specific fields
  cashAmount      Float?        @map("cash_amount")     // For CASH type
  serviceHours    Float?        @map("service_hours")   // For SERVICE type
  serviceDuration String?       @map("service_duration") // e.g., "1 day", "2 weeks"

  // Market Type
  marketType      MarketType    @default(DISTRICT) @map("market_type")

  // Location (Hierarchical)
  governorate     String?       // المحافظة
  city            String?       // المدينة
  district        String?       // الحي
  location        String?       // العنوان التفصيلي
  latitude        Float?
  longitude       Float?

  // ============================================
  // سوق التوالف - Scrap Marketplace Fields
  // ============================================
  isScrap             Boolean           @default(false) @map("is_scrap")
  scrapType           ScrapType?        @map("scrap_type")
  scrapCondition      ScrapCondition?   @map("scrap_condition")
  scrapPricingType    ScrapPricingType? @map("scrap_pricing_type")

  // للمعادن والوزن
  weightKg            Float?            @map("weight_kg")
  pricePerKg          Float?            @map("price_per_kg")
  metalType           MetalType?        @map("metal_type")
  metalPurity         Float?            @map("metal_purity")  // نسبة نقاء المعدن

  // قابلية الإصلاح
  isRepairable        Boolean?          @map("is_repairable")
  repairCostEstimate  Float?            @map("repair_cost_estimate")
  workingPartsDesc    String?           @map("working_parts_desc")
  defectDescription   String?           @map("defect_description")

  // ============================================
  // العقارات - Real Estate Fields
  // ============================================
  propertyType        PropertyType?     @map("property_type")
  propertyFinishing   PropertyFinishing? @map("property_finishing")
  propertyView        PropertyView?     @map("property_view")
  propertyListingType PropertyListingType? @map("property_listing_type")
  areaInSqm           Float?            @map("area_in_sqm")           // المساحة بالمتر المربع
  bedrooms            Int?              @map("bedrooms")              // عدد غرف النوم
  bathrooms           Int?              @map("bathrooms")             // عدد الحمامات
  floorNumber         Int?              @map("floor_number")          // رقم الطابق
  totalFloors         Int?              @map("total_floors")          // إجمالي الطوابق
  buildYear           Int?              @map("build_year")            // سنة البناء
  hasElevator         Boolean?          @map("has_elevator")          // يوجد مصعد
  hasParking          Boolean?          @map("has_parking")           // يوجد جراج
  hasGarden           Boolean?          @map("has_garden")            // يوجد حديقة
  hasSecurity         Boolean?          @map("has_security")          // يوجد أمن
  hasPool             Boolean?          @map("has_pool")              // يوجد حمام سباحة
  rentPrice           Float?            @map("rent_price")            // سعر الإيجار الشهري
  isNegotiable        Boolean?          @map("is_negotiable")         // قابل للتفاوض

  // ============================================
  // السيارات والمركبات - Vehicle Fields
  // ============================================
  vehicleBrand        String?           @map("vehicle_brand")         // الماركة (e.g., Toyota, BMW)
  vehicleModel        String?           @map("vehicle_model")         // الموديل (e.g., Camry, X5)
  vehicleYear         Int?              @map("vehicle_year")          // سنة الصنع
  vehicleKilometers   Int?              @map("vehicle_kilometers")    // عدد الكيلومترات
  fuelType            FuelType?         @map("fuel_type")
  transmissionType    TransmissionType? @map("transmission_type")
  vehicleConditionType VehicleCondition? @map("vehicle_condition_type")
  bodyType            BodyType?         @map("body_type")
  engineCapacity      Float?            @map("engine_capacity")       // سعة المحرك (cc)
  vehicleColor        String?           @map("vehicle_color")         // اللون
  licensePlate        String?           @map("license_plate")         // رقم اللوحة
  hasWarranty         Boolean?          @map("has_warranty")          // يوجد ضمان
  warrantyMonths      Int?              @map("warranty_months")       // مدة الضمان بالأشهر

  // ============================================
  // خيارات التوصيل والتقسيط
  // ============================================
  deliveryAvailable   Boolean           @default(false) @map("delivery_available")
  deliveryProvider    DeliveryProvider? @map("delivery_provider")
  deliverySpeed       DeliverySpeed?    @map("delivery_speed")
  deliveryCost        Float?            @map("delivery_cost")
  freeDelivery        Boolean           @default(false) @map("free_delivery")

  installmentAvailable Boolean          @default(false) @map("installment_available")
  installmentProvider InstallmentProvider? @map("installment_provider")
  installmentMonths   Int[]             @map("installment_months")    // e.g., [6, 12, 18, 24]
  minDownPayment      Float?            @map("min_down_payment")      // الحد الأدنى للمقدم

  // Specs (flexible JSON)
  specifications  Json?         @map("specifications")

  // Barter Preferences: What does the seller want in exchange?
  desiredCategoryId     String?   @map("desired_category_id")
  desiredItemTitle      String?   @map("desired_item_title")       // Title of the wanted item (e.g., "سيارة سيدان")
  desiredItemDescription String?  @map("desired_item_description") // Description of the wanted item
  desiredKeywords       String?   @map("desired_keywords") // Comma-separated keywords
  desiredValueMin       Float?    @map("desired_value_min") // Minimum acceptable value
  desiredValueMax       Float?    @map("desired_value_max") // Maximum acceptable value

  // Status
  status          ItemStatus    @default(ACTIVE)
  views           Int           @default(0)

  // ============================================
  // Inventory/Stock Management (for merchants)
  // ============================================
  stockQuantity       Int           @default(0) @map("stock_quantity")      // Current stock quantity (can be negative)
  reservedQuantity    Int           @default(0) @map("reserved_quantity")   // Quantity reserved in pending orders
  allowNegativeStock  Boolean       @default(true) @map("allow_negative_stock")  // Allow selling when stock is negative
  lowStockThreshold   Int?          @map("low_stock_threshold")             // Alert when stock falls below this
  trackInventory      Boolean       @default(true) @map("track_inventory")  // Enable/disable inventory tracking
  sku                 String?       @map("sku")                             // Stock Keeping Unit (for merchants)
  barcode             String?       @map("barcode")                         // Barcode/EAN

  // Featured/Promotion fields
  isFeatured          Boolean       @default(false) @map("is_featured")
  promotionTier       PromotionTier @default(BASIC) @map("promotion_tier")
  promotedAt          DateTime?     @map("promoted_at")
  promotionExpiresAt  DateTime?     @map("promotion_expires_at")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  seller                  User                    @relation("UserItems", fields: [sellerId], references: [id], onDelete: Cascade)
  category                Category?               @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  desiredCategory         Category?               @relation("ItemDesiredCategory", fields: [desiredCategoryId], references: [id])
  listings                Listing[]
  barterPreferenceItems   BarterPreferenceItem[]  @relation("BarterPreferenceItems")
  participantsGiving      BarterParticipant[]     @relation("ParticipantGivingItem")
  participantsReceiving   BarterParticipant[]     @relation("ParticipantReceivingItem")
  reverseAuctionBids      ReverseAuctionBid[]     @relation("ReverseAuctionBidItem")
  inventoryLocks          InventoryLock[]         @relation("InventoryLocks")
  scrapSellerOffers       ScrapSellerOffer[]      @relation("ScrapOfferItem")
  stockAdjustments        StockAdjustment[]       @relation("ItemStockAdjustments")

  @@map("items")
  @@index([sellerId])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([desiredCategoryId])
  @@index([itemType])
  @@index([marketType])
  @@index([governorate])
  @@index([marketType, governorate])
  @@index([marketType, status])
  @@index([isFeatured])
  @@index([promotionTier])
  @@index([isFeatured, status])
  @@index([promotionExpiresAt])
  @@index([listingType])
  @@index([listingType, status])
  @@index([listingType, categoryId])
  @@index([isScrap])
  @@index([scrapType])
  @@index([metalType])
  @@index([isScrap, scrapType])
  @@index([isScrap, status])
  @@index([sku])
  @@index([barcode])
  @@index([stockQuantity])
  @@index([trackInventory])
  // Real Estate indexes
  @@index([propertyType])
  @@index([propertyFinishing])
  @@index([areaInSqm])
  @@index([bedrooms])
  @@index([bathrooms])
  // Vehicle indexes
  @@index([vehicleBrand])
  @@index([vehicleYear])
  @@index([fuelType])
  @@index([transmissionType])
  @@index([bodyType])
  @@index([vehicleKilometers])
  // Delivery & Installment indexes
  @@index([deliveryAvailable])
  @@index([installmentAvailable])
}

// ============================================
// Stock Adjustment - Inventory Change Tracking
// ============================================
enum StockAdjustmentType {
  SALE              // Stock decreased due to sale
  PURCHASE          // Stock increased due to purchase/restock
  MANUAL_ADD        // Manual stock addition
  MANUAL_SUBTRACT   // Manual stock subtraction
  RETURN            // Stock returned from customer
  DAMAGE            // Stock lost due to damage
  TRANSFER_IN       // Stock transferred in from another location
  TRANSFER_OUT      // Stock transferred out to another location
  INITIAL           // Initial stock count
  CORRECTION        // Stock correction/reconciliation
}

model StockAdjustment {
  id              String              @id @default(uuid())
  itemId          String              @map("item_id")
  userId          String              @map("user_id")         // User who made the adjustment

  // Adjustment details
  type            StockAdjustmentType
  quantityBefore  Int                 @map("quantity_before")
  quantityChange  Int                 @map("quantity_change") // Positive for add, negative for subtract
  quantityAfter   Int                 @map("quantity_after")

  // Reference to related entity
  referenceType   String?             @map("reference_type")  // "ORDER", "RETURN", "TRANSFER", etc.
  referenceId     String?             @map("reference_id")    // ID of the related order/return/etc.

  // Notes
  reason          String?                                     // Reason for manual adjustment
  notes           String?                                     // Additional notes

  // Cost tracking (optional)
  unitCost        Float?              @map("unit_cost")       // Cost per unit at time of adjustment
  totalCost       Float?              @map("total_cost")      // Total cost of this adjustment

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")

  // Relations
  item            Item                @relation("ItemStockAdjustments", fields: [itemId], references: [id], onDelete: Cascade)

  @@map("stock_adjustments")
  @@index([itemId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

// ============================================
// Trading Listings
// ============================================

enum ListingType {
  DIRECT_SALE
  AUCTION
  REVERSE_AUCTION
  BARTER
  DIRECT_BUY        // طلب شراء مباشر (DEMAND)
}

enum ListingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

model Listing {
  id          String          @id @default(uuid())
  itemId      String          @map("item_id")
  userId      String          @map("user_id")
  listingType ListingType     @map("listing_type")

  // Pricing (nullable for barter)
  price       Float?
  currency    String          @default("EGP")

  // Auction specific
  startingBid Float?          @map("starting_bid")
  currentBid  Float?          @map("current_bid")
  bidIncrement Float?         @map("bid_increment")
  reservePrice Float?         @map("reserve_price")

  // Timing
  startDate   DateTime        @default(now()) @map("start_date")
  endDate     DateTime?       @map("end_date")

  // Status
  status      ListingStatus   @default(ACTIVE)
  views       Int             @default(0)

  // Timestamps
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  item        Item            @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user        User            @relation("UserListings", fields: [userId], references: [id], onDelete: Cascade)
  auction     Auction?
  auctionBids  AuctionBid[]
  transactions Transaction[]
  cartItems   CartItem[]
  orderItems  OrderItem[]
  flashDeals  FlashDeal[]
  installmentPlans InstallmentPlan[]
  groupBuys   GroupBuy[]

  @@map("listings")
  @@index([itemId])
  @@index([userId])
  @@index([listingType])
  @@index([status])
  @@index([endDate])
}

// ============================================
// Shopping Cart
// ============================================

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique @map("user_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String   @map("cart_id")
  listingId String   @map("listing_id")
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([cartId, listingId])
  @@map("cart_items")
}

// ============================================
// Shipping & Orders
// ============================================

model ShippingAddress {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  fullName        String   @map("full_name")
  phone           String
  address         String?  // Legacy combined address field
  street          String?  // الشارع
  buildingName    String?  @map("building_name")   // اسم المبنى
  buildingNumber  String?  @map("building_number") // رقم المبنى
  floor           String?  // الدور
  apartmentNumber String?  @map("apartment_number") // رقم الشقة
  landmark        String?  // علامة مميزة
  city            String
  governorate     String
  postalCode      String?  @map("postal_code")
  isDefault       Boolean  @default(false) @map("is_default")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@map("shipping_addresses")
  @@index([userId])
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model Order {
  id                String        @id @default(uuid())
  userId            String        @map("user_id")
  orderNumber       String        @unique @map("order_number")
  status            OrderStatus   @default(PENDING)
  subtotal          Float
  shippingCost      Float         @map("shipping_cost")
  total             Float
  shippingAddressId String        @map("shipping_address_id")
  paymentMethod     String        @map("payment_method")
  paymentId         String?       @map("payment_id")
  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  paidAt            DateTime?     @map("paid_at")
  shippedAt         DateTime?     @map("shipped_at")
  deliveredAt       DateTime?     @map("delivered_at")

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingAddress   ShippingAddress @relation(fields: [shippingAddressId], references: [id], onDelete: Restrict)
  items             OrderItem[]

  @@map("orders")
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  listingId   String   @map("listing_id")
  sellerId    String   @map("seller_id")
  quantity    Int
  price       Float

  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  listing     Listing  @relation(fields: [listingId], references: [id], onDelete: Restrict)

  @@map("order_items")
  @@index([orderId])
  @@index([sellerId])
}

// ============================================
// Push Subscriptions
// ============================================

model PushSubscription {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  endpoint     String   @unique
  p256dh       String
  auth         String
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
  @@index([userId])
}

// ============================================
// Barter System - Advanced Multi-Party Support with Bundles & Preferences
// ============================================

enum BarterOfferStatus {
  PENDING
  COUNTER_OFFERED    // For counter offers
  ACCEPTED
  REJECTED
  EXPIRED            // For expired offers
  COMPLETED
  CANCELLED
}

// Advanced 2-party barter offer with bundles and preferences
model BarterOffer {
  id                String             @id @default(uuid())

  // Parties involved
  initiatorId       String             @map("initiator_id")
  recipientId       String?            @map("recipient_id")  // Nullable for open offers

  // Offered items (BUNDLE SUPPORT - can be multiple items)
  offeredItemIds    String[]           @map("offered_item_ids")
  offeredBundleValue Float             @map("offered_bundle_value")  // Auto-calculated

  // Preference sets (alternative bundles user wants)
  // User can specify multiple preference sets with priorities
  preferenceSets    BarterPreferenceSet[]

  // Matched preference (when offer is accepted)
  matchedPreferenceSetId String?       @map("matched_preference_set_id")

  // Cash support
  offeredCashAmount   Float              @default(0) @map("offered_cash_amount")
  requestedCashAmount Float              @default(0) @map("requested_cash_amount")

  // Additional info
  notes             String?
  expiresAt         DateTime?          @map("expires_at")
  isOpenOffer       Boolean            @default(false) @map("is_open_offer")  // Open to anyone

  // Link to supply item (for barter - links demand to the supply item)
  linkedItemId      String?            @map("linked_item_id")

  // Market Type & Location (for Demand items)
  marketType        MarketType         @default(DISTRICT) @map("market_type")
  governorate       String?            // المحافظة
  city              String?            // المدينة
  district          String?            // الحي

  // Status
  status            BarterOfferStatus  @default(PENDING)

  // Timestamps
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  respondedAt       DateTime?          @map("responded_at")

  // Relations
  initiator         User               @relation("BarterInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  recipient         User?              @relation("BarterRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  itemRequests      ItemRequest[]

  @@map("barter_offers")
  @@index([initiatorId])
  @@index([recipientId])
  @@index([status])
  @@index([expiresAt])
  @@index([isOpenOffer])
  @@index([marketType])
  @@index([governorate])
  @@index([marketType, isOpenOffer])
  @@index([linkedItemId])
}

// Abstract item request for barter (when user doesn't want specific items)
model ItemRequest {
  id                String         @id @default(uuid())
  barterOfferId     String         @map("barter_offer_id")
  description       String
  categoryId        String?        @map("category_id")          // Level 1: Root category
  subcategoryId     String?        @map("subcategory_id")       // Level 2: Sub-category
  subSubcategoryId  String?        @map("sub_subcategory_id")   // Level 3: Sub-sub-category
  minPrice          Float?         @map("min_price")
  maxPrice          Float?         @map("max_price")
  condition         ItemCondition?
  keywords          String[]
  createdAt         DateTime       @default(now()) @map("created_at")

  barterOffer       BarterOffer    @relation(fields: [barterOfferId], references: [id], onDelete: Cascade)
  category          Category?      @relation(fields: [categoryId], references: [id])

  @@map("item_requests")
  @@index([barterOfferId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([subSubcategoryId])
}

// Preference set - represents one alternative bundle the user wants
// User can have multiple preference sets ranked by priority
model BarterPreferenceSet {
  id                String             @id @default(uuid())
  barterOfferId     String             @map("barter_offer_id")

  // Priority (1 = highest, 2 = second, etc.)
  priority          Int

  // Items in this preference set (can be multiple)
  items             BarterPreferenceItem[]

  // Auto-calculated total value
  totalValue        Float              @map("total_value")

  // Value difference from offered bundle
  valueDifference   Float              @map("value_difference")

  // Is this preference set balanced? (within acceptable range)
  isBalanced        Boolean            @default(true) @map("is_balanced")

  // Description
  description       String?            // e.g., "MacBook Air" or "iPad Pro + Apple Pencil"

  // Timestamps
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relations
  barterOffer       BarterOffer        @relation(fields: [barterOfferId], references: [id], onDelete: Cascade)

  @@map("barter_preference_sets")
  @@unique([barterOfferId, priority])
  @@index([barterOfferId])
  @@index([priority])
}

// Individual item in a preference set
model BarterPreferenceItem {
  id                String             @id @default(uuid())
  preferenceSetId   String             @map("preference_set_id")
  itemId            String             @map("item_id")

  // Item details (denormalized for performance)
  itemValue         Float              @map("item_value")

  // Timestamps
  createdAt         DateTime           @default(now()) @map("created_at")

  // Relations
  preferenceSet     BarterPreferenceSet @relation(fields: [preferenceSetId], references: [id], onDelete: Cascade)
  item              Item               @relation("BarterPreferenceItems", fields: [itemId], references: [id], onDelete: Cascade)

  @@map("barter_preference_items")
  @@unique([preferenceSetId, itemId])  // Can't have duplicate items in same set
  @@index([preferenceSetId])
  @@index([itemId])
}

// Multi-party barter chain (3+ users) - SMART BARTER
enum BarterChainStatus {
  PROPOSED        // Algorithm proposed this chain
  PENDING         // Waiting for all parties to accept
  ACCEPTED        // All parties accepted
  REJECTED        // One or more rejected
  COMPLETED       // Exchange completed
  EXPIRED         // Offer expired
  CANCELLED       // Cancelled by initiator
}

model BarterChain {
  id              String             @id @default(uuid())

  // Chain metadata
  chainType       String             @map("chain_type") // "CYCLE" or "CHAIN"
  participantCount Int               @map("participant_count")

  // Matching info
  matchScore      Float              @map("match_score")
  algorithmVersion String            @default("1.0") @map("algorithm_version")

  // Description
  description     String?            // Human-readable description of the chain

  // Commission tracking
  commissionAmount   Float?          @map("commission_amount")    // Platform commission in EGP
  commissionRate     Float?          @map("commission_rate")      // Commission rate (e.g., 0.05 for 5%)
  commissionStatus   String?         @map("commission_status")    // PENDING, COLLECTED, WAIVED
  commissionPaidAt   DateTime?       @map("commission_paid_at")   // When commission was paid
  commissionPaidBy   String?         @map("commission_paid_by")   // User ID who paid commission

  // Cash flow tracking
  involvesCash    Boolean            @default(false) @map("involves_cash") // Does this chain involve cash?
  totalCashFlow   Float              @default(0) @map("total_cash_flow")   // Total cash in chain

  // Status
  status          BarterChainStatus  @default(PROPOSED)

  // Expiry
  expiresAt       DateTime           @map("expires_at")

  // Timestamps
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  completedAt     DateTime?          @map("completed_at")

  // Relations
  participants    BarterParticipant[]
  cashFlows       CashFlow[]

  @@map("barter_chains")
  @@index([status])
  @@index([chainType])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([commissionStatus])
  @@index([involvesCash])
}

// Individual participant in a barter chain
enum ParticipantStatus {
  PENDING       // Hasn't responded yet
  ACCEPTED      // Accepted the proposal
  REJECTED      // Rejected the proposal
  COMPLETED     // Completed their part
}

model BarterParticipant {
  id              String             @id @default(uuid())
  chainId         String             @map("chain_id")

  // User and items
  userId          String             @map("user_id")
  givingItemId    String             @map("giving_item_id")
  receivingItemId String             @map("receiving_item_id")

  // Position in chain (0, 1, 2, ...)
  position        Int

  // Status
  status          ParticipantStatus  @default(PENDING)

  // Response
  responseMessage String?            @map("response_message")
  respondedAt     DateTime?          @map("responded_at")

  // Counter-proposal support
  hasCounterProposal     Boolean    @default(false) @map("has_counter_proposal")
  counterProposalItemId  String?    @map("counter_proposal_item_id")  // Alternative item to give
  counterProposalMessage String?    @map("counter_proposal_message")  // Reason for counter
  counterProposalCash    Float?     @map("counter_proposal_cash")     // Cash adjustment
  counterProposalStatus  String?    @map("counter_proposal_status")   // PENDING, ACCEPTED, REJECTED

  // Timestamps
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  chain           BarterChain        @relation(fields: [chainId], references: [id], onDelete: Cascade)
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  givingItem      Item               @relation("ParticipantGivingItem", fields: [givingItemId], references: [id], onDelete: Cascade)
  receivingItem   Item               @relation("ParticipantReceivingItem", fields: [receivingItemId], references: [id], onDelete: Cascade)

  @@map("barter_participants")
  @@unique([chainId, userId])
  @@index([chainId])
  @@index([userId])
  @@index([status])
  @@index([hasCounterProposal])
  @@index([counterProposalStatus])
}

// ============================================
// Inventory Lock System - Prevents Race Conditions
// ============================================

enum LockType {
  SOFT       // Advisory lock, can be overridden
  HARD       // Strict lock, cannot be overridden
  RESERVED   // Item reserved for specific chain
}

enum LockStatus {
  ACTIVE     // Lock is currently active
  RELEASED   // Lock has been released
  EXPIRED    // Lock expired automatically
}

model InventoryLock {
  id              String      @id @default(uuid())
  itemId          String      @map("item_id")
  userId          String      @map("user_id")

  // Lock details
  lockType        LockType    @default(SOFT) @map("lock_type")
  lockStatus      LockStatus  @default(ACTIVE) @map("lock_status")

  // Related chain (if locked for a barter chain)
  lockedByChainId String?     @map("locked_by_chain_id")
  lockedByOfferId String?     @map("locked_by_offer_id")

  // Expiration
  lockedAt        DateTime    @default(now()) @map("locked_at")
  expiresAt       DateTime    @map("expires_at")
  autoRelease     Boolean     @default(true) @map("auto_release")

  // Release tracking
  releasedAt      DateTime?   @map("released_at")
  releasedBy      String?     @map("released_by")  // User ID who released
  releaseReason   String?     @map("release_reason")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  item            Item        @relation("InventoryLocks", fields: [itemId], references: [id], onDelete: Cascade)

  @@map("inventory_locks")
  @@index([itemId])
  @@index([userId])
  @@index([lockStatus])
  @@index([expiresAt])
  @@index([lockedByChainId])
  @@index([lockedByOfferId])
}

// ============================================
// Cash Flow Tracking - For Barter Chains with Cash
// ============================================

enum CashFlowStatus {
  PENDING       // Payment pending
  COMPLETED     // Payment completed
  FAILED        // Payment failed
  REFUNDED      // Payment refunded
  CANCELLED     // Transaction cancelled
}

enum CashFlowType {
  CHAIN_BALANCE    // Cash to balance unequal trades
  COMMISSION       // Platform commission
  SHIPPING_FEE     // Shipping/delivery fee
  ADJUSTMENT       // Manual adjustment
}

model CashFlow {
  id              String          @id @default(uuid())
  chainId         String?         @map("chain_id")

  // Parties
  fromUserId      String          @map("from_user_id")
  toUserId        String          @map("to_user_id")

  // Amount
  amount          Float
  currency        String          @default("EGP")
  flowType        CashFlowType    @default(CHAIN_BALANCE) @map("flow_type")

  // Payment details
  paymentStatus   CashFlowStatus  @default(PENDING) @map("payment_status")
  paymentMethod   String?         @map("payment_method")  // "CASH", "ONLINE", "BANK_TRANSFER"
  paymentReference String?        @map("payment_reference") // Transaction reference

  // Description
  description     String?
  notes           String?

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  completedAt     DateTime?       @map("completed_at")
  refundedAt      DateTime?       @map("refunded_at")

  // Relations
  chain           BarterChain?    @relation(fields: [chainId], references: [id], onDelete: Cascade)

  @@map("cash_flows")
  @@index([chainId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([paymentStatus])
  @@index([flowType])
  @@index([createdAt])
}

// ============================================
// Auction System
// ============================================

enum AuctionStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
  COMPLETED
}

enum BidStatus {
  ACTIVE
  OUTBID
  WINNING
  WON
  LOST
  CANCELLED
}

model Auction {
  id                String        @id @default(uuid())
  listingId         String        @unique @map("listing_id")

  // Pricing
  startingPrice     Float         @map("starting_price")
  currentPrice      Float         @map("current_price")
  buyNowPrice       Float?        @map("buy_now_price")
  reservePrice      Float?        @map("reserve_price")
  minBidIncrement   Float         @default(1.0) @map("min_bid_increment")

  // Timing
  startTime         DateTime      @map("start_time")
  endTime           DateTime      @map("end_time")
  actualEndTime     DateTime?     @map("actual_end_time")

  // Auto-extension settings
  autoExtend        Boolean       @default(true) @map("auto_extend")
  extensionMinutes  Int           @default(5) @map("extension_minutes")
  extensionThreshold Int          @default(5) @map("extension_threshold") // Minutes before end
  timesExtended     Int           @default(0) @map("times_extended")
  maxExtensions     Int           @default(3) @map("max_extensions")

  // Status and stats
  status            AuctionStatus @default(DRAFT)
  totalBids         Int           @default(0) @map("total_bids")
  uniqueBidders     Int           @default(0) @map("unique_bidders")
  views             Int           @default(0)

  // Winner
  winnerId          String?       @map("winner_id")
  winningBidId      String?       @unique @map("winning_bid_id")

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  listing           Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  bids              AuctionBid[]
  winningBid        AuctionBid?   @relation("WinningBid", fields: [winningBidId], references: [id])

  @@map("auctions")
  @@index([status])
  @@index([startTime])
  @@index([endTime])
  @@index([winnerId])
}

model AuctionBid {
  id              String     @id @default(uuid())
  auctionId       String     @map("auction_id")
  listingId       String     @map("listing_id")
  bidderId        String     @map("bidder_id")

  // Bid details
  bidAmount       Float      @map("bid_amount")
  previousBid     Float?     @map("previous_bid") // Previous bid by this user

  // Auto-bid (proxy bidding)
  isAutoBid       Boolean    @default(false) @map("is_auto_bid")
  maxAutoBid      Float?     @map("max_auto_bid") // Maximum they're willing to bid

  // Status
  status          BidStatus  @default(ACTIVE)

  // Metadata
  ipAddress       String?    @map("ip_address")
  userAgent       String?    @map("user_agent")

  // Timestamps
  createdAt       DateTime   @default(now()) @map("created_at")

  // Relations
  auction         Auction    @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  listing         Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  bidder          User       @relation(fields: [bidderId], references: [id], onDelete: Cascade)
  wonAuction      Auction?   @relation("WinningBid")

  @@map("auction_bids")
  @@index([auctionId])
  @@index([listingId])
  @@index([bidderId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Reverse Auction System - Complete Professional Implementation
// ============================================
// Reverse auctions: Buyer requests item → Sellers compete by bidding DOWN
// Winner = lowest price (or best value if considering other factors)

enum ReverseAuctionStatus {
  DRAFT           // Being created, not published yet
  ACTIVE          // Published and accepting bids
  ENDED           // Auction time expired
  AWARDED         // Winner selected by buyer
  COMPLETED       // Transaction completed
  CANCELLED       // Cancelled by buyer
  EXPIRED         // Ended without any bids
}

enum ReverseAuctionBidStatus {
  ACTIVE          // Currently valid bid
  OUTBID          // Another seller bid lower
  WINNING         // Currently the lowest bid
  WON             // Selected as winner
  LOST            // Not selected as winner
  WITHDRAWN       // Seller withdrew their bid
  REJECTED        // Buyer rejected this bid
}

// Main reverse auction - Buyer's request for an item
model ReverseAuction {
  id                String              @id @default(uuid())
  buyerId           String              @map("buyer_id")

  // Item Request Details
  title             String              // e.g., "iPhone 14 Pro Max 256GB"
  description       String              // Detailed requirements
  categoryId        String              @map("category_id")

  // Item specifications
  condition         ItemCondition       // Required condition (NEW, LIKE_NEW, etc.)
  specifications    Json?               // Flexible specs (color, model, etc.)
  quantity          Int                 @default(1)

  // Location preferences
  location          String?             // Preferred location
  deliveryPreference String?           @map("delivery_preference") // "PICKUP", "DELIVERY", "BOTH"

  // Budget & Pricing
  maxBudget         Float?              @map("max_budget")    // Maximum willing to pay (optional)
  targetPrice       Float?              @map("target_price")  // Target/desired price (optional)

  // Timing
  startDate         DateTime            @default(now()) @map("start_date")
  endDate           DateTime            @map("end_date")      // Bidding deadline

  // Status & Stats
  status            ReverseAuctionStatus @default(DRAFT)
  totalBids         Int                 @default(0) @map("total_bids")
  uniqueBidders     Int                 @default(0) @map("unique_bidders")
  lowestBid         Float?              @map("lowest_bid")    // Current lowest bid
  views             Int                 @default(0)

  // Winner
  winnerId          String?             @map("winner_id")
  winningBidId      String?             @unique @map("winning_bid_id")

  // Notes
  buyerNotes        String?             @map("buyer_notes")   // Private notes
  publicNotes       String?             @map("public_notes")  // Visible to sellers

  // Timestamps
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  awardedAt         DateTime?           @map("awarded_at")
  completedAt       DateTime?           @map("completed_at")

  // Relations
  buyer             User                @relation("ReverseAuctionBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  category          Category            @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  bids              ReverseAuctionBid[]
  winningBid        ReverseAuctionBid?  @relation("WinningBid", fields: [winningBidId], references: [id])

  @@map("reverse_auctions")
  @@index([buyerId])
  @@index([categoryId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([winnerId])
  @@index([lowestBid])
}

// Seller's bid on a reverse auction
model ReverseAuctionBid {
  id                String                  @id @default(uuid())
  reverseAuctionId  String                  @map("reverse_auction_id")
  sellerId          String                  @map("seller_id")

  // Bid details
  bidAmount         Float                   @map("bid_amount")      // Offered price
  previousBid       Float?                  @map("previous_bid")    // Their previous bid (if rebidding)

  // Item offered
  itemId            String?                 @map("item_id")         // If seller has existing item
  itemCondition     ItemCondition           @map("item_condition")  // Actual condition of item
  itemDescription   String?                 @map("item_description") // Description of item offered
  itemImages        String[]                @map("item_images")     // Images URLs

  // Delivery & Terms
  deliveryOption    String                  @map("delivery_option") // "PICKUP", "DELIVERY", "BOTH"
  deliveryDays      Int?                    @map("delivery_days")   // Estimated delivery time
  deliveryCost      Float                   @default(0) @map("delivery_cost") // Delivery fee

  // Seller notes
  notes             String?                 // Additional information

  // Status
  status            ReverseAuctionBidStatus @default(ACTIVE)

  // Metadata
  ipAddress         String?                 @map("ip_address")
  userAgent         String?                 @map("user_agent")

  // Timestamps
  createdAt         DateTime                @default(now()) @map("created_at")
  updatedAt         DateTime                @updatedAt @map("updated_at")

  // Relations
  reverseAuction    ReverseAuction          @relation(fields: [reverseAuctionId], references: [id], onDelete: Cascade)
  seller            User                    @relation("ReverseAuctionSeller", fields: [sellerId], references: [id], onDelete: Cascade)
  item              Item?                   @relation("ReverseAuctionBidItem", fields: [itemId], references: [id], onDelete: SetNull)
  wonAuction        ReverseAuction?         @relation("WinningBid")

  @@map("reverse_auction_bids")
  @@index([reverseAuctionId])
  @@index([sellerId])
  @@index([itemId])
  @@index([status])
  @@index([bidAmount])
  @@index([createdAt])
}

// ============================================
// Transactions
// ============================================

enum TransactionType {
  DIRECT_SALE
  AUCTION
  REVERSE_AUCTION
  BARTER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  PENDING
  SHIPPED
  DELIVERED
  RETURNED
}

model Transaction {
  id              String          @id @default(uuid())
  listingId       String          @map("listing_id")
  buyerId         String          @map("buyer_id")
  sellerId        String          @map("seller_id")
  transactionType TransactionType @map("transaction_type")

  // Payment
  amount          Float?
  currency        String          @default("EGP")
  paymentMethod   String?         @map("payment_method")
  paymentStatus   PaymentStatus   @default(PENDING) @map("payment_status")

  // Delivery
  deliveryStatus  DeliveryStatus  @default(PENDING) @map("delivery_status")
  trackingNumber  String?         @map("tracking_number")

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  completedAt     DateTime?       @map("completed_at")

  // Relations
  listing         Listing         @relation(fields: [listingId], references: [id], onDelete: Restrict)
  buyer           User            @relation("Buyer", fields: [buyerId], references: [id], onDelete: Restrict)
  seller          User            @relation("Seller", fields: [sellerId], references: [id], onDelete: Restrict)
  reviews         Review[]

  @@map("transactions")
  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([paymentStatus])
  @@index([deliveryStatus])
}

// ============================================
// Reviews & Ratings - Professional System
// ============================================

enum ReviewStatus {
  PENDING         // Awaiting moderation (optional)
  APPROVED        // Approved and visible
  REJECTED        // Rejected by moderator
  FLAGGED         // Flagged for review
  HIDDEN          // Hidden by admin
}

enum ReviewType {
  SELLER_REVIEW   // Review of seller/vendor
  BUYER_REVIEW    // Review of buyer
  ITEM_REVIEW     // Review of item/product
}

// Main review model
model Review {
  id              String        @id @default(uuid())
  transactionId   String        @map("transaction_id")
  reviewerId      String        @map("reviewer_id")
  reviewedId      String        @map("reviewed_id")
  reviewType      ReviewType    @default(SELLER_REVIEW) @map("review_type")

  // Ratings
  overallRating   Int           @map("overall_rating")      // 1-5 stars

  // Detailed ratings (optional, for sellers)
  itemAsDescribed Int?          @map("item_as_described")   // 1-5
  communication   Int?                                      // 1-5
  shippingSpeed   Int?          @map("shipping_speed")      // 1-5
  packaging       Int?                                      // 1-5

  // Review content
  title           String?                                    // Review title/headline
  comment         String?                                    // Review text
  images          String[]      @default([])                // Review images

  // Verification
  isVerifiedPurchase Boolean    @default(false) @map("is_verified_purchase")

  // Status
  status          ReviewStatus  @default(APPROVED)

  // Engagement
  helpfulCount    Int           @default(0) @map("helpful_count")
  notHelpfulCount Int           @default(0) @map("not_helpful_count")
  reportCount     Int           @default(0) @map("report_count")

  // Edit tracking
  isEdited        Boolean       @default(false) @map("is_edited")
  editedAt        DateTime?     @map("edited_at")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  transaction     Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  reviewer        User          @relation("Reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewed        User          @relation("Reviewed", fields: [reviewedId], references: [id], onDelete: Cascade)
  response        ReviewResponse?
  votes           ReviewVote[]
  reports         ReviewReport[]

  @@map("reviews")
  @@unique([transactionId, reviewerId]) // One review per transaction per reviewer
  @@index([transactionId])
  @@index([reviewerId])
  @@index([reviewedId])
  @@index([overallRating])
  @@index([status])
  @@index([isVerifiedPurchase])
  @@index([createdAt])
  @@index([helpfulCount])
}

// Seller/vendor response to reviews
model ReviewResponse {
  id              String      @id @default(uuid())
  reviewId        String      @unique @map("review_id")
  responderId     String      @map("responder_id")  // Usually the reviewed user

  // Response content
  message         String

  // Edit tracking
  isEdited        Boolean     @default(false) @map("is_edited")
  editedAt        DateTime?   @map("edited_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  review          Review      @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_responses")
  @@index([reviewId])
  @@index([responderId])
  @@index([createdAt])
}

// User votes on review helpfulness
model ReviewVote {
  id              String      @id @default(uuid())
  reviewId        String      @map("review_id")
  userId          String      @map("user_id")

  // Vote value
  isHelpful       Boolean     @map("is_helpful")  // true = helpful, false = not helpful

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  review          Review      @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_votes")
  @@unique([reviewId, userId])  // One vote per user per review
  @@index([reviewId])
  @@index([userId])
}

// Report inappropriate reviews
enum ReportReason {
  SPAM
  OFFENSIVE_LANGUAGE
  FAKE_REVIEW
  IRRELEVANT
  PERSONAL_INFORMATION
  OTHER
}

model ReviewReport {
  id              String        @id @default(uuid())
  reviewId        String        @map("review_id")
  reporterId      String        @map("reporter_id")

  // Report details
  reason          ReportReason
  description     String?                          // Additional context

  // Status
  isResolved      Boolean       @default(false) @map("is_resolved")
  resolvedAt      DateTime?     @map("resolved_at")
  resolvedBy      String?       @map("resolved_by")  // Admin user ID
  resolution      String?                          // Resolution notes

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  review          Review        @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_reports")
  @@unique([reviewId, reporterId])  // One report per user per review
  @@index([reviewId])
  @@index([reporterId])
  @@index([isResolved])
  @@index([createdAt])
}

// ============================================
// Wish List (for matching)
// ============================================

model WishListItem {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  categoryId  String?   @map("category_id")
  description String
  keywords    String[]  // For matching
  maxPrice    Float?    @map("max_price")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@map("wish_list_items")
  @@index([userId])
  @@index([categoryId])
}

// ============================================
// Notifications System
// ============================================

enum NotificationType {
  // Auction notifications
  AUCTION_NEW_BID              // Someone bid on your auction
  AUCTION_OUTBID               // You were outbid
  AUCTION_WINNING              // You're currently winning
  AUCTION_WON                  // You won the auction
  AUCTION_LOST                 // You lost the auction
  AUCTION_ENDING_SOON          // Auction ending in 1 hour
  AUCTION_ENDED                // Auction has ended

  // Reverse Auction notifications
  REVERSE_AUCTION_NEW_REQUEST  // New reverse auction request (for sellers)
  REVERSE_AUCTION_NEW_BID      // Someone bid on your request
  REVERSE_AUCTION_OUTBID       // Your bid was beaten
  REVERSE_AUCTION_WINNING      // Your bid is winning
  REVERSE_AUCTION_WON          // Your bid won
  REVERSE_AUCTION_AWARDED      // You were awarded
  REVERSE_AUCTION_ENDING_SOON  // Request ending soon

  // Barter notifications
  BARTER_OFFER_RECEIVED        // New barter offer
  BARTER_OFFER_ACCEPTED        // Your offer was accepted
  BARTER_OFFER_REJECTED        // Your offer was rejected
  BARTER_OFFER_COUNTERED       // Counter offer received
  BARTER_OFFER_EXPIRED         // Offer expired
  BARTER_MATCH                 // Automatic match found

  // Matching notifications
  PURCHASE_REQUEST_MATCH       // Buyer looking for your item
  SALE_TO_DEMAND               // Your item matches a demand
  DEMAND_TO_SUPPLY             // Supply matches your demand

  // Item notifications
  ITEM_SOLD                    // Your item sold
  ITEM_PRICE_DROP              // Wishlist item price dropped
  ITEM_AVAILABLE               // Wishlist item now available

  // Transaction notifications
  TRANSACTION_PAYMENT_RECEIVED // Payment received
  TRANSACTION_SHIPPED          // Item shipped
  TRANSACTION_DELIVERED        // Item delivered

  // Order notifications
  ORDER_RECEIVED               // New order received (for seller)
  ORDER_CONFIRMED              // Order confirmed (for buyer)
  ORDER_SHIPPED                // Order shipped (for buyer)
  ORDER_DELIVERED              // Order delivered
  ORDER_COMPLETED              // Order completed successfully
  ORDER_CANCELLED              // Order cancelled
  PAYMENT_RECEIVED             // Payment received by seller
  PAYMENT_CONFIRMED            // Payment confirmed for buyer

  // User notifications
  USER_WELCOME                 // Welcome email
  USER_EMAIL_VERIFICATION      // Verify email
  USER_PASSWORD_RESET          // Password reset
  USER_REVIEW_RECEIVED         // New review received

  // System notifications
  SYSTEM_MAINTENANCE           // Scheduled maintenance
  SYSTEM_ANNOUNCEMENT          // Important announcement

  // Inventory/Stock notifications
  LOW_STOCK                    // Stock fell below threshold
  NEGATIVE_STOCK               // Stock became negative
  STOCK_REPLENISHED            // Stock was replenished
}

enum NotificationChannel {
  IN_APP      // In-app notification
  EMAIL       // Email notification
  SMS         // SMS notification (future)
  PUSH        // Push notification (future)
}

enum NotificationPriority {
  LOW         // Can wait
  MEDIUM      // Normal priority
  HIGH        // Important
  URGENT      // Immediate attention
}

// In-app notifications
model Notification {
  id              String              @id @default(uuid())
  userId          String              @map("user_id")

  // Notification details
  type            NotificationType
  priority        NotificationPriority @default(MEDIUM)
  title           String
  message         String

  // Related entity (optional)
  entityType      String?             @map("entity_type")  // 'auction', 'item', 'barter', etc.
  entityId        String?             @map("entity_id")    // ID of related entity

  // Action link
  actionUrl       String?             @map("action_url")
  actionText      String?             @map("action_text")

  // Metadata (JSON for extra data)
  metadata        Json?

  // Status
  isRead          Boolean             @default(false) @map("is_read")
  readAt          DateTime?           @map("read_at")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  expiresAt       DateTime?           @map("expires_at")  // Auto-delete after this date

  // Relations
  user            User                @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([priority])
  @@index([createdAt])
  @@index([expiresAt])
}

// User notification preferences
model NotificationPreference {
  id              String              @id @default(uuid())
  userId          String              @unique @map("user_id")

  // Channel preferences
  emailEnabled    Boolean             @default(true) @map("email_enabled")
  smsEnabled      Boolean             @default(false) @map("sms_enabled")
  pushEnabled     Boolean             @default(true) @map("push_enabled")

  // Type preferences (JSON for flexibility)
  preferences     Json                @default("{}")  // { "AUCTION_NEW_BID": { "email": true, "inApp": true }, ... }

  // Quiet hours
  quietHoursStart Int?                @map("quiet_hours_start")  // Hour 0-23
  quietHoursEnd   Int?                @map("quiet_hours_end")    // Hour 0-23

  // Frequency settings
  emailDigest     Boolean             @default(false) @map("email_digest")  // Daily digest instead of individual
  digestTime      Int?                @map("digest_time")  // Hour for daily digest (0-23)

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  user            User                @relation("UserPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
  @@index([userId])
}

// Email queue for async sending
model EmailQueue {
  id              String              @id @default(uuid())

  // Recipient
  to              String              // Email address
  userId          String?             @map("user_id")  // Optional user reference

  // Email details
  subject         String
  htmlBody        String              @map("html_body")
  textBody        String?             @map("text_body")

  // Template info (optional)
  templateName    String?             @map("template_name")
  templateData    Json?               @map("template_data")

  // Related notification
  notificationType NotificationType?  @map("notification_type")
  entityType      String?             @map("entity_type")
  entityId        String?             @map("entity_id")

  // Status
  status          EmailStatus         @default(PENDING)
  attempts        Int                 @default(0)
  lastAttemptAt   DateTime?           @map("last_attempt_at")
  sentAt          DateTime?           @map("sent_at")
  error           String?

  // Priority
  priority        NotificationPriority @default(MEDIUM)

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  scheduledFor    DateTime?           @map("scheduled_for")  // Delayed sending
  expiresAt       DateTime?           @map("expires_at")  // Don't send after this

  @@map("email_queue")
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([userId])
}

enum EmailStatus {
  PENDING         // Waiting to be sent
  SENDING         // Currently being sent
  SENT            // Successfully sent
  FAILED          // Failed to send
  CANCELLED       // Cancelled before sending
}

// ============================================
// Advanced Search System
// ============================================

// User search history
model SearchHistory {
  id              String      @id @default(uuid())
  userId          String?     @map("user_id")  // Nullable for anonymous users

  // Search query
  query           String
  filters         Json?       // Search filters applied
  resultsCount    Int         @default(0) @map("results_count")

  // Search metadata
  category        String?     // Category searched
  location        String?     // Location searched

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  user            User?       @relation("UserSearchHistory", fields: [userId], references: [id], onDelete: SetNull)

  @@map("search_history")
  @@index([userId])
  @@index([query])
  @@index([createdAt])
}

// Popular/trending searches
model PopularSearch {
  id              String      @id @default(uuid())

  // Search data
  query           String      @unique
  searchCount     Int         @default(1) @map("search_count")

  // Trending data
  trend           Float       @default(0) // Trend score
  lastSearchedAt  DateTime    @map("last_searched_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("popular_searches")
  @@index([searchCount])
  @@index([trend])
  @@index([lastSearchedAt])
}

// User's saved searches
model SavedSearch {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")

  // Search details
  name            String      // User-given name for the search
  query           String?     // Text query
  filters         Json        // All search filters/criteria

  // Notifications
  notifyOnNew     Boolean     @default(false) @map("notify_on_new") // Alert on new matches

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  lastUsedAt      DateTime?   @map("last_used_at")

  // Relations
  user            User        @relation("UserSavedSearches", fields: [userId], references: [id], onDelete: Cascade)
  alerts          SearchAlert[]

  @@map("saved_searches")
  @@index([userId])
  @@index([createdAt])
}

// AI-powered search suggestions
model SearchSuggestion {
  id              String      @id @default(uuid())

  // Suggestion data
  keyword         String      @unique
  displayText     String      @map("display_text")
  category        String?

  // Stats
  clickCount      Int         @default(0) @map("click_count")

  // Admin control
  isActive        Boolean     @default(true) @map("is_active")
  priority        Int         @default(0)  // Higher priority shows first

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("search_suggestions")
  @@index([keyword])
  @@index([category])
  @@index([isActive])
  @@index([priority])
}

// ============================================
// Real-time Chat & Messaging System
// ============================================

// Chat conversation between two users
model Conversation {
  id              String      @id @default(uuid())

  // Participants (always 2 users for direct messaging)
  participant1Id  String      @map("participant1_id")
  participant2Id  String      @map("participant2_id")

  // Related transaction/item (optional context)
  itemId          String?     @map("item_id")
  transactionId   String?     @map("transaction_id")

  // Last message info (denormalized for performance)
  lastMessageAt   DateTime?   @map("last_message_at")
  lastMessageText String?     @map("last_message_text")

  // Unread counts per user
  unreadCount1    Int         @default(0) @map("unread_count_1") // For participant1
  unreadCount2    Int         @default(0) @map("unread_count_2") // For participant2

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  messages        Message[]
  typingIndicators TypingIndicator[]
  participant1    User        @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2    User        @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)

  @@map("conversations")
  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@index([itemId])
  @@index([transactionId])
  @@index([lastMessageAt])
}

// Individual chat message
enum MessageType {
  TEXT            // Regular text message
  IMAGE           // Image message
  FILE            // File attachment
  ITEM            // Shared item/product
  OFFER           // Offer/deal
  SYSTEM          // System message (e.g., "User joined")
}

enum MessageStatus {
  SENT            // Message sent
  DELIVERED       // Message delivered to recipient
  READ            // Message read by recipient
  FAILED          // Message failed to send
}

model Message {
  id              String        @id @default(uuid())
  conversationId  String        @map("conversation_id")
  senderId        String        @map("sender_id")
  recipientId     String        @map("recipient_id")

  // Message content
  type            MessageType   @default(TEXT)
  content         String        // Text content or JSON for special types
  attachments     String[]      @default([]) // URLs for images/files

  // Related entities (optional)
  itemId          String?       @map("item_id")    // Shared item
  offerId         String?       @map("offer_id")   // Related offer

  // Status
  status          MessageStatus @default(SENT)

  // Read tracking
  isRead          Boolean       @default(false) @map("is_read")
  readAt          DateTime?     @map("read_at")
  deliveredAt     DateTime?     @map("delivered_at")

  // Message metadata
  isEdited        Boolean       @default(false) @map("is_edited")
  editedAt        DateTime?     @map("edited_at")
  isDeleted       Boolean       @default(false) @map("is_deleted")
  deletedAt       DateTime?     @map("deleted_at")

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User          @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  recipient       User          @relation("MessagesReceived", fields: [recipientId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt])
  @@index([status])
  @@index([isRead])
}

// User typing indicator (in-memory, but can be stored for offline)
model TypingIndicator {
  id              String      @id @default(uuid())
  conversationId  String      @map("conversation_id")
  userId          String      @map("user_id")

  // Auto-expires after 5 seconds
  expiresAt       DateTime    @map("expires_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation("UserTypingIndicators", fields: [userId], references: [id], onDelete: Cascade)

  @@map("typing_indicators")
  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([expiresAt])
}

// User online/offline status
model UserPresence {
  id              String      @id @default(uuid())
  userId          String      @unique @map("user_id")

  // Status
  isOnline        Boolean     @default(false) @map("is_online")
  lastSeenAt      DateTime?   @map("last_seen_at")

  // Current socket connection (for real-time)
  socketId        String?     @map("socket_id")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  user            User        @relation("UserPresence", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_presence")
  @@index([userId])
  @@index([isOnline])
}

// Blocked users (prevent messaging)
model BlockedUser {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")        // User who blocked
  blockedUserId   String      @map("blocked_user_id") // User who was blocked

  // Reason (optional)
  reason          String?

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  blocker         User        @relation("UserBlocking", fields: [userId], references: [id], onDelete: Cascade)
  blocked         User        @relation("UserBlocked", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@map("blocked_users")
  @@unique([userId, blockedUserId])
  @@index([userId])
  @@index([blockedUserId])
}

// ============================================
// XCoin Wallet & Economy System
// نظام عملة المنصة والاقتصاد الداخلي
// ============================================

model Wallet {
  id              String      @id @default(uuid())
  userId          String      @unique @map("user_id")

  // Balances
  balance         Float       @default(0)          // رصيد XCoin المتاح
  frozenBalance   Float       @default(0) @map("frozen_balance")  // رصيد مجمد (في صفقات جارية)
  lifetimeEarned  Float       @default(0) @map("lifetime_earned") // إجمالي ما تم كسبه
  lifetimeSpent   Float       @default(0) @map("lifetime_spent")  // إجمالي ما تم إنفاقه

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    WalletTransaction[]

  @@map("wallets")
  @@index([userId])
  @@index([balance])
}

enum WalletTransactionType {
  // Earning (كسب)
  REWARD_SIGNUP           // مكافأة التسجيل
  REWARD_FIRST_DEAL       // مكافأة أول صفقة
  REWARD_REFERRAL         // مكافأة الإحالة
  REWARD_REVIEW           // مكافأة التقييم
  REWARD_ACHIEVEMENT      // مكافأة إنجاز
  REWARD_DAILY_LOGIN      // مكافأة الدخول اليومي
  REWARD_CHALLENGE        // مكافأة تحدي
  RECEIVED_FROM_USER      // مستلم من مستخدم آخر
  REFUND                  // استرداد
  ADMIN_CREDIT            // إضافة من الإدارة

  // Spending (إنفاق)
  PROMOTE_LISTING         // ترويج إعلان
  UNLOCK_CONTACT          // فتح معلومات تواصل
  BARTER_BALANCE          // موازنة فرق مقايضة
  ESCROW_DEPOSIT          // إيداع في الضمان
  SENT_TO_USER            // مرسل لمستخدم آخر
  COMMISSION_FEE          // رسوم عمولة
  ADMIN_DEBIT             // خصم من الإدارة

  // Escrow (الضمان)
  ESCROW_FREEZE           // تجميد للضمان
  ESCROW_RELEASE          // تحرير من الضمان
  ESCROW_REFUND           // استرداد من الضمان
}

enum WalletTransactionStatus {
  PENDING       // قيد الانتظار
  COMPLETED     // مكتمل
  FAILED        // فشل
  CANCELLED     // ملغي
  REVERSED      // معكوس
}

model WalletTransaction {
  id              String                    @id @default(uuid())
  walletId        String                    @map("wallet_id")

  // Transaction details
  type            WalletTransactionType
  amount          Float                     // موجب للإضافة، سالب للخصم
  balanceBefore   Float                     @map("balance_before")
  balanceAfter    Float                     @map("balance_after")

  // Status
  status          WalletTransactionStatus   @default(COMPLETED)

  // Related entities
  relatedUserId   String?                   @map("related_user_id")  // المستخدم الآخر في التحويل
  relatedEntityType String?                 @map("related_entity_type") // 'item', 'barter', 'escrow'
  relatedEntityId String?                   @map("related_entity_id")

  // Description
  description     String?
  metadata        Json?

  // Timestamps
  createdAt       DateTime                  @default(now()) @map("created_at")

  // Relations
  wallet          Wallet                    @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("wallet_transactions")
  @@index([walletId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([relatedUserId])
}

// ============================================
// Multi-Dimensional Reputation System
// نظام السمعة متعدد الأبعاد
// ============================================

model UserReputation {
  id              String      @id @default(uuid())
  userId          String      @unique @map("user_id")

  // Overall scores (0-100)
  overallScore    Float       @default(50) @map("overall_score")
  trustLevel      TrustLevel  @default(NEWCOMER) @map("trust_level")

  // Dimension scores (0-100)
  communicationScore    Float   @default(50) @map("communication_score")     // التواصل
  reliabilityScore      Float   @default(50) @map("reliability_score")       // الموثوقية
  itemAccuracyScore     Float   @default(50) @map("item_accuracy_score")     // دقة وصف الأصناف
  deliverySpeedScore    Float   @default(50) @map("delivery_speed_score")    // سرعة التسليم
  fairnessScore         Float   @default(50) @map("fairness_score")          // العدالة في التقييم
  barterQualityScore    Float   @default(50) @map("barter_quality_score")    // جودة المقايضات

  // Statistics
  totalDeals            Int     @default(0) @map("total_deals")
  successfulDeals       Int     @default(0) @map("successful_deals")
  disputesInitiated     Int     @default(0) @map("disputes_initiated")
  disputesLost          Int     @default(0) @map("disputes_lost")
  refundsGiven          Int     @default(0) @map("refunds_given")

  // Badges & Verification
  badges                String[] @default([])  // ['VERIFIED_SELLER', 'FAST_SHIPPER', 'FAIR_TRADER']
  verifiedSince         DateTime? @map("verified_since")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastCalculatedAt      DateTime? @map("last_calculated_at")

  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  history               ReputationHistory[]

  @@map("user_reputations")
  @@index([userId])
  @@index([overallScore])
  @@index([trustLevel])
}

enum TrustLevel {
  NEWCOMER        // جديد (0-20 صفقة)
  BRONZE          // برونزي (21-50 صفقة)
  SILVER          // فضي (51-100 صفقة)
  GOLD            // ذهبي (101-250 صفقة)
  PLATINUM        // بلاتيني (251-500 صفقة)
  DIAMOND         // ماسي (500+ صفقة)
  ELITE           // نخبوي (خاص بالتجار المميزين)
}

model ReputationHistory {
  id              String      @id @default(uuid())
  reputationId    String      @map("reputation_id")

  // Score snapshot
  overallScore    Float       @map("overall_score")
  trustLevel      TrustLevel  @map("trust_level")

  // Change reason
  changeReason    String      @map("change_reason")
  changeAmount    Float       @map("change_amount")  // +/- change

  // Related entity
  relatedEntityType String?   @map("related_entity_type")
  relatedEntityId String?     @map("related_entity_id")

  // Timestamp
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  reputation      UserReputation @relation(fields: [reputationId], references: [id], onDelete: Cascade)

  @@map("reputation_history")
  @@index([reputationId])
  @@index([createdAt])
}

// ============================================
// Smart Escrow & Dispute Resolution System
// نظام الضمان الذكي وحل النزاعات
// ============================================

enum EscrowStatus {
  CREATED         // تم إنشاؤه
  FUNDED          // تم تمويله
  PENDING_DELIVERY // في انتظار التسليم
  DELIVERED       // تم التسليم
  INSPECTION      // فترة الفحص
  RELEASED        // تم تحريره
  DISPUTED        // نزاع
  REFUNDED        // مسترد
  CANCELLED       // ملغي
  EXPIRED         // منتهي الصلاحية
}

enum EscrowType {
  SALE            // بيع
  BARTER          // مقايضة
  BARTER_CHAIN    // سلسلة مقايضة
  SERVICE         // خدمة
}

model Escrow {
  id              String        @id @default(uuid())

  // Type
  escrowType      EscrowType    @map("escrow_type")

  // Parties
  buyerId         String        @map("buyer_id")
  sellerId        String        @map("seller_id")

  // Amount
  amount          Float                     // المبلغ بالجنيه أو XCoin
  currency        String        @default("EGP")
  xcoinAmount     Float?        @map("xcoin_amount")  // مبلغ XCoin إن وجد

  // Related entities
  transactionId   String?       @map("transaction_id")
  barterOfferId   String?       @map("barter_offer_id")
  barterChainId   String?       @map("barter_chain_id")
  itemId          String?       @map("item_id")

  // Status
  status          EscrowStatus  @default(CREATED)

  // Timeline
  fundedAt        DateTime?     @map("funded_at")
  deliveredAt     DateTime?     @map("delivered_at")
  inspectionEndsAt DateTime?    @map("inspection_ends_at")  // نهاية فترة الفحص
  releasedAt      DateTime?     @map("released_at")

  // Auto-release
  autoReleaseAfter Int          @default(48) @map("auto_release_after")  // ساعات بعد التسليم
  autoRelease     Boolean       @default(true) @map("auto_release")

  // Facilitator (if any)
  facilitatorId   String?       @map("facilitator_id")
  facilitatorFee  Float?        @map("facilitator_fee")

  // Notes
  notes           String?

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  expiresAt       DateTime?     @map("expires_at")

  // Relations
  dispute         Dispute?
  milestones      EscrowMilestone[]

  @@map("escrows")
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([transactionId])
  @@index([barterOfferId])
  @@index([barterChainId])
  @@index([facilitatorId])
}

model EscrowMilestone {
  id              String      @id @default(uuid())
  escrowId        String      @map("escrow_id")

  // Milestone
  milestone       String      // 'CREATED', 'FUNDED', 'SHIPPED', 'DELIVERED', etc.
  description     String?

  // Actor
  actorId         String?     @map("actor_id")
  actorType       String?     @map("actor_type")  // 'BUYER', 'SELLER', 'SYSTEM', 'FACILITATOR'

  // Evidence
  evidence        String[]    @default([])  // صور/ملفات إثبات

  // Timestamp
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  escrow          Escrow      @relation(fields: [escrowId], references: [id], onDelete: Cascade)

  @@map("escrow_milestones")
  @@index([escrowId])
  @@index([milestone])
}

enum DisputeStatus {
  OPEN            // مفتوح
  UNDER_REVIEW    // قيد المراجعة
  AWAITING_RESPONSE // في انتظار الرد
  MEDIATION       // وساطة
  ESCALATED       // مرفوع للإدارة
  RESOLVED        // محلول
  CLOSED          // مغلق
}

enum DisputeResolution {
  BUYER_FAVORED       // لصالح المشتري (استرداد كامل)
  SELLER_FAVORED      // لصالح البائع (تحرير الضمان)
  PARTIAL_REFUND      // استرداد جزئي
  MUTUAL_AGREEMENT    // اتفاق بين الطرفين
  NO_RESOLUTION       // لم يتم الحل
}

model Dispute {
  id              String            @id @default(uuid())
  escrowId        String            @unique @map("escrow_id")

  // Initiator
  initiatorId     String            @map("initiator_id")
  respondentId    String            @map("respondent_id")

  // Dispute details
  reason          DisputeReason
  description     String
  evidence        String[]          @default([])  // صور/ملفات إثبات

  // Requested outcome
  requestedAmount Float?            @map("requested_amount")
  requestedOutcome String?          @map("requested_outcome")

  // Status
  status          DisputeStatus     @default(OPEN)

  // Resolution
  resolution      DisputeResolution?
  resolutionAmount Float?           @map("resolution_amount")
  resolutionNotes String?           @map("resolution_notes")
  resolvedBy      String?           @map("resolved_by")
  resolvedAt      DateTime?         @map("resolved_at")

  // Mediator/Admin
  assignedTo      String?           @map("assigned_to")
  assignedAt      DateTime?         @map("assigned_at")

  // Deadlines
  responseDeadline DateTime?        @map("response_deadline")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  escrow          Escrow            @relation(fields: [escrowId], references: [id])
  messages        DisputeMessage[]

  @@map("disputes")
  @@index([escrowId])
  @@index([initiatorId])
  @@index([respondentId])
  @@index([status])
  @@index([assignedTo])
}

enum DisputeReason {
  ITEM_NOT_RECEIVED       // لم يتم استلام الصنف
  ITEM_NOT_AS_DESCRIBED   // الصنف مختلف عن الوصف
  ITEM_DAMAGED            // الصنف تالف
  WRONG_ITEM              // صنف خاطئ
  PARTIAL_DELIVERY        // تسليم جزئي
  QUALITY_ISSUE           // مشكلة في الجودة
  COUNTERFEIT             // مزيف
  SELLER_NOT_RESPONDING   // البائع لا يرد
  BUYER_NOT_RESPONDING    // المشتري لا يرد
  PAYMENT_ISSUE           // مشكلة في الدفع
  OTHER                   // أخرى
}

model DisputeMessage {
  id              String      @id @default(uuid())
  disputeId       String      @map("dispute_id")

  // Sender
  senderId        String      @map("sender_id")
  senderRole      String      @map("sender_role")  // 'INITIATOR', 'RESPONDENT', 'MEDIATOR', 'ADMIN'

  // Message
  message         String
  attachments     String[]    @default([])

  // Visibility
  isInternal      Boolean     @default(false) @map("is_internal")  // ملاحظات داخلية للإدارة

  // Timestamp
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  dispute         Dispute     @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  @@map("dispute_messages")
  @@index([disputeId])
  @@index([senderId])
  @@index([createdAt])
}

// ============================================
// Gamification & Achievements System
// نظام التلعيب والإنجازات
// ============================================

model UserLevel {
  id              String      @id @default(uuid())
  userId          String      @unique @map("user_id")

  // Level
  level           Int         @default(1)
  currentXP       Int         @default(0) @map("current_xp")
  totalXP         Int         @default(0) @map("total_xp")
  xpToNextLevel   Int         @default(100) @map("xp_to_next_level")

  // Title
  title           String      @default("مبتدئ")  // لقب المستوى

  // Streaks
  dailyLoginStreak    Int     @default(0) @map("daily_login_streak")
  longestLoginStreak  Int     @default(0) @map("longest_login_streak")
  lastLoginDate       DateTime? @map("last_login_date")

  // Weekly stats
  weeklyDeals         Int     @default(0) @map("weekly_deals")
  weeklyXP            Int     @default(0) @map("weekly_xp")
  weekStartDate       DateTime? @map("week_start_date")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievements    UserAchievement[]

  @@map("user_levels")
  @@index([userId])
  @@index([level])
  @@index([totalXP])
}

model Achievement {
  id              String      @id @default(uuid())

  // Basic info
  code            String      @unique  // 'FIRST_DEAL', 'BARTER_MASTER', etc.
  nameAr          String      @map("name_ar")
  nameEn          String      @map("name_en")
  descriptionAr   String      @map("description_ar")
  descriptionEn   String      @map("description_en")

  // Visual
  icon            String      // رمز الإنجاز
  badgeColor      String      @default("#FFD700") @map("badge_color")

  // Category
  category        AchievementCategory

  // Requirements
  requirement     Int         @default(1)  // عدد المرات المطلوبة
  requirementType String      @map("requirement_type")  // 'DEALS', 'BARTERS', 'REVIEWS', etc.

  // Rewards
  xpReward        Int         @default(0) @map("xp_reward")
  coinReward      Int         @default(0) @map("coin_reward")

  // Rarity
  rarity          AchievementRarity @default(COMMON)

  // Status
  isActive        Boolean     @default(true) @map("is_active")
  isSecret        Boolean     @default(false) @map("is_secret")  // إنجاز سري

  // Order
  displayOrder    Int         @default(0) @map("display_order")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
  @@index([code])
  @@index([category])
  @@index([isActive])
}

enum AchievementCategory {
  TRADING         // تداول
  BARTER          // مقايضة
  SOCIAL          // اجتماعي
  REPUTATION      // سمعة
  SPECIAL         // خاص
  SEASONAL        // موسمي
}

enum AchievementRarity {
  COMMON          // شائع
  UNCOMMON        // غير شائع
  RARE            // نادر
  EPIC            // ملحمي
  LEGENDARY       // أسطوري
}

model UserAchievement {
  id              String      @id @default(uuid())
  userLevelId     String      @map("user_level_id")
  achievementId   String      @map("achievement_id")

  // Progress
  progress        Int         @default(0)
  isCompleted     Boolean     @default(false) @map("is_completed")

  // Completion
  completedAt     DateTime?   @map("completed_at")
  rewardsClaimed  Boolean     @default(false) @map("rewards_claimed")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  userLevel       UserLevel   @relation(fields: [userLevelId], references: [id], onDelete: Cascade)
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@map("user_achievements")
  @@unique([userLevelId, achievementId])
  @@index([userLevelId])
  @@index([achievementId])
  @@index([isCompleted])
}

model Challenge {
  id              String      @id @default(uuid())

  // Basic info
  nameAr          String      @map("name_ar")
  nameEn          String      @map("name_en")
  descriptionAr   String      @map("description_ar")
  descriptionEn   String      @map("description_en")

  // Type
  challengeType   ChallengeType @map("challenge_type")

  // Requirements
  targetValue     Int         @map("target_value")  // الهدف المطلوب
  targetType      String      @map("target_type")   // 'DEALS', 'BARTERS', 'XP', etc.

  // Rewards
  xpReward        Int         @default(0) @map("xp_reward")
  coinReward      Int         @default(0) @map("coin_reward")
  specialReward   String?     @map("special_reward")  // مكافأة خاصة

  // Duration
  startDate       DateTime    @map("start_date")
  endDate         DateTime    @map("end_date")

  // Status
  isActive        Boolean     @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  participations  ChallengeParticipation[]

  @@map("challenges")
  @@index([challengeType])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

enum ChallengeType {
  DAILY           // يومي
  WEEKLY          // أسبوعي
  MONTHLY         // شهري
  SPECIAL         // خاص
}

model ChallengeParticipation {
  id              String      @id @default(uuid())
  challengeId     String      @map("challenge_id")
  userId          String      @map("user_id")

  // Progress
  currentValue    Int         @default(0) @map("current_value")
  isCompleted     Boolean     @default(false) @map("is_completed")

  // Completion
  completedAt     DateTime?   @map("completed_at")
  rewardsClaimed  Boolean     @default(false) @map("rewards_claimed")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  challenge       Challenge   @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user            User        @relation("UserChallengeParticipations", fields: [userId], references: [id], onDelete: Cascade)

  @@map("challenge_participations")
  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@index([isCompleted])
}

// ============================================
// Collective Barter Pools
// صناديق المقايضة الجماعية
// ============================================

enum BarterPoolStatus {
  OPEN            // مفتوح للانضمام
  MATCHING        // جاري البحث عن عرض
  MATCHED         // تم المطابقة
  NEGOTIATING     // جاري التفاوض
  EXECUTING       // جاري التنفيذ
  COMPLETED       // مكتمل
  FAILED          // فشل
  CANCELLED       // ملغي
}

model BarterPool {
  id              String            @id @default(uuid())

  // Basic info
  title           String
  description     String

  // Target
  targetCategoryId String?          @map("target_category_id")
  targetDescription String          @map("target_description")
  targetMinValue  Float             @map("target_min_value")
  targetMaxValue  Float             @map("target_max_value")

  // Pool value
  currentValue    Float             @default(0) @map("current_value")
  participantCount Int              @default(0) @map("participant_count")
  maxParticipants Int               @default(10) @map("max_participants")

  // Status
  status          BarterPoolStatus  @default(OPEN)

  // Creator
  creatorId       String            @map("creator_id")

  // Matched offer (when found)
  matchedItemId   String?           @map("matched_item_id")
  matchedSellerId String?           @map("matched_seller_id")
  matchedValue    Float?            @map("matched_value")

  // Deadline
  deadline        DateTime

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  completedAt     DateTime?         @map("completed_at")

  // Relations
  participants    BarterPoolParticipant[]

  @@map("barter_pools")
  @@index([status])
  @@index([creatorId])
  @@index([targetCategoryId])
  @@index([deadline])
}

model BarterPoolParticipant {
  id              String      @id @default(uuid())
  poolId          String      @map("pool_id")
  userId          String      @map("user_id")

  // Contribution
  itemId          String?     @map("item_id")       // الصنف المقدم
  cashAmount      Float       @default(0) @map("cash_amount")  // مبلغ نقدي
  xcoinAmount     Float       @default(0) @map("xcoin_amount") // مبلغ XCoin
  totalValue      Float       @map("total_value")   // إجمالي المساهمة

  // Share percentage
  sharePercentage Float       @map("share_percentage")  // نسبة الحصة

  // Status
  isApproved      Boolean     @default(false) @map("is_approved")
  approvedAt      DateTime?   @map("approved_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  pool            BarterPool  @relation(fields: [poolId], references: [id], onDelete: Cascade)
  user            User        @relation("UserBarterPoolParticipations", fields: [userId], references: [id], onDelete: Cascade)

  @@map("barter_pool_participants")
  @@unique([poolId, userId])
  @@index([poolId])
  @@index([userId])
}

// ============================================
// Certified Facilitators Network
// شبكة الوسطاء المعتمدين
// ============================================

enum FacilitatorLevel {
  BRONZE          // برونزي
  SILVER          // فضي
  GOLD            // ذهبي
  PLATINUM        // بلاتيني
}

enum FacilitatorStatus {
  PENDING         // قيد الموافقة
  ACTIVE          // نشط
  SUSPENDED       // موقوف
  REVOKED         // ملغي
}

model Facilitator {
  id              String              @id @default(uuid())
  userId          String              @unique @map("user_id")

  // Level & Status
  level           FacilitatorLevel    @default(BRONZE)
  status          FacilitatorStatus   @default(PENDING)

  // Info
  displayName     String              @map("display_name")
  bio             String?
  specializations String[]            @default([])  // ['سيارات', 'عقارات', 'إلكترونيات']

  // Service areas
  serviceAreas    String[]            @default([]) @map("service_areas")  // المحافظات

  // Commission
  commissionRate  Float               @default(0.03) @map("commission_rate")  // 3% default
  minCommission   Float               @default(50) @map("min_commission")     // 50 جنيه حد أدنى

  // Insurance
  insuranceCoverage Float             @default(10000) @map("insurance_coverage")  // تغطية التأمين
  insuranceBalance Float              @default(0) @map("insurance_balance")       // رصيد التأمين

  // Statistics
  totalDeals      Int                 @default(0) @map("total_deals")
  successfulDeals Int                 @default(0) @map("successful_deals")
  totalVolume     Float               @default(0) @map("total_volume")  // إجمالي قيمة الصفقات
  avgRating       Float               @default(0) @map("avg_rating")

  // Verification
  verifiedAt      DateTime?           @map("verified_at")
  verifiedBy      String?             @map("verified_by")

  // Documents
  idDocument      String?             @map("id_document")
  commercialReg   String?             @map("commercial_reg")

  // Availability
  isAvailable     Boolean             @default(true) @map("is_available")
  availabilitySchedule Json?          @map("availability_schedule")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignments     FacilitatorAssignment[]
  reviews         FacilitatorReview[]

  @@map("facilitators")
  @@index([userId])
  @@index([level])
  @@index([status])
  @@index([isAvailable])
}

model FacilitatorAssignment {
  id              String      @id @default(uuid())
  facilitatorId   String      @map("facilitator_id")

  // Assignment type
  assignmentType  String      @map("assignment_type")  // 'ESCROW', 'BARTER_CHAIN', 'INSPECTION'

  // Related entity
  escrowId        String?     @map("escrow_id")
  barterChainId   String?     @map("barter_chain_id")

  // Parties
  buyerId         String      @map("buyer_id")
  sellerId        String      @map("seller_id")

  // Status
  status          String      @default("ASSIGNED")  // 'ASSIGNED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'

  // Commission
  commissionAmount Float      @map("commission_amount")
  commissionPaid  Boolean     @default(false) @map("commission_paid")

  // Notes
  notes           String?
  completionNotes String?     @map("completion_notes")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  completedAt     DateTime?   @map("completed_at")

  // Relations
  facilitator     Facilitator @relation(fields: [facilitatorId], references: [id], onDelete: Cascade)

  @@map("facilitator_assignments")
  @@index([facilitatorId])
  @@index([escrowId])
  @@index([barterChainId])
  @@index([status])
}

model FacilitatorReview {
  id              String      @id @default(uuid())
  facilitatorId   String      @map("facilitator_id")
  reviewerId      String      @map("reviewer_id")
  assignmentId    String      @map("assignment_id")

  // Rating
  rating          Int         // 1-5

  // Detailed ratings
  professionalismRating Int   @map("professionalism_rating")  // 1-5
  communicationRating   Int   @map("communication_rating")    // 1-5
  speedRating           Int   @map("speed_rating")            // 1-5

  // Review
  comment         String?

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  facilitator     Facilitator @relation(fields: [facilitatorId], references: [id], onDelete: Cascade)

  @@map("facilitator_reviews")
  @@unique([assignmentId, reviewerId])
  @@index([facilitatorId])
  @@index([reviewerId])
  @@index([rating])
}

// ============================================
// Referral System
// نظام الإحالات
// ============================================

model Referral {
  id              String      @id @default(uuid())
  referrerId      String      @map("referrer_id")
  referredId      String      @unique @map("referred_id")  // المستخدم الجديد

  // Referral code used
  referralCode    String      @map("referral_code")

  // Rewards
  referrerReward  Float       @default(0) @map("referrer_reward")
  referredReward  Float       @default(0) @map("referred_reward")

  // Status
  rewardsClaimed  Boolean     @default(false) @map("rewards_claimed")
  claimedAt       DateTime?   @map("claimed_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("referrals")
  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
}

model ReferralCode {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")

  // Code
  code            String      @unique

  // Stats
  usageCount      Int         @default(0) @map("usage_count")
  maxUsages       Int?        @map("max_usages")  // null = unlimited

  // Rewards
  referrerReward  Float       @default(100) @map("referrer_reward")  // XCoin للمحيل
  referredReward  Float       @default(50) @map("referred_reward")   // XCoin للمحال

  // Status
  isActive        Boolean     @default(true) @map("is_active")

  // Expiry
  expiresAt       DateTime?   @map("expires_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("referral_codes")
  @@index([userId])
  @@index([code])
  @@index([isActive])
}

// ============================================
// Platform Analytics & Insights
// تحليلات ورؤى المنصة
// ============================================

model MarketInsight {
  id              String      @id @default(uuid())

  // Period
  periodType      String      @map("period_type")  // 'DAILY', 'WEEKLY', 'MONTHLY'
  periodStart     DateTime    @map("period_start")
  periodEnd       DateTime    @map("period_end")

  // Category (optional, for category-specific insights)
  categoryId      String?     @map("category_id")
  governorate     String?

  // Volume metrics
  totalListings   Int         @default(0) @map("total_listings")
  totalDeals      Int         @default(0) @map("total_deals")
  totalBarters    Int         @default(0) @map("total_barters")
  totalVolume     Float       @default(0) @map("total_volume")

  // Price metrics
  avgPrice        Float?      @map("avg_price")
  minPrice        Float?      @map("min_price")
  maxPrice        Float?      @map("max_price")
  priceChange     Float?      @map("price_change")  // % change from previous period

  // Demand metrics
  totalDemand     Int         @default(0) @map("total_demand")
  supplyDemandRatio Float?    @map("supply_demand_ratio")

  // Engagement metrics
  avgTimeToSell   Float?      @map("avg_time_to_sell")  // بالساعات
  conversionRate  Float?      @map("conversion_rate")   // % من المشاهدات للصفقات

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("market_insights")
  @@unique([periodType, periodStart, categoryId, governorate])
  @@index([periodType])
  @@index([periodStart])
  @@index([categoryId])
  @@index([governorate])
}

model XChangeIndex {
  id              String      @id @default(uuid())

  // Date
  date            DateTime    @unique

  // Index value
  indexValue      Float       @map("index_value")
  previousValue   Float?      @map("previous_value")
  changePercent   Float?      @map("change_percent")

  // Components
  barterVolume    Float       @map("barter_volume")
  directSaleVolume Float      @map("direct_sale_volume")
  auctionVolume   Float       @map("auction_volume")

  // Activity metrics
  activeUsers     Int         @map("active_users")
  newListings     Int         @map("new_listings")
  completedDeals  Int         @map("completed_deals")

  // Health metrics
  successRate     Float       @map("success_rate")
  avgDealTime     Float       @map("avg_deal_time")
  disputeRate     Float       @map("dispute_rate")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("xchange_index")
  @@index([date])
}

// ============================================
// AI Price Prediction System
// نظام التنبؤ بالأسعار بالذكاء الاصطناعي
// ============================================

model PricePrediction {
  id              String      @id @default(uuid())

  // Item details
  categoryId      String      @map("category_id")
  condition       ItemCondition
  title           String?
  description     String?

  // Prediction results
  predictedPrice  Float       @map("predicted_price")
  confidenceScore Float       @map("confidence_score")  // 0-100
  priceRangeMin   Float       @map("price_range_min")
  priceRangeMax   Float       @map("price_range_max")

  // Prediction factors
  marketTrend     String?     @map("market_trend")      // 'UP', 'DOWN', 'STABLE'
  demandLevel     String?     @map("demand_level")      // 'HIGH', 'MEDIUM', 'LOW'
  seasonalFactor  Float?      @map("seasonal_factor")   // -1 to +1
  competitionLevel String?    @map("competition_level") // 'HIGH', 'MEDIUM', 'LOW'

  // Data sources
  sampleSize      Int         @map("sample_size")
  dataQuality     String      @map("data_quality")      // 'EXCELLENT', 'GOOD', 'LIMITED'
  modelVersion    String      @map("model_version")

  // Recommendations
  suggestedPrice  Float?      @map("suggested_price")
  priceStrategy   String?     @map("price_strategy")    // 'COMPETITIVE', 'PREMIUM', 'VALUE'
  recommendations Json?

  // User who requested
  userId          String?     @map("user_id")
  itemId          String?     @map("item_id")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  expiresAt       DateTime    @map("expires_at")  // Prediction validity

  // Relations
  category        Category    @relation(fields: [categoryId], references: [id])

  @@map("price_predictions")
  @@index([categoryId])
  @@index([userId])
  @@index([createdAt])
}

model PriceHistory {
  id              String      @id @default(uuid())

  // Category
  categoryId      String      @map("category_id")
  condition       ItemCondition?

  // Date
  date            DateTime    @db.Date
  periodType      String      @default("DAILY") @map("period_type")  // 'DAILY', 'WEEKLY', 'MONTHLY'

  // Price statistics
  avgPrice        Float       @map("avg_price")
  minPrice        Float       @map("min_price")
  maxPrice        Float       @map("max_price")
  medianPrice     Float       @map("median_price")

  // Volume
  sampleCount     Int         @map("sample_count")
  totalVolume     Float       @map("total_volume")

  // Trends
  priceChange     Float?      @map("price_change")      // % change from previous period
  volumeChange    Float?      @map("volume_change")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("price_history")
  @@unique([categoryId, condition, date, periodType])
  @@index([categoryId])
  @@index([date])
  @@index([periodType])
}

// ============================================
// Subscription Plans System
// نظام خطط الاشتراك
// ============================================

enum SubscriptionTier {
  FREE            // مجاني
  BASIC           // أساسي
  PROFESSIONAL    // محترف
  BUSINESS        // تجاري
  ENTERPRISE      // مؤسسي
}

enum SubscriptionStatus {
  ACTIVE          // نشط
  CANCELLED       // ملغي
  EXPIRED         // منتهي
  PAUSED          // متوقف مؤقتاً
  PENDING         // قيد الانتظار
}

model SubscriptionPlan {
  id              String            @id @default(uuid())

  // Plan info
  tier            SubscriptionTier  @unique
  name            String
  nameAr          String            @map("name_ar")
  description     String
  descriptionAr   String            @map("description_ar")

  // Pricing
  monthlyPrice    Float             @map("monthly_price")
  yearlyPrice     Float             @map("yearly_price")
  currency        String            @default("EGP")

  // Features (JSON for flexibility)
  features        Json              // Array of features

  // Limits
  maxListings     Int?              @map("max_listings")      // عدد الإعلانات
  maxImages       Int               @default(5) @map("max_images")  // صور لكل إعلان
  featuredListings Int              @default(0) @map("featured_listings") // إعلانات مميزة
  boostCredits    Int               @default(0) @map("boost_credits")  // رصيد رفع الإعلانات
  prioritySupport Boolean           @default(false) @map("priority_support")
  analyticsAccess Boolean           @default(false) @map("analytics_access")
  apiAccess       Boolean           @default(false) @map("api_access")
  customBranding  Boolean           @default(false) @map("custom_branding")

  // XCoin benefits
  xcoinMultiplier Float             @default(1) @map("xcoin_multiplier")  // مضاعف مكافآت XCoin
  monthlyXcoin    Int               @default(0) @map("monthly_xcoin")     // XCoin شهري مجاني

  // Status
  isActive        Boolean           @default(true) @map("is_active")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  subscriptions   UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id              String              @id @default(uuid())
  userId          String              @map("user_id")
  planId          String              @map("plan_id")

  // Status
  status          SubscriptionStatus  @default(PENDING)

  // Billing
  billingCycle    String              @default("MONTHLY") @map("billing_cycle") // 'MONTHLY', 'YEARLY'
  currentPrice    Float               @map("current_price")
  currency        String              @default("EGP")

  // Dates
  startDate       DateTime            @map("start_date")
  endDate         DateTime            @map("end_date")
  cancelledAt     DateTime?           @map("cancelled_at")
  pausedAt        DateTime?           @map("paused_at")

  // Usage tracking
  listingsUsed    Int                 @default(0) @map("listings_used")
  boostsUsed      Int                 @default(0) @map("boosts_used")
  featuredUsed    Int                 @default(0) @map("featured_used")

  // Payment
  paymentMethod   String?             @map("payment_method")
  lastPaymentAt   DateTime?           @map("last_payment_at")
  nextPaymentAt   DateTime?           @map("next_payment_at")

  // Auto-renewal
  autoRenew       Boolean             @default(true) @map("auto_renew")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  plan            SubscriptionPlan    @relation(fields: [planId], references: [id], onDelete: Restrict)

  @@map("user_subscriptions")
  @@index([userId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
}

// ============================================
// Flash Deals System
// نظام العروض الخاطفة
// ============================================

enum FlashDealStatus {
  SCHEDULED       // مجدول
  ACTIVE          // نشط
  ENDED           // انتهى
  SOLD_OUT        // نفذت الكمية
  CANCELLED       // ملغي
}

model FlashDeal {
  id              String            @id @default(uuid())
  listingId       String            @map("listing_id")

  // Deal info
  title           String
  description     String?

  // Pricing
  originalPrice   Float             @map("original_price")
  dealPrice       Float             @map("deal_price")
  discountPercent Float             @map("discount_percent")

  // Timing
  startTime       DateTime          @map("start_time")
  endTime         DateTime          @map("end_time")

  // Stock
  totalQuantity   Int               @map("total_quantity")
  soldQuantity    Int               @default(0) @map("sold_quantity")
  reservedQuantity Int              @default(0) @map("reserved_quantity")

  // Limits
  maxPerUser      Int               @default(1) @map("max_per_user")

  // Status
  status          FlashDealStatus   @default(SCHEDULED)

  // Priority/Visibility
  priority        Int               @default(0)
  isFeatured      Boolean           @default(false) @map("is_featured")

  // Statistics
  viewCount       Int               @default(0) @map("view_count")
  clickCount      Int               @default(0) @map("click_count")
  conversionRate  Float?            @map("conversion_rate")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  listing         Listing           @relation(fields: [listingId], references: [id], onDelete: Cascade)
  claims          FlashDealClaim[]

  @@map("flash_deals")
  @@index([listingId])
  @@index([status])
  @@index([startTime])
  @@index([endTime])
  @@index([isFeatured])
}

model FlashDealClaim {
  id              String      @id @default(uuid())
  dealId          String      @map("deal_id")
  userId          String      @map("user_id")

  // Claim details
  quantity        Int         @default(1)
  priceAtClaim    Float       @map("price_at_claim")

  // Status
  status          String      @default("CLAIMED")  // 'CLAIMED', 'PURCHASED', 'EXPIRED', 'CANCELLED'

  // Reservation expires
  expiresAt       DateTime    @map("expires_at")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  purchasedAt     DateTime?   @map("purchased_at")

  // Relations
  deal            FlashDeal   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("flash_deal_claims")
  @@unique([dealId, userId])
  @@index([dealId])
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

// ============================================
// Smart Wishlist with Price Alerts
// قائمة الرغبات الذكية مع تنبيهات الأسعار
// ============================================

model PriceAlert {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")

  // Target (one of these)
  itemId          String?     @map("item_id")         // تتبع منتج معين
  categoryId      String?     @map("category_id")     // تتبع فئة
  searchQuery     String?     @map("search_query")    // تتبع بحث

  // Alert conditions
  targetPrice     Float?      @map("target_price")    // سعر مستهدف
  priceDropPercent Float?     @map("price_drop_percent") // نسبة انخفاض
  alertOnNew      Boolean     @default(true) @map("alert_on_new")  // تنبيه عند إضافة جديد

  // Additional filters
  minCondition    ItemCondition? @map("min_condition")
  maxPrice        Float?      @map("max_price")
  governorate     String?

  // Notification preferences
  emailAlert      Boolean     @default(true) @map("email_alert")
  pushAlert       Boolean     @default(true) @map("push_alert")
  smsAlert        Boolean     @default(false) @map("sms_alert")

  // Status
  isActive        Boolean     @default(true) @map("is_active")
  lastTriggeredAt DateTime?   @map("last_triggered_at")
  triggerCount    Int         @default(0) @map("trigger_count")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  expiresAt       DateTime?   @map("expires_at")

  // Relations
  user            User        @relation("UserPriceAlerts", fields: [userId], references: [id], onDelete: Cascade)

  @@map("price_alerts")
  @@index([userId])
  @@index([itemId])
  @@index([categoryId])
  @@index([isActive])
}

// ============================================
// Social Features - Follow System
// الميزات الاجتماعية - نظام المتابعة
// ============================================

model UserFollow {
  id              String      @id @default(uuid())
  followerId      String      @map("follower_id")     // المتابِع
  followingId     String      @map("following_id")    // المتابَع

  // Status
  isActive        Boolean     @default(true) @map("is_active")

  // Notification preferences
  notifyNewItems  Boolean     @default(true) @map("notify_new_items")
  notifyDeals     Boolean     @default(true) @map("notify_deals")
  notifyActivity  Boolean     @default(false) @map("notify_activity")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  follower        User        @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following       User        @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@map("user_follows")
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@index([isActive])
}

model ActivityFeed {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")         // صاحب النشاط

  // Activity type
  activityType    String      @map("activity_type")   // 'NEW_LISTING', 'PRICE_DROP', 'DEAL_COMPLETED', 'REVIEW_RECEIVED', 'LEVEL_UP'

  // Related entity
  entityType      String      @map("entity_type")     // 'ITEM', 'LISTING', 'REVIEW', 'ACHIEVEMENT'
  entityId        String      @map("entity_id")

  // Activity details
  title           String
  description     String?
  imageUrl        String?     @map("image_url")
  metadata        Json?

  // Privacy
  isPublic        Boolean     @default(true) @map("is_public")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  user            User        @relation("UserActivityFeed", fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_feeds")
  @@index([userId])
  @@index([activityType])
  @@index([createdAt])
  @@index([isPublic])
}

// ============================================
// Installment Payment System
// نظام الدفع بالتقسيط
// ============================================

enum InstallmentPlanStatus {
  DRAFT           // مسودة
  ACTIVE          // نشط
  COMPLETED       // مكتمل
  DEFAULTED       // متعثر
  CANCELLED       // ملغي
}

enum InstallmentPaymentStatus {
  PENDING         // قيد الانتظار
  PAID            // مدفوع
  LATE            // متأخر
  DEFAULTED       // متعثر
  WAIVED          // معفى
}

model InstallmentPlan {
  id              String                @id @default(uuid())
  transactionId   String?               @map("transaction_id")
  listingId       String                @map("listing_id")
  buyerId         String                @map("buyer_id")
  sellerId        String                @map("seller_id")

  // Plan details
  totalAmount     Float                 @map("total_amount")
  downPayment     Float                 @map("down_payment")
  remainingAmount Float                 @map("remaining_amount")
  numberOfInstallments Int              @map("number_of_installments")
  installmentAmount Float               @map("installment_amount")

  // Interest/Fees
  interestRate    Float                 @default(0) @map("interest_rate")  // نسبة الفائدة
  adminFee        Float                 @default(0) @map("admin_fee")      // رسوم إدارية
  lateFee         Float                 @default(0) @map("late_fee")       // رسوم تأخير

  // Schedule
  startDate       DateTime              @map("start_date")
  endDate         DateTime              @map("end_date")
  paymentDay      Int                   @default(1) @map("payment_day")    // يوم الدفع من الشهر

  // Status
  status          InstallmentPlanStatus @default(DRAFT)
  paidInstallments Int                  @default(0) @map("paid_installments")
  totalPaid       Float                 @default(0) @map("total_paid")
  missedPayments  Int                   @default(0) @map("missed_payments")

  // Approval
  sellerApproved  Boolean               @default(false) @map("seller_approved")
  sellerApprovedAt DateTime?            @map("seller_approved_at")

  // Collateral/Guarantor (optional)
  hasGuarantor    Boolean               @default(false) @map("has_guarantor")
  guarantorInfo   Json?                 @map("guarantor_info")

  // Timestamps
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  completedAt     DateTime?             @map("completed_at")

  // Relations
  listing         Listing               @relation(fields: [listingId], references: [id], onDelete: Restrict)
  installments    Installment[]

  @@map("installment_plans")
  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([status])
}

model Installment {
  id              String            @id @default(uuid())
  planId          String            @map("plan_id")

  // Installment details
  installmentNumber Int             @map("installment_number")
  amount          Float
  dueDate         DateTime          @map("due_date")

  // Payment
  paidAmount      Float?            @map("paid_amount")
  paidAt          DateTime?         @map("paid_at")
  paymentMethod   String?           @map("payment_method")
  paymentReference String?          @map("payment_reference")

  // Late fees
  lateFeeApplied  Float             @default(0) @map("late_fee_applied")
  daysLate        Int               @default(0) @map("days_late")

  // Status
  status          InstallmentPaymentStatus @default(PENDING)

  // Reminders
  remindersSent   Int               @default(0) @map("reminders_sent")
  lastReminderAt  DateTime?         @map("last_reminder_at")

  // Timestamps
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  plan            InstallmentPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("installments")
  @@unique([planId, installmentNumber])
  @@index([planId])
  @@index([dueDate])
  @@index([status])
}

// ============================================
// Group Buying (Tawfir) System
// نظام الشراء الجماعي (توفير)
// ============================================

enum GroupBuyStatus {
  DRAFT           // مسودة
  ACTIVE          // نشط
  TARGET_REACHED  // تم الوصول للهدف
  CONFIRMED       // مؤكد
  COMPLETED       // مكتمل
  FAILED          // فشل
  CANCELLED       // ملغي
}

model GroupBuy {
  id              String          @id @default(uuid())
  listingId       String          @map("listing_id")
  organizerId     String          @map("organizer_id")

  // Product details
  title           String
  description     String?

  // Pricing tiers
  originalPrice   Float           @map("original_price")
  targetQuantity  Int             @map("target_quantity")     // الحد الأدنى للمجموعة
  maxQuantity     Int?            @map("max_quantity")        // الحد الأقصى
  currentQuantity Int             @default(0) @map("current_quantity")

  // Discount tiers (JSON array)
  // [{ minQty: 10, discount: 10 }, { minQty: 20, discount: 15 }, ...]
  discountTiers   Json            @map("discount_tiers")

  // Current discount
  currentDiscount Float           @default(0) @map("current_discount")
  currentPrice    Float           @map("current_price")

  // Timing
  startDate       DateTime        @map("start_date")
  endDate         DateTime        @map("end_date")

  // Status
  status          GroupBuyStatus  @default(DRAFT)

  // Limits
  maxPerUser      Int             @default(5) @map("max_per_user")

  // Stats
  participantCount Int            @default(0) @map("participant_count")
  viewCount       Int             @default(0) @map("view_count")

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  confirmedAt     DateTime?       @map("confirmed_at")
  completedAt     DateTime?       @map("completed_at")

  // Relations
  listing         Listing         @relation(fields: [listingId], references: [id], onDelete: Cascade)
  participants    GroupBuyParticipant[]

  @@map("group_buys")
  @@index([listingId])
  @@index([organizerId])
  @@index([status])
  @@index([endDate])
}

model GroupBuyParticipant {
  id              String      @id @default(uuid())
  groupBuyId      String      @map("group_buy_id")
  userId          String      @map("user_id")

  // Order details
  quantity        Int         @default(1)
  unitPrice       Float       @map("unit_price")     // السعر وقت الانضمام
  totalPrice      Float       @map("total_price")

  // Status
  status          String      @default("JOINED")     // 'JOINED', 'PAID', 'CANCELLED', 'REFUNDED'

  // Payment
  paidAt          DateTime?   @map("paid_at")
  paymentMethod   String?     @map("payment_method")
  paymentRef      String?     @map("payment_ref")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  groupBuy        GroupBuy    @relation(fields: [groupBuyId], references: [id], onDelete: Cascade)

  @@map("group_buy_participants")
  @@unique([groupBuyId, userId])
  @@index([groupBuyId])
  @@index([userId])
  @@index([status])
}

// ============================================
// Warranty & Insurance System
// نظام الضمان والتأمين
// ============================================

enum WarrantyType {
  SELLER_WARRANTY     // ضمان البائع
  PLATFORM_WARRANTY   // ضمان المنصة
  EXTENDED_WARRANTY   // ضمان ممتد
  INSURANCE           // تأمين
}

enum WarrantyStatus {
  ACTIVE              // نشط
  EXPIRED             // منتهي
  CLAIMED             // تم المطالبة
  VOIDED              // ملغي
}

enum WarrantyClaimStatus {
  PENDING             // قيد المراجعة
  APPROVED            // مقبول
  REJECTED            // مرفوض
  IN_REPAIR           // جاري الإصلاح
  REPLACED            // تم الاستبدال
  REFUNDED            // تم الاسترداد
  CLOSED              // مغلق
}

model Warranty {
  id              String          @id @default(uuid())
  transactionId   String          @map("transaction_id")
  itemId          String          @map("item_id")
  buyerId         String          @map("buyer_id")
  sellerId        String          @map("seller_id")

  // Warranty details
  warrantyType    WarrantyType    @map("warranty_type")
  title           String
  description     String?

  // Coverage
  coverageDetails Json            @map("coverage_details")  // What's covered
  exclusions      Json?                                      // What's not covered
  maxClaimValue   Float?          @map("max_claim_value")

  // Duration
  startDate       DateTime        @map("start_date")
  endDate         DateTime        @map("end_date")
  durationMonths  Int             @map("duration_months")

  // Pricing
  price           Float           @default(0)   // For extended warranty
  isPaid          Boolean         @default(true) @map("is_paid")

  // Status
  status          WarrantyStatus  @default(ACTIVE)

  // Claims
  claimsCount     Int             @default(0) @map("claims_count")
  maxClaims       Int             @default(1) @map("max_claims")

  // Documents
  certificateUrl  String?         @map("certificate_url")
  termsUrl        String?         @map("terms_url")

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  claims          WarrantyClaim[]

  @@map("warranties")
  @@index([transactionId])
  @@index([itemId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([endDate])
}

model WarrantyClaim {
  id              String              @id @default(uuid())
  warrantyId      String              @map("warranty_id")
  claimantId      String              @map("claimant_id")

  // Claim details
  issueType       String              @map("issue_type")      // 'DEFECT', 'MALFUNCTION', 'DAMAGE'
  issueDescription String             @map("issue_description")
  evidenceUrls    String[]            @map("evidence_urls")   // صور/فيديو

  // Status
  status          WarrantyClaimStatus @default(PENDING)

  // Resolution
  resolutionType  String?             @map("resolution_type") // 'REPAIR', 'REPLACE', 'REFUND'
  resolutionNotes String?             @map("resolution_notes")
  resolvedAt      DateTime?           @map("resolved_at")
  resolvedBy      String?             @map("resolved_by")

  // Refund/Replacement
  refundAmount    Float?              @map("refund_amount")
  replacementItemId String?           @map("replacement_item_id")

  // Communication
  messages        Json?               // Array of messages

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  warranty        Warranty            @relation(fields: [warrantyId], references: [id], onDelete: Cascade)

  @@map("warranty_claims")
  @@index([warrantyId])
  @@index([claimantId])
  @@index([status])
}

// ============================================
// Seller Verification System
// نظام التحقق من البائعين
// ============================================

enum VerificationLevel {
  UNVERIFIED      // غير موثق
  BASIC           // أساسي (بريد إلكتروني + هاتف)
  VERIFIED        // موثق (هوية)
  BUSINESS        // تجاري (سجل تجاري)
  PREMIUM         // مميز (فحص شامل)
  TRUSTED         // موثوق (شريك المنصة)
}

enum VerificationStatus {
  PENDING         // قيد المراجعة
  APPROVED        // مقبول
  REJECTED        // مرفوض
  EXPIRED         // منتهي
  REVOKED         // ملغي
}

model SellerVerification {
  id              String              @id @default(uuid())
  userId          String              @map("user_id")

  // Current level
  currentLevel    VerificationLevel   @default(UNVERIFIED) @map("current_level")
  requestedLevel  VerificationLevel   @map("requested_level")

  // Status
  status          VerificationStatus  @default(PENDING)

  // Documents submitted
  documents       Json                // Array of document info

  // Identity verification
  idType          String?             @map("id_type")         // 'NATIONAL_ID', 'PASSPORT'
  idNumber        String?             @map("id_number")
  idFrontUrl      String?             @map("id_front_url")
  idBackUrl       String?             @map("id_back_url")
  selfieUrl       String?             @map("selfie_url")

  // Business verification
  businessName    String?             @map("business_name")
  commercialRegNo String?             @map("commercial_reg_no")
  taxId           String?             @map("tax_id")
  businessDocUrl  String?             @map("business_doc_url")

  // Address verification
  addressProofUrl String?             @map("address_proof_url")
  verifiedAddress String?             @map("verified_address")

  // Review
  reviewedAt      DateTime?           @map("reviewed_at")
  reviewedBy      String?             @map("reviewed_by")
  reviewNotes     String?             @map("review_notes")
  rejectionReason String?             @map("rejection_reason")

  // Validity
  validFrom       DateTime?           @map("valid_from")
  validUntil      DateTime?           @map("valid_until")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@map("seller_verifications")
  @@index([userId])
  @@index([currentLevel])
  @@index([status])
  @@index([validUntil])
}

// Verification badges earned by users
model VerificationBadge {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")

  // Badge info
  badgeType       String      @map("badge_type")     // 'ID_VERIFIED', 'PHONE_VERIFIED', 'ADDRESS_VERIFIED', 'BUSINESS_VERIFIED'
  badgeName       String      @map("badge_name")
  badgeNameAr     String      @map("badge_name_ar")
  badgeIcon       String?     @map("badge_icon")

  // Validity
  earnedAt        DateTime    @default(now()) @map("earned_at")
  expiresAt       DateTime?   @map("expires_at")
  isActive        Boolean     @default(true) @map("is_active")

  // Metadata
  metadata        Json?

  @@map("verification_badges")
  @@unique([userId, badgeType])
  @@index([userId])
  @@index([badgeType])
  @@index([isActive])
}

// ============================================
// Product Authenticity System
// نظام أصالة المنتجات
// ============================================

enum AuthenticityStatus {
  PENDING         // قيد التحقق
  VERIFIED        // أصلي موثق
  SUSPICIOUS      // مشتبه به
  COUNTERFEIT     // مقلد
  INCONCLUSIVE    // غير حاسم
}

model ProductAuthenticity {
  id              String              @id @default(uuid())
  itemId          String              @unique @map("item_id")
  sellerId        String              @map("seller_id")

  // Request info
  requestedAt     DateTime            @default(now()) @map("requested_at")
  requestedBy     String              @map("requested_by")

  // Status
  status          AuthenticityStatus  @default(PENDING)

  // Verification method
  method          String              // 'SERIAL_CHECK', 'EXPERT_REVIEW', 'DOCUMENT_VERIFY', 'AI_ANALYSIS'

  // Evidence submitted
  serialNumber    String?             @map("serial_number")
  purchaseReceipt String?             @map("purchase_receipt")
  originalBox     Boolean             @default(false) @map("original_box")
  warrantyCard    Boolean             @default(false) @map("warranty_card")
  evidenceUrls    String[]            @map("evidence_urls")

  // Verification result
  verifiedAt      DateTime?           @map("verified_at")
  verifiedBy      String?             @map("verified_by")    // User ID or 'SYSTEM'
  verifierNotes   String?             @map("verifier_notes")
  confidenceScore Float?              @map("confidence_score") // 0-100

  // Certificate
  certificateId   String?             @unique @map("certificate_id")
  certificateUrl  String?             @map("certificate_url")
  qrCode          String?             @map("qr_code")

  // Display
  showBadge       Boolean             @default(true) @map("show_badge")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@map("product_authenticity")
  @@index([itemId])
  @@index([sellerId])
  @@index([status])
  @@index([certificateId])
}

// Authenticity reports from users
model AuthenticityReport {
  id              String      @id @default(uuid())
  itemId          String      @map("item_id")
  reporterId      String      @map("reporter_id")

  // Report details
  reportType      String      @map("report_type")     // 'COUNTERFEIT', 'MISREPRESENTED', 'SUSPICIOUS'
  description     String
  evidenceUrls    String[]    @map("evidence_urls")

  // Status
  status          String      @default("PENDING")     // 'PENDING', 'INVESTIGATING', 'RESOLVED', 'DISMISSED'
  resolution      String?
  resolvedAt      DateTime?   @map("resolved_at")
  resolvedBy      String?     @map("resolved_by")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("authenticity_reports")
  @@index([itemId])
  @@index([reporterId])
  @@index([status])
}

// ============================================
// AI Assistant System
// نظام المساعد الذكي
// ============================================

enum AIConversationStatus {
  ACTIVE          // نشطة
  CLOSED          // مغلقة
  ARCHIVED        // مؤرشفة
}

enum AIMessageRole {
  USER            // رسالة المستخدم
  ASSISTANT       // رد المساعد
  SYSTEM          // رسالة نظام
}

model AIConversation {
  id              String                @id @default(uuid())
  userId          String                @map("user_id")

  // Conversation details
  title           String?
  context         String?               // barter, search, help
  status          AIConversationStatus  @default(ACTIVE)

  // Related entities
  relatedItemId   String?               @map("related_item_id")
  relatedOfferId  String?               @map("related_offer_id")

  // Stats
  messageCount    Int                   @default(0) @map("message_count")

  // Timestamps
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  lastMessageAt   DateTime?             @map("last_message_at")

  // Relations
  messages        AIMessage[]

  @@map("ai_conversations")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model AIMessage {
  id              String          @id @default(uuid())
  conversationId  String          @map("conversation_id")

  // Message details
  role            AIMessageRole
  content         String          @db.Text
  metadata        Json?

  // AI-specific
  model           String?
  tokens          Int?
  confidence      Float?

  // Actions suggested
  suggestedItems  String[]        @map("suggested_items")
  suggestedAction String?         @map("suggested_action")

  // Timestamps
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  conversation    AIConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("ai_messages")
  @@index([conversationId])
  @@index([createdAt])
}

// ============================================
// AI Listing Generator
// مولد الإعلانات بالذكاء الاصطناعي
// ============================================

model AIListingDraft {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")

  // Source
  sourceType      String      @map("source_type")   // IMAGE, VOICE, TEXT
  sourceUrl       String?     @map("source_url")
  sourceText      String?     @map("source_text")

  // AI Generated content
  generatedTitle  String?     @map("generated_title")
  generatedDesc   String?     @map("generated_desc") @db.Text
  generatedCategory String?   @map("generated_category")
  generatedTags   String[]    @map("generated_tags")
  estimatedPrice  Float?      @map("estimated_price")
  confidence      Float?

  // Detected attributes
  detectedBrand   String?     @map("detected_brand")
  detectedModel   String?     @map("detected_model")
  detectedCondition String?   @map("detected_condition")
  detectedColor   String?     @map("detected_color")

  // Status
  status          String      @default("DRAFT")     // DRAFT, PUBLISHED, DISCARDED
  publishedItemId String?     @map("published_item_id")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@map("ai_listing_drafts")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// Exchange Points System
// نظام نقاط التبادل الآمنة
// ============================================

enum ExchangePointType {
  XCHANGE_HUB     // مركز XChange
  PARTNER_STORE   // متجر شريك
  POLICE_STATION  // قسم شرطة
  MALL            // مول تجاري
  COFFEE_SHOP     // كافيه
  BANK            // بنك
}

enum ExchangePointStatus {
  ACTIVE
  INACTIVE
  TEMPORARILY_CLOSED
  COMING_SOON
}

model ExchangePoint {
  id              String              @id @default(uuid())

  // Basic info
  name            String
  nameAr          String              @map("name_ar")
  description     String?
  descriptionAr   String?             @map("description_ar")
  type            ExchangePointType

  // Location
  governorate     String
  city            String
  area            String?
  address         String
  addressAr       String?             @map("address_ar")
  latitude        Float
  longitude       Float
  googleMapsUrl   String?             @map("google_maps_url")

  // Contact
  phone           String?
  whatsapp        String?

  // Working hours
  workingHours    Json                @map("working_hours")
  is24Hours       Boolean             @default(false) @map("is_24_hours")

  // Facilities
  hasParking      Boolean             @default(false) @map("has_parking")
  hasCCTV         Boolean             @default(true) @map("has_cctv")
  hasWifi         Boolean             @default(false) @map("has_wifi")
  hasWaitingArea  Boolean             @default(true) @map("has_waiting_area")
  hasInspection   Boolean             @default(false) @map("has_inspection")

  // Media
  images          String[]
  coverImage      String?             @map("cover_image")

  // Status
  status          ExchangePointStatus @default(ACTIVE)
  verifiedAt      DateTime?           @map("verified_at")

  // Stats
  totalExchanges  Int                 @default(0) @map("total_exchanges")
  avgRating       Float               @default(0) @map("avg_rating")
  ratingCount     Int                 @default(0) @map("rating_count")

  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  bookings        ExchangeBooking[]
  reviews         ExchangePointReview[]

  @@map("exchange_points")
  @@index([governorate])
  @@index([type])
  @@index([status])
  @@index([latitude, longitude])
}

enum ExchangeBookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model ExchangeBooking {
  id              String                @id @default(uuid())
  pointId         String                @map("point_id")

  // Parties
  user1Id         String                @map("user1_id")
  user2Id         String                @map("user2_id")

  // Related transaction
  transactionType String                @map("transaction_type")
  transactionId   String?               @map("transaction_id")
  offerId         String?               @map("offer_id")

  // Booking details
  scheduledDate   DateTime              @map("scheduled_date")
  scheduledTime   String                @map("scheduled_time")
  duration        Int                   @default(30)

  // Status
  status          ExchangeBookingStatus @default(PENDING)
  confirmedByUser1 Boolean              @default(false) @map("confirmed_by_user1")
  confirmedByUser2 Boolean              @default(false) @map("confirmed_by_user2")

  // Check-in
  user1CheckedIn  DateTime?             @map("user1_checked_in")
  user2CheckedIn  DateTime?             @map("user2_checked_in")

  // Completion
  completedAt     DateTime?             @map("completed_at")
  completionNotes String?               @map("completion_notes")

  // Cancellation
  cancelledAt     DateTime?             @map("cancelled_at")
  cancelledBy     String?               @map("cancelled_by")
  cancelReason    String?               @map("cancel_reason")

  // Timestamps
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  point           ExchangePoint         @relation(fields: [pointId], references: [id], onDelete: Cascade)

  @@map("exchange_bookings")
  @@index([pointId])
  @@index([user1Id])
  @@index([user2Id])
  @@index([scheduledDate])
  @@index([status])
}

model ExchangePointReview {
  id              String        @id @default(uuid())
  pointId         String        @map("point_id")
  userId          String        @map("user_id")
  bookingId       String?       @map("booking_id")

  // Rating
  rating          Int
  safetyRating    Int?          @map("safety_rating")
  cleanlinessRating Int?        @map("cleanliness_rating")
  accessibilityRating Int?      @map("accessibility_rating")

  // Review
  comment         String?

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  point           ExchangePoint @relation(fields: [pointId], references: [id], onDelete: Cascade)

  @@map("exchange_point_reviews")
  @@unique([pointId, userId, bookingId])
  @@index([pointId])
  @@index([userId])
}

// ============================================
// Search Alerts System
// نظام تنبيهات البحث
// ============================================

model SearchAlert {
  id              String      @id @default(uuid())
  savedSearchId   String      @map("saved_search_id")
  userId          String      @map("user_id")

  // Alert settings
  isActive        Boolean     @default(true) @map("is_active")
  frequency       String      @default("INSTANT") // INSTANT, DAILY, WEEKLY

  // Notification channels
  notifyPush      Boolean     @default(true) @map("notify_push")
  notifyEmail     Boolean     @default(false) @map("notify_email")
  notifyWhatsapp  Boolean     @default(false) @map("notify_whatsapp")

  // Stats
  alertsSent      Int         @default(0) @map("alerts_sent")
  lastAlertAt     DateTime?   @map("last_alert_at")
  matchedItems    Int         @default(0) @map("matched_items")

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  savedSearch     SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)
  user            User        @relation("UserSearchAlerts", fields: [userId], references: [id], onDelete: Cascade)

  @@map("search_alerts")
  @@unique([savedSearchId, userId])
  @@index([userId])
  @@index([isActive])
}

// ============================================
// سوق التوالف - Scrap Marketplace Models
// ============================================

// تحقق تجار التوالف
// Scrap Dealer Verification
model ScrapDealerVerification {
  id                  String              @id @default(uuid())
  userId              String              @unique @map("user_id")
  dealerType          ScrapDealerType     @map("dealer_type")

  // معلومات النشاط التجاري
  businessName        String?             @map("business_name")
  commercialRegNo     String?             @map("commercial_reg_no")
  taxCardNo           String?             @map("tax_card_no")
  recyclingLicenseNo  String?             @map("recycling_license_no")

  // الموقع
  address             String?
  governorate         String?
  city                String?
  latitude            Float?
  longitude           Float?

  // التخصص
  specializations     ScrapType[]
  acceptedMetals      MetalType[]         @map("accepted_metals")
  minWeightKg         Float               @default(0) @map("min_weight_kg")
  maxWeightKg         Float?              @map("max_weight_kg")

  // التسعير والخدمات
  priceList           Json?               @map("price_list")  // قائمة أسعار المعادن/المواد
  offersPickup        Boolean             @default(false) @map("offers_pickup")
  pickupFee           Float               @default(0) @map("pickup_fee")
  pickupRadiusKm      Int                 @default(0) @map("pickup_radius_km")

  // المستندات
  idDocumentUrl       String?             @map("id_document_url")
  commercialRegUrl    String?             @map("commercial_reg_url")
  taxCardUrl          String?             @map("tax_card_url")
  recyclingLicenseUrl String?             @map("recycling_license_url")
  locationPhotos      String[]            @map("location_photos")

  // التحقق والتقييم
  status              ScrapDealerStatus   @default(PENDING)
  isVerified          Boolean             @default(false) @map("is_verified")
  verifiedAt          DateTime?           @map("verified_at")
  verifiedById        String?             @map("verified_by_id")
  rejectionReason     String?             @map("rejection_reason")

  // الإحصائيات
  rating              Float               @default(0)
  totalReviews        Int                 @default(0) @map("total_reviews")
  totalTransactions   Int                 @default(0) @map("total_transactions")
  totalWeightBoughtKg Float               @default(0) @map("total_weight_bought_kg")

  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  user                User                @relation("ScrapDealerUser", fields: [userId], references: [id], onDelete: Cascade)
  verifiedBy          User?               @relation("ScrapDealerVerifier", fields: [verifiedById], references: [id], onDelete: SetNull)

  @@map("scrap_dealer_verifications")
  @@index([userId])
  @@index([governorate])
  @@index([isVerified])
  @@index([status])
  @@index([dealerType])
}

// أسعار المعادن اليومية
// Daily Metal Prices
model MetalPrice {
  id              String      @id @default(uuid())
  metalType       MetalType   @map("metal_type")
  pricePerKg      Float       @map("price_per_kg")
  currency        String      @default("EGP")
  source          String?     // مصدر السعر
  date            DateTime    @db.Date

  // Timestamps
  createdAt       DateTime    @default(now()) @map("created_at")

  @@map("metal_prices")
  @@unique([metalType, date])
  @@index([date])
  @@index([metalType])
}

// طلبات شراء التوالف (مزاد عكسي)
// Scrap Purchase Requests (Reverse Auction)
model ScrapPurchaseRequest {
  id                  String              @id @default(uuid())
  buyerId             String              @map("buyer_id")

  // تفاصيل الطلب
  title               String
  description         String?
  scrapType           ScrapType           @map("scrap_type")
  metalType           MetalType?          @map("metal_type")
  minWeightKg         Float?              @map("min_weight_kg")
  maxWeightKg         Float?              @map("max_weight_kg")
  scrapCondition      ScrapCondition?     @map("scrap_condition")

  // السعر
  offeredPricePerKg   Float?              @map("offered_price_per_kg")
  offeredTotalPrice   Float?              @map("offered_total_price")
  isNegotiable        Boolean             @default(true) @map("is_negotiable")

  // الموقع والتوصيل
  governorate         String?
  city                String?
  offersPickup        Boolean             @default(false) @map("offers_pickup")
  pickupAddress       String?             @map("pickup_address")

  // المدة
  expiresAt           DateTime?           @map("expires_at")
  status              String              @default("ACTIVE")

  // الإحصائيات
  viewsCount          Int                 @default(0) @map("views_count")
  offersCount         Int                 @default(0) @map("offers_count")

  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  buyer               User                @relation("ScrapPurchaseBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  sellerOffers        ScrapSellerOffer[]

  @@map("scrap_purchase_requests")
  @@index([buyerId])
  @@index([status])
  @@index([scrapType])
  @@index([governorate])
  @@index([expiresAt])
}

// عروض البائعين على طلبات الشراء
// Seller Offers on Purchase Requests
model ScrapSellerOffer {
  id                  String              @id @default(uuid())
  requestId           String              @map("request_id")
  sellerId            String              @map("seller_id")
  itemId              String?             @map("item_id")

  // تفاصيل العرض
  offeredWeightKg     Float               @map("offered_weight_kg")
  offeredPricePerKg   Float?              @map("offered_price_per_kg")
  offeredTotalPrice   Float               @map("offered_total_price")
  message             String?
  photos              String[]

  // الحالة
  status              String              @default("PENDING")
  rejectionReason     String?             @map("rejection_reason")

  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  request             ScrapPurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  seller              User                @relation("ScrapSellerOffers", fields: [sellerId], references: [id], onDelete: Cascade)
  item                Item?               @relation("ScrapOfferItem", fields: [itemId], references: [id], onDelete: SetNull)

  @@map("scrap_seller_offers")
  @@unique([requestId, sellerId])
  @@index([requestId])
  @@index([sellerId])
  @@index([status])
}

// ============================================
// Admin System - نظام الإدارة
// ============================================

enum AdminRole {
  SUPER_ADMIN   // مدير النظام الأعلى - كل الصلاحيات
  ADMIN         // مدير - معظم الصلاحيات
  MODERATOR     // مشرف - صلاحيات محدودة
  SUPPORT       // دعم فني - صلاحيات الدعم فقط
}

enum AdminStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Admin {
  id                String        @id @default(uuid())
  email             String        @unique
  passwordHash      String        @map("password_hash")
  fullName          String        @map("full_name")
  phone             String?
  avatar            String?
  role              AdminRole     @default(MODERATOR)
  status            AdminStatus   @default(ACTIVE)

  // الصلاحيات المخصصة (تتجاوز صلاحيات الدور الافتراضية)
  customPermissions String[]      @default([]) @map("custom_permissions")

  // معلومات الأمان
  lastLoginAt       DateTime?     @map("last_login_at")
  lastLoginIp       String?       @map("last_login_ip")
  failedLoginAttempts Int         @default(0) @map("failed_login_attempts")
  lockedUntil       DateTime?     @map("locked_until")

  // المصادقة الثنائية
  twoFactorEnabled  Boolean       @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?       @map("two_factor_secret")

  // Timestamps
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  createdBy         String?       @map("created_by")

  // Relations
  refreshTokens     AdminRefreshToken[]
  activityLogs      AdminActivityLog[]

  @@map("admins")
  @@index([email])
  @@index([role])
  @@index([status])
}

model AdminRefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  adminId     String    @map("admin_id")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")

  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_refresh_tokens")
  @@index([adminId])
  @@index([expiresAt])
}

// سجل نشاط المديرين - Admin Activity Log
model AdminActivityLog {
  id          String    @id @default(uuid())
  adminId     String    @map("admin_id")
  action      String    // نوع الإجراء (user_suspend, listing_delete, setting_change, etc.)
  targetType  String?   @map("target_type") // نوع الهدف (user, listing, order, etc.)
  targetId    String?   @map("target_id")   // معرف الهدف
  details     Json?     // تفاصيل إضافية
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  createdAt   DateTime  @default(now()) @map("created_at")

  admin       Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_activity_logs")
  @@index([adminId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// إعدادات المنصة - Platform Settings
model PlatformSetting {
  id          String    @id @default(uuid())
  key         String    @unique
  value       Json      // القيمة (يمكن أن تكون نص، رقم، كائن، الخ)
  category    String    // تصنيف الإعداد (general, payment, notification, etc.)
  description String?   // وصف الإعداد
  isPublic    Boolean   @default(false) @map("is_public") // هل يمكن الوصول إليه من الواجهة
  updatedAt   DateTime  @updatedAt @map("updated_at")
  updatedBy   String?   @map("updated_by")

  @@map("platform_settings")
  @@index([category])
  @@index([key])
}

// تقارير المحتوى - Content Reports
model ContentReport {
  id          String    @id @default(uuid())
  reporterId  String    @map("reporter_id")
  targetType  String    @map("target_type") // listing, user, review, message
  targetId    String    @map("target_id")
  reason      String    // سبب البلاغ
  description String?   // تفاصيل إضافية
  status      String    @default("PENDING") // PENDING, REVIEWING, RESOLVED, DISMISSED
  resolution  String?   // قرار الإدارة
  resolvedBy  String?   @map("resolved_by")
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("content_reports")
  @@index([status])
  @@index([targetType, targetId])
  @@index([reporterId])
  @@index([createdAt])
}

// إحصائيات المنصة اليومية - Daily Platform Statistics
model DailyStats {
  id                  String    @id @default(uuid())
  date                DateTime  @db.Date @unique

  // المستخدمون
  newUsers            Int       @default(0) @map("new_users")
  activeUsers         Int       @default(0) @map("active_users")
  totalUsers          Int       @default(0) @map("total_users")

  // المنتجات والإعلانات
  newListings         Int       @default(0) @map("new_listings")
  activeListings      Int       @default(0) @map("active_listings")

  // المعاملات
  completedOrders     Int       @default(0) @map("completed_orders")
  totalOrdersValue    Float     @default(0) @map("total_orders_value")

  // المقايضات
  barterOffers        Int       @default(0) @map("barter_offers")
  completedBarters    Int       @default(0) @map("completed_barters")

  // المزادات
  newAuctions         Int       @default(0) @map("new_auctions")
  auctionBids         Int       @default(0) @map("auction_bids")

  // التبرعات
  donationsCount      Int       @default(0) @map("donations_count")
  donationsValue      Float     @default(0) @map("donations_value")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@map("daily_stats")
  @@index([date])
}

// ============================================
// مقارنة السيارات - Item Comparison
// ============================================

model ItemComparison {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  title           String?
  itemIds         String[]  @map("item_ids")
  categorySlug    String?   @map("category_slug")

  isPublic        Boolean   @default(false) @map("is_public")
  shareCode       String?   @unique @map("share_code")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("item_comparisons")
  @@index([userId])
  @@index([shareCode])
}

// ============================================
// حجز التوصيل - Delivery Booking
// ============================================

enum DeliveryBookingStatus {
  PENDING
  CONFIRMED
  PICKED_UP
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  CANCELLED
  RETURNED
}

model DeliveryBooking {
  id              String              @id @default(uuid())
  orderId         String?             @map("order_id")
  transactionId   String?             @map("transaction_id")
  senderId        String              @map("sender_id")
  receiverId      String              @map("receiver_id")

  provider        DeliveryProvider
  providerOrderId String?             @map("provider_order_id")

  pickupAddress   String              @map("pickup_address")
  pickupCity      String              @map("pickup_city")
  pickupGovernorate String            @map("pickup_governorate")
  pickupPhone     String              @map("pickup_phone")
  pickupLat       Float?              @map("pickup_lat")
  pickupLng       Float?              @map("pickup_lng")

  deliveryAddress String              @map("delivery_address")
  deliveryCity    String              @map("delivery_city")
  deliveryGovernorate String          @map("delivery_governorate")
  deliveryPhone   String              @map("delivery_phone")
  deliveryLat     Float?              @map("delivery_lat")
  deliveryLng     Float?              @map("delivery_lng")

  packageWeight   Float?              @map("package_weight")
  packageDimensions Json?             @map("package_dimensions")
  packageDescription String?          @map("package_description")
  isFragile       Boolean             @default(false) @map("is_fragile")

  deliveryCost    Float               @map("delivery_cost")
  insuranceCost   Float?              @map("insurance_cost")
  codAmount       Float?              @map("cod_amount")
  totalCost       Float               @map("total_cost")

  deliverySpeed   DeliverySpeed?      @map("delivery_speed")
  hasInsurance    Boolean             @default(false) @map("has_insurance")
  isCOD           Boolean             @default(false) @map("is_cod")

  status          DeliveryBookingStatus @default(PENDING)
  trackingNumber  String?             @map("tracking_number")
  trackingUrl     String?             @map("tracking_url")

  estimatedDelivery DateTime?         @map("estimated_delivery")
  pickedUpAt      DateTime?           @map("picked_up_at")
  deliveredAt     DateTime?           @map("delivered_at")

  senderNotes     String?             @map("sender_notes")
  driverNotes     String?             @map("driver_notes")

  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  trackingHistory DeliveryTracking[]

  @@map("delivery_bookings")
  @@index([orderId])
  @@index([senderId])
  @@index([status])
  @@index([trackingNumber])
}

model DeliveryTracking {
  id              String    @id @default(uuid())
  bookingId       String    @map("booking_id")
  status          String
  location        String?
  description     String?
  timestamp       DateTime  @default(now())

  booking         DeliveryBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("delivery_tracking")
  @@index([bookingId])
}

// ============================================
// شارات المستخدم - User Badges
// ============================================

model UserBadge {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  badgeType       BadgeType @map("badge_type")
  verifiedAt      DateTime? @map("verified_at")
  verifiedBy      String?   @map("verified_by")
  documentUrls    String[]  @map("document_urls")
  verificationData Json?    @map("verification_data")
  isActive        Boolean   @default(true) @map("is_active")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("user_badges")
  @@unique([userId, badgeType])
  @@index([userId])
  @@index([badgeType])
  @@index([isActive])
}

// ============================================
// طلبات التقسيط - Installment Requests
// ============================================

model InstallmentRequest {
  id              String              @id @default(uuid())
  userId          String              @map("user_id")
  itemId          String              @map("item_id")
  orderId         String?             @map("order_id")
  provider        InstallmentProvider
  totalAmount     Float               @map("total_amount")
  downPayment     Float               @map("down_payment")
  installmentAmount Float             @map("installment_amount")
  numberOfMonths  Int                 @map("number_of_months")
  interestRate    Float?              @map("interest_rate")
  nationalId      String?             @map("national_id")
  phoneNumber     String              @map("phone_number")
  monthlyIncome   Float?              @map("monthly_income")
  employerName    String?             @map("employer_name")
  status          InstallmentStatus   @default(PENDING)
  providerRef     String?             @map("provider_ref")
  approvedAmount  Float?              @map("approved_amount")
  rejectionReason String?             @map("rejection_reason")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  approvedAt      DateTime?           @map("approved_at")

  @@map("installment_requests")
  @@index([userId])
  @@index([itemId])
  @@index([status])
}

// ============================================
// المزادات الحية - Live Auctions
// ============================================

enum LiveAuctionStatus {
  SCHEDULED
  LIVE
  PAUSED
  ENDED
  CANCELLED
}

model LiveAuction {
  id              String            @id @default(uuid())
  listingId       String            @map("listing_id")
  hostId          String            @map("host_id")
  title           String
  description     String?
  thumbnailUrl    String?           @map("thumbnail_url")
  scheduledStart  DateTime          @map("scheduled_start")
  scheduledEnd    DateTime?         @map("scheduled_end")
  actualStart     DateTime?         @map("actual_start")
  actualEnd       DateTime?         @map("actual_end")
  streamUrl       String?           @map("stream_url")
  streamKey       String?           @map("stream_key")
  viewerCount     Int               @default(0) @map("viewer_count")
  peakViewers     Int               @default(0) @map("peak_viewers")
  currentBid      Float?            @map("current_bid")
  currentBidderId String?           @map("current_bidder_id")
  totalBids       Int               @default(0) @map("total_bids")
  status          LiveAuctionStatus @default(SCHEDULED)
  recordingUrl    String?           @map("recording_url")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  chatMessages    LiveAuctionChat[]

  @@map("live_auctions")
  @@index([listingId])
  @@index([hostId])
  @@index([status])
  @@index([scheduledStart])
}

model LiveAuctionChat {
  id              String    @id @default(uuid())
  auctionId       String    @map("auction_id")
  userId          String    @map("user_id")
  userName        String    @map("user_name")
  message         String
  messageType     String    @default("TEXT") @map("message_type")
  timestamp       DateTime  @default(now())

  auction         LiveAuction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@map("live_auction_chat")
  @@index([auctionId])
}

// ============================================
// اقتراحات المقايضة الذكية - AI Barter Suggestions
// ============================================

model BarterSuggestion {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  userItemId      String    @map("user_item_id")
  suggestedItemId String    @map("suggested_item_id")
  matchScore      Float     @map("match_score")
  matchReasons    String[]  @map("match_reasons")
  valueMatch      Float     @map("value_match")
  categoryMatch   Float     @map("category_match")
  locationMatch   Float     @map("location_match")
  isViewed        Boolean   @default(false) @map("is_viewed")
  isAccepted      Boolean?  @map("is_accepted")
  feedback        String?
  createdAt       DateTime  @default(now()) @map("created_at")
  viewedAt        DateTime? @map("viewed_at")
  respondedAt     DateTime? @map("responded_at")

  @@map("barter_suggestions")
  @@index([userId])
  @@index([userItemId])
  @@index([matchScore])
}

// ============================================
// شراكات إعادة التدوير - Recycling Partnerships
// ============================================

enum RecyclingPartnerType {
  RECYCLING_CENTER
  SCRAP_FACTORY
  EXPORT_COMPANY
  CHARITY
  GOVERNMENT
}

enum PartnershipStatus {
  PENDING
  ACTIVE
  SUSPENDED
  TERMINATED
}

model RecyclingPartner {
  id              String              @id @default(uuid())
  name            String
  nameAr          String              @map("name_ar")
  type            RecyclingPartnerType
  description     String?
  email           String
  phone           String
  website         String?
  address         String
  city            String
  governorate     String
  latitude        Float?
  longitude       Float?
  acceptedMaterials String[]          @map("accepted_materials")
  minQuantityKg   Float?              @map("min_quantity_kg")
  maxQuantityKg   Float?              @map("max_quantity_kg")
  pickupAvailable Boolean             @default(false) @map("pickup_available")
  priceRanges     Json?               @map("price_ranges")
  licenseNumber   String?             @map("license_number")
  licenseExpiry   DateTime?           @map("license_expiry")
  isVerified      Boolean             @default(false) @map("is_verified")
  status          PartnershipStatus   @default(PENDING)
  rating          Float               @default(0)
  reviewCount     Int                 @default(0) @map("review_count")
  documents       String[]
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@map("recycling_partners")
  @@index([type])
  @@index([governorate])
  @@index([status])
}

// ============================================
// شهادات الوسطاء المعتمدين - Facilitator Certifications
// ============================================

enum CertificationLevel {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum CertificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  REVOKED
}

model FacilitatorCertification {
  id              String              @id @default(uuid())
  facilitatorId   String              @map("facilitator_id")
  level           CertificationLevel  @default(BRONZE)
  specialization  String[]
  completedDeals  Int                 @map("completed_deals")
  totalValue      Float               @map("total_value")
  avgRating       Float               @map("avg_rating")
  trainingCompleted Boolean           @default(false) @map("training_completed")
  examPassed      Boolean             @default(false) @map("exam_passed")
  documentsSubmitted String[]         @map("documents_submitted")
  backgroundCheck Boolean             @default(false) @map("background_check")
  identityVerified Boolean            @default(false) @map("identity_verified")
  status          CertificationStatus @default(PENDING)
  issuedAt        DateTime?           @map("issued_at")
  expiresAt       DateTime?           @map("expires_at")
  renewalDate     DateTime?           @map("renewal_date")
  certificateNumber String?           @unique @map("certificate_number")
  certificateUrl  String?             @map("certificate_url")
  reviewedBy      String?             @map("reviewed_by")
  reviewNotes     String?             @map("review_notes")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@map("facilitator_certifications")
  @@index([facilitatorId])
  @@index([level])
  @@index([status])
}

// ============================================
// 🏆 سوق الذهب - Gold Marketplace
// ============================================

enum GoldKarat {
  K18   // عيار 18
  K21   // عيار 21
  K24   // عيار 24
}

enum GoldItemCategory {
  RING          // خاتم
  NECKLACE      // سلسلة/عقد
  BRACELET      // إسورة
  EARRING       // حلق
  SET           // طقم كامل
  PENDANT       // تعليقة
  ANKLET        // خلخال
  COIN          // جنيه ذهب
  BAR           // سبيكة
  OTHER         // أخرى
}

enum GoldItemCondition {
  NEW           // جديد (لم يُلبس)
  LIKE_NEW      // كالجديد
  GOOD          // جيد
  FAIR          // مقبول
}

enum GoldVerificationLevel {
  BASIC         // أساسي (صور فقط)
  VERIFIED      // موثق (بائع موثوق)
  CERTIFIED     // معتمد (فحص صائغ)
}

enum GoldListingStatus {
  ACTIVE        // نشط
  RESERVED      // محجوز
  SOLD          // مباع
  EXPIRED       // منتهي
  CANCELLED     // ملغي
}

enum GoldTransactionStatus {
  PENDING       // في انتظار الدفع
  ESCROW_HELD   // المبلغ محجوز
  DELIVERED     // تم التسليم
  INSPECTING    // فترة الفحص
  COMPLETED     // مكتمل
  DISPUTED      // نزاع
  REFUNDED      // مسترد
  CANCELLED     // ملغي
}

enum GoldDeliveryMethod {
  MEETUP        // تسليم شخصي
  SHIPPING      // شحن
  PARTNER_PICKUP // استلام من صائغ شريك
}

// أسعار الذهب اللحظية
model GoldPrice {
  id            String      @id @default(uuid())
  karat         GoldKarat
  buyPrice      Float       @map("buy_price")      // سعر الشراء (البورصة)
  sellPrice     Float       @map("sell_price")     // سعر البيع
  timestamp     DateTime    @default(now())
  source        String?     // مصدر السعر (API, manual)

  @@map("gold_prices")
  @@index([karat, timestamp])
}

// قطع الذهب المعروضة
model GoldItem {
  id                  String                @id @default(uuid())
  sellerId            String                @map("seller_id")

  // معلومات القطعة
  title               String
  description         String?
  category            GoldItemCategory
  karat               GoldKarat
  weightGrams         Float                 @map("weight_grams")
  condition           GoldItemCondition     @default(GOOD)

  // الصور
  images              String[]

  // التسعير
  askingPricePerGram  Float                 @map("asking_price_per_gram")  // سعر البائع للجرام
  totalAskingPrice    Float                 @map("total_asking_price")     // السعر الإجمالي
  goldPriceAtListing  Float                 @map("gold_price_at_listing")  // سعر البورصة وقت الإضافة

  // الموقع
  governorate         String?
  city                String?

  // التحقق
  verificationLevel   GoldVerificationLevel @default(BASIC) @map("verification_level")
  certificateId       String?               @unique @map("certificate_id")

  // الحالة
  status              GoldListingStatus     @default(ACTIVE)
  views               Int                   @default(0)

  // ميزات إضافية
  isFeatured          Boolean               @default(false) @map("is_featured")
  allowBarter         Boolean               @default(false) @map("allow_barter")  // قابل للمقايضة
  barterDescription   String?               @map("barter_description")  // ما يقبله في المقايضة

  // الطوابع الزمنية
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  expiresAt           DateTime?             @map("expires_at")

  // العلاقات
  seller              User                  @relation("UserGoldItems", fields: [sellerId], references: [id], onDelete: Cascade)
  certificate         GoldCertificate?      @relation(fields: [certificateId], references: [id])
  transactions        GoldTransaction[]

  @@map("gold_items")
  @@index([sellerId])
  @@index([category])
  @@index([karat])
  @@index([status])
  @@index([governorate])
  @@index([verificationLevel])
  @@index([createdAt])
}

// معاملات الذهب
model GoldTransaction {
  id                  String                  @id @default(uuid())
  itemId              String                  @map("item_id")
  buyerId             String                  @map("buyer_id")
  sellerId            String                  @map("seller_id")

  // تفاصيل المعاملة
  goldPriceAtTransaction Float               @map("gold_price_at_transaction")  // سعر البورصة وقت المعاملة
  itemPrice           Float                   @map("item_price")                 // سعر القطعة
  buyerCommission     Float                   @map("buyer_commission")           // عمولة المشتري (0.7%)
  sellerCommission    Float                   @map("seller_commission")          // عمولة البائع (0.7%)
  totalAmount         Float                   @map("total_amount")               // المبلغ الإجمالي

  // حالة الضمان
  escrowStatus        String                  @default("PENDING") @map("escrow_status")
  escrowHeldAt        DateTime?               @map("escrow_held_at")
  escrowReleasedAt    DateTime?               @map("escrow_released_at")

  // التسليم
  deliveryMethod      GoldDeliveryMethod      @map("delivery_method")
  deliveryAddress     String?                 @map("delivery_address")
  deliveryPartnerId   String?                 @map("delivery_partner_id")  // صائغ شريك للاستلام

  // فترة الفحص
  inspectionStartedAt DateTime?               @map("inspection_started_at")
  inspectionEndsAt    DateTime?               @map("inspection_ends_at")

  // الحالة
  status              GoldTransactionStatus   @default(PENDING)

  // ملاحظات
  buyerNotes          String?                 @map("buyer_notes")
  sellerNotes         String?                 @map("seller_notes")
  disputeReason       String?                 @map("dispute_reason")

  // الطوابع الزمنية
  createdAt           DateTime                @default(now()) @map("created_at")
  updatedAt           DateTime                @updatedAt @map("updated_at")
  completedAt         DateTime?               @map("completed_at")

  // العلاقات
  item                GoldItem                @relation(fields: [itemId], references: [id])
  buyer               User                    @relation("UserGoldPurchases", fields: [buyerId], references: [id])
  seller              User                    @relation("UserGoldSales", fields: [sellerId], references: [id])
  deliveryPartner     GoldPartner?            @relation(fields: [deliveryPartnerId], references: [id])

  @@map("gold_transactions")
  @@index([itemId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
}

// شهادات فحص الذهب
model GoldCertificate {
  id                  String              @id @default(uuid())
  itemId              String              @unique @map("item_id")
  partnerId           String              @map("partner_id")

  // نتائج الفحص
  verifiedKarat       GoldKarat           @map("verified_karat")
  verifiedWeight      Float               @map("verified_weight")
  purityPercentage    Float               @map("purity_percentage")  // نسبة النقاء

  // الحالة
  isAuthentic         Boolean             @default(true) @map("is_authentic")
  notes               String?

  // رقم الشهادة
  certificateNumber   String              @unique @map("certificate_number")

  // الطوابع الزمنية
  issuedAt            DateTime            @default(now()) @map("issued_at")
  expiresAt           DateTime?           @map("expires_at")

  // العلاقات
  partner             GoldPartner         @relation(fields: [partnerId], references: [id])
  goldItem            GoldItem?

  @@map("gold_certificates")
  @@index([partnerId])
  @@index([certificateNumber])
}

// الصاغة الشركاء
model GoldPartner {
  id                  String              @id @default(uuid())

  // معلومات المحل
  name                String
  nameAr              String              @map("name_ar")
  description         String?
  logo                String?

  // الموقع
  governorate         String
  city                String
  address             String
  latitude            Float?
  longitude           Float?

  // التواصل
  phone               String
  whatsapp            String?
  email               String?

  // ساعات العمل
  workingHours        String?             @map("working_hours")

  // الخدمات
  offersCertification Boolean             @default(true) @map("offers_certification")   // يقدم فحص
  offersPickup        Boolean             @default(true) @map("offers_pickup")          // نقطة تسليم
  offersRepair        Boolean             @default(false) @map("offers_repair")         // إصلاح

  // الرسوم
  certificationFee    Float               @default(75) @map("certification_fee")        // رسوم الفحص

  // التقييم
  rating              Float               @default(0)
  totalReviews        Int                 @default(0) @map("total_reviews")
  totalCertifications Int                 @default(0) @map("total_certifications")

  // الحالة
  isActive            Boolean             @default(true) @map("is_active")
  isVerified          Boolean             @default(false) @map("is_verified")

  // الطوابع الزمنية
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // العلاقات
  certificates        GoldCertificate[]
  transactions        GoldTransaction[]

  @@map("gold_partners")
  @@index([governorate])
  @@index([isActive])
}

