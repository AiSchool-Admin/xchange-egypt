// Xchange Cars Marketplace - Complete Database Schema
// Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø© Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§ÙŠØ¶Ø© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ğŸ‘¤ USERS & AUTHENTICATION
// ============================================

enum UserRole {
  BUYER           // Ù…Ø´ØªØ±ÙŠ
  SELLER          // Ø¨Ø§Ø¦Ø¹
  DEALER          // ØªØ§Ø¬Ø±
  INSPECTOR       // ÙØ§Ø­Øµ
  ADMIN           // Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…
}

enum VerificationLevel {
  UNVERIFIED      // ØºÙŠØ± Ù…ÙˆØ«Ù‚
  PHONE_VERIFIED  // Ù…ÙˆØ«Ù‚ Ø¨Ø§Ù„Ù‡Ø§ØªÙ
  ID_VERIFIED     // Ù…ÙˆØ«Ù‚ Ø¨Ø§Ù„Ù‡ÙˆÙŠØ©
  TRUSTED         // Ù…ÙˆØ«ÙˆÙ‚
  PROFESSIONAL    // Ù…Ø­ØªØ±Ù (ØªØ§Ø¬Ø± Ù…Ø¹ØªÙ…Ø¯)
}

model User {
  id                String              @id @default(uuid())
  email             String?             @unique
  phone             String              @unique
  phoneVerified     Boolean             @default(false)
  password          String
  
  // Personal Info
  firstName         String
  lastName          String
  nationalId        String?             @unique  // Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
  dateOfBirth       DateTime?
  
  // Location
  governorate       String              // Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
  city              String              // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  address           String?
  latitude          Float?
  longitude         Float?
  
  // Verification
  role              UserRole            @default(BUYER)
  verificationLevel VerificationLevel   @default(UNVERIFIED)
  verifiedAt        DateTime?
  
  // Business Info (for dealers)
  businessName      String?
  taxId             String?             @unique  // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ
  commercialRegNo   String?             @unique  // Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ
  
  // Banking
  bankName          String?
  accountNumber     String?
  accountHolderName String?
  
  // Stats
  rating            Float               @default(0)
  totalReviews      Int                 @default(0)
  successfulSales   Int                 @default(0)
  successfulPurchases Int               @default(0)
  
  // Status
  isActive          Boolean             @default(true)
  isSuspended       Boolean             @default(false)
  suspensionReason  String?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  listings          Listing[]           @relation("SellerListings")
  purchases         Transaction[]       @relation("BuyerTransactions")
  sales             Transaction[]       @relation("SellerTransactions")
  inspections       Inspection[]        @relation("InspectorInspections")
  reviews           Review[]            @relation("ReviewAuthor")
  receivedReviews   Review[]            @relation("ReviewTarget")
  messages          Message[]
  notifications     Notification[]
  savedSearches     SavedSearch[]
  favoriteListings  FavoriteListing[]
  tradeInRequests   TradeInRequest[]
  barterOffers      BarterOffer[]       @relation("BarterInitiator")
  receivedBarterOffers BarterOffer[]    @relation("BarterReceiver")
  
  @@index([phone])
  @@index([email])
  @@index([verificationLevel])
}

// ============================================
// ğŸš— VEHICLE INFORMATION
// ============================================

enum VehicleCondition {
  NEW             // Ø¬Ø¯ÙŠØ¯Ø©
  USED_EXCELLENT  // Ù…Ø³ØªØ¹Ù…Ù„Ø© Ù…Ù…ØªØ§Ø²Ø© (A)
  USED_GOOD       // Ù…Ø³ØªØ¹Ù…Ù„Ø© Ø¬ÙŠØ¯Ø© (B)
  USED_FAIR       // Ù…Ø³ØªØ¹Ù…Ù„Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø© (C)
  USED_POOR       // Ù…Ø³ØªØ¹Ù…Ù„Ø© Ø¶Ø¹ÙŠÙØ© (D)
}

enum VehicleType {
  SEDAN           // Ø³ÙŠØ¯Ø§Ù†
  SUV             // Ø¯ÙØ¹ Ø±Ø¨Ø§Ø¹ÙŠ
  HATCHBACK       // Ù‡Ø§ØªØ´Ø¨Ø§Ùƒ
  COUPE           // ÙƒÙˆØ¨ÙŠÙ‡
  VAN             // ÙØ§Ù†
  PICKUP          // Ø¨ÙŠÙƒ Ø¢Ø¨
  MICROBUS        // Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ
}

enum FuelType {
  GASOLINE        // Ø¨Ù†Ø²ÙŠÙ†
  DIESEL          // Ø¯ÙŠØ²Ù„
  HYBRID          // Ù‡Ø¬ÙŠÙ†
  ELECTRIC        // ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ
  CNG             // ØºØ§Ø² Ø·Ø¨ÙŠØ¹ÙŠ
}

enum TransmissionType {
  MANUAL          // ÙŠØ¯ÙˆÙŠ
  AUTOMATIC       // Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
  CVT             // CVT
  SEMI_AUTOMATIC  // Ù†ØµÙ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
}

model Vehicle {
  id                String              @id @default(uuid())
  
  // Basic Info
  make              String              // Ø§Ù„Ù…Ø§Ø±ÙƒØ© (Toyota, Hyundai...)
  model             String              // Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Corolla, Elantra...)
  year              Int                 // Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹
  vin               String?             @unique  // Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠÙ‡
  
  // Technical Specs
  vehicleType       VehicleType
  fuelType          FuelType
  transmissionType  TransmissionType
  engineSize        Float               // Ø­Ø¬Ù… Ø§Ù„Ù…Ø­Ø±Ùƒ (Ù„ØªØ±)
  cylinders         Int?                // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·ÙˆØ§Ù†Ø§Øª
  horsepower        Int?                // Ø§Ù„Ù‚ÙˆØ© Ø§Ù„Ø­ØµØ§Ù†ÙŠØ©
  
  // Features
  color             String
  seatingCapacity   Int                 // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯
  doors             Int                 // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨
  
  // Condition
  condition         VehicleCondition
  mileage           Int                 // Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
  previousOwners    Int                 @default(1)  // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§Ù„ÙƒÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†
  
  // Manufacturing
  manufacturedIn    String?             // Ø¨Ù„Ø¯ Ø§Ù„ØµÙ†Ø¹
  assembledInEgypt  Boolean             @default(false)  // Ù…Ø¬Ù…Ø¹Ø© ÙÙŠ Ù…ØµØ±
  
  // Status
  hasAccidents      Boolean             @default(false)
  accidentDetails   String?
  hasModifications  Boolean             @default(false)
  modificationDetails String?
  
  // Market Data (will be updated by pricing algorithm)
  estimatedValue    Float?              // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©
  marketDemand      String?             // HIGH, MEDIUM, LOW
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  listings          Listing[]
  inspections       Inspection[]
  vehicleHistory    VehicleHistory[]
  
  @@index([make, model, year])
  @@index([vin])
}

// ============================================
// ğŸ“ LISTINGS
// ============================================

enum ListingType {
  MARKETPLACE     // Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ø¯ÙŠ Ù…Ù† ÙØ±Ø¯
  CERTIFIED       // Ù…Ø¹ØªÙ…Ø¯Ø© Ù…Ù† Xchange (Ù…ÙØ­ÙˆØµØ© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø©)
  DEALER          // Ù…Ù† ØªØ§Ø¬Ø±
  AUCTION         // Ù…Ø²Ø§Ø¯
}

enum ListingStatus {
  DRAFT           // Ù…Ø³ÙˆØ¯Ø©
  PENDING_REVIEW  // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  ACTIVE          // Ù†Ø´Ø·Ø©
  SOLD            // Ù…Ø¨Ø§Ø¹Ø©
  RESERVED        // Ù…Ø­Ø¬ÙˆØ²Ø©
  EXPIRED         // Ù…Ù†ØªÙ‡ÙŠØ©
  REMOVED         // Ù…Ø­Ø°ÙˆÙØ©
}

model Listing {
  id                String              @id @default(uuid())
  
  // Basics
  title             String
  description       String              @db.Text
  listingType       ListingType
  status            ListingStatus       @default(DRAFT)
  
  // Seller
  sellerId          String
  seller            User                @relation("SellerListings", fields: [sellerId], references: [id])
  
  // Vehicle
  vehicleId         String
  vehicle           Vehicle             @relation(fields: [vehicleId], references: [id])
  
  // Pricing
  askingPrice       Float               // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  minAcceptablePrice Float?             // Ø£Ù‚Ù„ Ø³Ø¹Ø± Ù…Ù‚Ø¨ÙˆÙ„ (Ø®Ø§Øµ)
  negotiable        Boolean             @default(true)
  
  // Location
  governorate       String
  city              String
  showExactLocation Boolean             @default(false)
  latitude          Float?
  longitude         Float?
  
  // Media
  images            ListingImage[]
  videos            ListingVideo[]
  
  // Features & Extras
  features          Json?               // {sunroof: true, leatherSeats: true, ...}
  extras            Json?               // {spareTire: true, toolkit: true, ...}
  
  // Documents
  hasOwnershipCard  Boolean             // Ø±Ø®ØµØ© Ø³Ø§Ø±ÙŠØ©
  ownershipExpiry   DateTime?
  hasInsurance      Boolean
  insuranceExpiry   DateTime?
  
  // Trade-In & Barter
  acceptsTradeIn    Boolean             @default(false)
  acceptsBarter     Boolean             @default(false)
  interestedInTypes String[]            // ["SEDAN", "SUV"] Ù„Ù„Ù…Ù‚Ø§ÙŠØ¶Ø©
  
  // Stats
  views             Int                 @default(0)
  favorites         Int                 @default(0)
  inquiries         Int                 @default(0)
  
  // SEO & Search
  searchKeywords    String?             // Ù…ÙØ­ÙØ³Ù‘Ù†Ø© Ù„Ù„Ø¨Ø­Ø«
  
  // Certification (Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©)
  isCertified       Boolean             @default(false)
  certificationId   String?             @unique
  certifiedAt       DateTime?
  certifiedBy       String?             // Inspector ID
  warrantyMonths    Int?                // Ø´Ù‡ÙˆØ± Ø§Ù„Ø¶Ù…Ø§Ù†
  
  // Timing
  publishedAt       DateTime?
  expiresAt         DateTime?
  soldAt            DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  // Relations
  inspection        Inspection?
  transactions      Transaction[]
  favorites         FavoriteListing[]
  tradeInRequests   TradeInRequest[]
  barterOffers      BarterOffer[]       @relation("BarterListing")
  interestedBarters BarterOffer[]       @relation("BarterInterestedListing")
  
  @@index([sellerId])
  @@index([vehicleId])
  @@index([status])
  @@index([listingType])
  @@index([publishedAt])
  @@index([governorate, city])
}

model ListingImage {
  id                String              @id @default(uuid())
  listingId         String
  listing           Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  url               String
  thumbnail         String?
  order             Int                 @default(0)
  caption           String?
  isPrimary         Boolean             @default(false)
  
  createdAt         DateTime            @default(now())
  
  @@index([listingId])
}

model ListingVideo {
  id                String              @id @default(uuid())
  listingId         String
  listing           Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  url               String
  thumbnail         String?
  duration          Int?                // seconds
  
  createdAt         DateTime            @default(now())
  
  @@index([listingId])
}

// ============================================
// ğŸ” INSPECTION SYSTEM
// ============================================

enum InspectionStatus {
  SCHEDULED       // Ù…Ø¬Ø¯ÙˆÙ„Ø©
  IN_PROGRESS     // Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ
  COMPLETED       // Ù…ÙƒØªÙ…Ù„Ø©
  FAILED          // ÙØ´Ù„Øª
  CANCELLED       // Ù…Ù„ØºØ§Ø©
}

model Inspection {
  id                String              @id @default(uuid())
  
  // References
  vehicleId         String              @unique
  vehicle           Vehicle             @relation(fields: [vehicleId], references: [id])
  listingId         String?             @unique
  listing           Listing?            @relation(fields: [listingId], references: [id])
  
  // Inspector
  inspectorId       String
  inspector         User                @relation("InspectorInspections", fields: [inspectorId], references: [id])
  
  // Schedule
  scheduledAt       DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  status            InspectionStatus    @default(SCHEDULED)
  
  // Location
  inspectionAddress String
  governorate       String
  city              String
  
  // Results
  overallGrade      String?             // A, B, C, D
  overallScore      Float?              // 0-100
  
  // Detailed Checks (150 points)
  exteriorScore     Float?              // 0-100
  interiorScore     Float?              // 0-100
  mechanicalScore   Float?              // 0-100
  electricalScore   Float?              // 0-100
  
  // Critical Issues
  hasCriticalIssues Boolean             @default(false)
  criticalIssues    Json?               // [{category: "engine", issue: "oil leak", severity: "high"}]
  
  // Detailed Report (JSON)
  checklistResults  Json?               // Complete 150-point checklist
  
  // Paint Thickness (accident detection)
  paintThickness    Json?               // {hood: 120, leftDoor: 250, ...} in microns
  hasRepaint        Boolean             @default(false)
  
  // OBD-II Scan
  odbCodes          Json?               // [{code: "P0420", description: "..."}]
  hasActiveCodes    Boolean             @default(false)
  
  // Battery Health
  batteryHealth     Float?              // 0-100%
  batteryVoltage    Float?
  
  // Tire Condition
  tireCondition     Json?               // {frontLeft: 70%, frontRight: 65%, ...}
  
  // Photos & Videos
  inspectionPhotos  String[]            // URLs
  inspectionVideos  String[]            // URLs
  
  // Notes
  inspectorNotes    String?             @db.Text
  recommendations   String?             @db.Text
  estimatedRepairCost Float?
  
  // Certification
  isPassed          Boolean             @default(false)
  certificationCode String?             @unique  // XCHG-INS-XXXXX
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([inspectorId])
  @@index([status])
  @@index([scheduledAt])
}

// ============================================
// ğŸ“œ VEHICLE HISTORY
// ============================================

enum HistoryEventType {
  OWNERSHIP_CHANGE    // ØªØºÙŠÙŠØ± Ù…Ù„ÙƒÙŠØ©
  ACCIDENT            // Ø­Ø§Ø¯Ø«
  MAINTENANCE         // ØµÙŠØ§Ù†Ø©
  INSPECTION          // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ
  INSURANCE_CLAIM     // Ù…Ø·Ø§Ù„Ø¨Ø© ØªØ£Ù…ÙŠÙ†
  RECALL              // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ©
  MODIFICATION        // ØªØ¹Ø¯ÙŠÙ„
  REGISTRATION        // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø®ØµØ©
}

model VehicleHistory {
  id                String              @id @default(uuid())
  
  vehicleId         String
  vehicle           Vehicle             @relation(fields: [vehicleId], references: [id])
  
  eventType         HistoryEventType
  eventDate         DateTime
  mileageAtEvent    Int?
  
  // Event Details
  title             String
  description       String?             @db.Text
  cost              Float?
  
  // Source
  sourceType        String?             // INSURANCE, DEALER, OWNER, GOVERNMENT
  sourceDocument    String?             // URL to document
  verified          Boolean             @default(false)
  
  createdAt         DateTime            @default(now())
  
  @@index([vehicleId])
  @@index([eventType])
  @@index([eventDate])
}

// ============================================
// ğŸ’° TRANSACTIONS
// ============================================

enum TransactionType {
  PURCHASE        // Ø´Ø±Ø§Ø¡ Ø¹Ø§Ø¯ÙŠ
  CERTIFIED_SALE  // Ø¨ÙŠØ¹ Ø³ÙŠØ§Ø±Ø© Ù…Ø¹ØªÙ…Ø¯Ø©
  TRADE_IN        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„
  BARTER          // Ù…Ù‚Ø§ÙŠØ¶Ø©
  AUCTION         // Ù…Ø²Ø§Ø¯
}

enum TransactionStatus {
  INITIATED       // Ø¨Ø¯Ø£Øª
  PAYMENT_PENDING // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹
  PAYMENT_HELD    // Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø­Ø¬ÙˆØ² (Escrow)
  INSPECTION_SCHEDULED // ÙØ­Øµ Ù…Ø¬Ø¯ÙˆÙ„
  INSPECTION_PASSED // Ù†Ø¬Ø­ Ø§Ù„ÙØ­Øµ
  INSPECTION_FAILED // ÙØ´Ù„ Ø§Ù„ÙØ­Øµ
  DOCUMENTS_PENDING // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
  DELIVERY_SCHEDULED // ØªÙˆØµÙŠÙ„ Ù…Ø¬Ø¯ÙˆÙ„
  DELIVERED       // ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
  COMPLETED       // Ù…ÙƒØªÙ…Ù„Ø©
  CANCELLED       // Ù…Ù„ØºØ§Ø©
  REFUNDED        // Ù…Ø³ØªØ±Ø¯
  DISPUTED        // Ù†Ø²Ø§Ø¹
}

enum PaymentMethod {
  CASH            // ÙƒØ§Ø´
  BANK_TRANSFER   // ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ
  CARD            // Ø¨Ø·Ø§Ù‚Ø©
  FAWRY           // ÙÙˆØ±ÙŠ
  MOBILE_WALLET   // Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©
  FINANCING       // ØªÙ…ÙˆÙŠÙ„
}

model Transaction {
  id                String              @id @default(uuid())
  transactionCode   String              @unique  // XCHG-TXN-XXXXX
  
  // Type
  transactionType   TransactionType
  status            TransactionStatus   @default(INITIATED)
  
  // Parties
  buyerId           String
  buyer             User                @relation("BuyerTransactions", fields: [buyerId], references: [id])
  sellerId          String
  seller            User                @relation("SellerTransactions", fields: [sellerId], references: [id])
  
  // Listing
  listingId         String
  listing           Listing             @relation(fields: [listingId], references: [id])
  
  // Financial
  agreedPrice       Float
  platformFee       Float               // Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ©
  inspectionFee     Float               @default(0)
  deliveryFee       Float               @default(0)
  totalAmount       Float
  
  // Payment
  paymentMethod     PaymentMethod
  paymentStatus     String              @default("PENDING")
  paymentReference  String?
  paidAt            DateTime?
  
  // Escrow (Ø­Ø¬Ø² Ø§Ù„Ù…Ø¨Ù„Øº)
  escrowHeld        Boolean             @default(false)
  escrowAmount      Float?
  escrowReleasedAt  DateTime?
  
  // Financing
  isFinanced        Boolean             @default(false)
  financingId       String?             @unique
  financing         Financing?
  
  // Trade-In Component (if applicable)
  tradeInId         String?             @unique
  tradeIn           TradeInRequest?
  tradeInValue      Float?
  
  // Barter Component (if applicable)
  barterId          String?             @unique
  barter            BarterOffer?
  barterValue       Float?
  
  // Delivery
  requiresDelivery  Boolean             @default(false)
  deliveryAddress   String?
  deliveryScheduledAt DateTime?
  deliveredAt       DateTime?
  deliveryProof     String?             // ØµÙˆØ±Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…
  
  // Documents
  ownershipTransferDoc String?
  billOfSale        String?
  
  // Warranty (Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©)
  hasWarranty       Boolean             @default(false)
  warrantyMonths    Int?
  warrantyStartDate DateTime?
  warrantyEndDate   DateTime?
  
  // Cancellation
  cancelledAt       DateTime?
  cancellationReason String?
  cancelledBy       String?             // USER_ID
  
  // Refund
  refundedAt        DateTime?
  refundAmount      Float?
  refundReason      String?
  
  // Dispute
  isDisputed        Boolean             @default(false)
  disputeId         String?             @unique
  dispute           Dispute?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([buyerId])
  @@index([sellerId])
  @@index([listingId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// ğŸ’³ FINANCING
// ============================================

enum FinancingStatus {
  PENDING         // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
  APPROVED        // Ù…ÙˆØ§ÙÙ‚
  REJECTED        // Ù…Ø±ÙÙˆØ¶
  ACTIVE          // Ù†Ø´Ø·
  COMPLETED       // Ù…ÙƒØªÙ…Ù„
  DEFAULTED       // Ù…ØªØ¹Ø«Ø±
}

model Financing {
  id                String              @id @default(uuid())
  
  transactionId     String              @unique
  transaction       Transaction         @relation(fields: [transactionId], references: [id])
  
  // Partner Info
  partnerId         String              // CONTACT, DRIVE, etc.
  partnerName       String
  
  // Application
  applicationId     String?             @unique  // Ù…Ù† Ø§Ù„Ø´Ø±ÙŠÙƒ
  appliedAt         DateTime            @default(now())
  
  // Amounts
  vehiclePrice      Float
  downPayment       Float
  financedAmount    Float
  
  // Terms
  interestRate      Float               // Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØ§Ø¦Ø¯Ø©
  durationMonths    Int                 // Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£Ø´Ù‡Ø±
  monthlyPayment    Float
  totalPayable      Float
  
  // Status
  status            FinancingStatus     @default(PENDING)
  approvedAt        DateTime?
  rejectedAt        DateTime?
  rejectionReason   String?
  
  // Contract
  contractUrl       String?
  contractSignedAt  DateTime?
  
  // Tracking
  paidInstallments  Int                 @default(0)
  missedPayments    Int                 @default(0)
  nextPaymentDue    DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([status])
  @@index([partnerId])
}

// ============================================
// ğŸ”„ TRADE-IN SYSTEM
// ============================================

enum TradeInStatus {
  REQUESTED       // Ù…Ø·Ù„ÙˆØ¨
  QUOTE_PROVIDED  // Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ù…Ù‚Ø¯Ù…
  ACCEPTED        // Ù…Ù‚Ø¨ÙˆÙ„
  REJECTED        // Ù…Ø±ÙÙˆØ¶
  INSPECTING      // Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ
  COMPLETED       // Ù…ÙƒØªÙ…Ù„
}

model TradeInRequest {
  id                String              @id @default(uuid())
  
  // User
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  
  // Old Car (to trade in)
  oldCarMake        String
  oldCarModel       String
  oldCarYear        Int
  oldCarMileage     Int
  oldCarCondition   VehicleCondition
  oldCarImages      String[]
  oldCarDescription String?             @db.Text
  
  // New Car (interested in)
  newCarListingId   String?
  newCarListing     Listing?            @relation(fields: [newCarListingId], references: [id])
  
  // Quote
  estimatedValue    Float?              // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  quotedAt          DateTime?
  quoteValidUntil   DateTime?
  
  // Inspection
  inspectionScheduled Boolean           @default(false)
  inspectionDate    DateTime?
  
  // Status
  status            TradeInStatus       @default(REQUESTED)
  
  // Transaction (if completed)
  transactionId     String?             @unique
  transaction       Transaction?        @relation(fields: [transactionId], references: [id])
  
  // Notes
  userNotes         String?             @db.Text
  adminNotes        String?             @db.Text
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([userId])
  @@index([status])
}

// ============================================
// ğŸ”€ BARTER SYSTEM (Ø§Ù„Ù…Ù‚Ø§ÙŠØ¶Ø©)
// ============================================

enum BarterType {
  CAR_FOR_CAR         // Ø³ÙŠØ§Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø³ÙŠØ§Ø±Ø©
  CAR_FOR_PHONE       // Ø³ÙŠØ§Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ù…ÙˆØ¨Ø§ÙŠÙ„
  CAR_FOR_PROPERTY    // Ø³ÙŠØ§Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø¹Ù‚Ø§Ø±
  CAR_FOR_GOLD        // Ø³ÙŠØ§Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø°Ù‡Ø¨
  CAR_FOR_MIXED       // Ø³ÙŠØ§Ø±Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø£ØµÙ†Ø§Ù Ù…ØªØ¹Ø¯Ø¯Ø©
}

enum BarterStatus {
  PROPOSED        // Ù…Ù‚ØªØ±Ø­
  COUNTER_OFFERED // Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯
  NEGOTIATING     // ÙÙŠ Ø§Ù„Ù…ÙØ§ÙˆØ¶Ø§Øª
  ACCEPTED        // Ù…Ù‚Ø¨ÙˆÙ„
  REJECTED        // Ù…Ø±ÙÙˆØ¶
  EXPIRED         // Ù…Ù†ØªÙ‡ÙŠ
  COMPLETED       // Ù…ÙƒØªÙ…Ù„
}

model BarterOffer {
  id                String              @id @default(uuid())
  offerCode         String              @unique  // XCHG-BRT-XXXXX
  
  // Type
  barterType        BarterType
  status            BarterStatus        @default(PROPOSED)
  
  // Parties
  initiatorId       String
  initiator         User                @relation("BarterInitiator", fields: [initiatorId], references: [id])
  receiverId        String
  receiver          User                @relation("BarterReceiver", fields: [receiverId], references: [id])
  
  // What I'm offering (Car)
  myListingId       String
  myListing         Listing             @relation("BarterListing", fields: [myListingId], references: [id])
  
  // What I want
  interestedListingId String?
  interestedListing Listing?            @relation("BarterInterestedListing", fields: [interestedListingId], references: [id])
  
  // Values
  myItemValue       Float               // Ù‚ÙŠÙ…Ø© Ù…Ø§ Ø£Ø¹Ø±Ø¶Ù‡
  theirItemValue    Float               // Ù‚ÙŠÙ…Ø© Ù…Ø§ Ø£Ø±ÙŠØ¯Ù‡
  cashDifference    Float               @default(0)  // Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ
  whoPays           String?             // INITIATOR or RECEIVER
  
  // Multi-party barter (for complex exchanges)
  isMultiParty      Boolean             @default(false)
  involvedParties   Json?               // [{userId, listingId, value}]
  
  // Negotiation
  message           String?             @db.Text
  counterOffers     BarterCounterOffer[]
  
  // Timing
  expiresAt         DateTime?
  acceptedAt        DateTime?
  completedAt       DateTime?
  
  // Transaction (if completed)
  transactionId     String?             @unique
  transaction       Transaction?        @relation(fields: [transactionId], references: [id])
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([initiatorId])
  @@index([receiverId])
  @@index([status])
}

model BarterCounterOffer {
  id                String              @id @default(uuid())
  
  barterOfferId     String
  barterOffer       BarterOffer         @relation(fields: [barterOfferId], references: [id], onDelete: Cascade)
  
  proposedBy        String              // USER_ID
  
  // Counter Values
  myItemValue       Float
  theirItemValue    Float
  cashDifference    Float
  whoPays           String
  
  message           String?             @db.Text
  
  createdAt         DateTime            @default(now())
  
  @@index([barterOfferId])
}

// ============================================
// âš–ï¸ DISPUTE RESOLUTION
// ============================================

enum DisputeReason {
  VEHICLE_MISMATCH    // Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ø§ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙˆØµÙ
  HIDDEN_DAMAGES      // Ø£Ø¶Ø±Ø§Ø± Ù…Ø®ÙÙŠØ©
  FAKE_DOCUMENTS      // ÙˆØ«Ø§Ø¦Ù‚ Ù…Ø²ÙˆØ±Ø©
  PAYMENT_ISSUE       // Ù…Ø´ÙƒÙ„Ø© Ø¯ÙØ¹
  DELIVERY_ISSUE      // Ù…Ø´ÙƒÙ„Ø© ØªÙˆØµÙŠÙ„
  WARRANTY_CLAIM      // Ù…Ø·Ø§Ù„Ø¨Ø© Ø¶Ù…Ø§Ù†
  OTHER               // Ø£Ø®Ø±Ù‰
}

enum DisputeStatus {
  OPEN            // Ù…ÙØªÙˆØ­
  UNDER_REVIEW    // Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
  AWAITING_INFO   // ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  RESOLVED        // Ù…Ø­Ù„ÙˆÙ„
  ESCALATED       // Ù…ÙØµØ¹Ù‘Ø¯
  CLOSED          // Ù…ØºÙ„Ù‚
}

model Dispute {
  id                String              @id @default(uuid())
  disputeCode       String              @unique  // XCHG-DSP-XXXXX
  
  transactionId     String              @unique
  transaction       Transaction         @relation(fields: [transactionId], references: [id])
  
  // Parties
  complainantId     String              // Ø§Ù„Ù…ÙØ´ØªÙƒÙŠ
  respondentId      String              // Ø§Ù„Ù…ÙØ´ØªÙƒÙ‰ Ø¹Ù„ÙŠÙ‡
  
  // Details
  reason            DisputeReason
  description       String              @db.Text
  evidence          String[]            // URLs to photos/documents
  
  // Status
  status            DisputeStatus       @default(OPEN)
  priority          String              @default("MEDIUM")  // LOW, MEDIUM, HIGH
  
  // Resolution
  assignedTo        String?             // ADMIN_ID
  resolution        String?             @db.Text
  refundAmount      Float?
  
  resolvedAt        DateTime?
  closedAt          DateTime?
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

// ============================================
// â­ REVIEWS & RATINGS
// ============================================

model Review {
  id                String              @id @default(uuid())
  
  // Who reviewed whom
  authorId          String
  author            User                @relation("ReviewAuthor", fields: [authorId], references: [id])
  targetId          String
  target            User                @relation("ReviewTarget", fields: [targetId], references: [id])
  
  // Transaction context
  transactionId     String?
  
  // Rating (1-5)
  rating            Float
  
  // Categories
  communicationRating Float?
  accuracyRating    Float?
  professionalismRating Float?
  
  // Review text
  title             String?
  comment           String?             @db.Text
  
  // Response
  response          String?             @db.Text
  respondedAt       DateTime?
  
  // Moderation
  isVerified        Boolean             @default(false)
  isReported        Boolean             @default(false)
  isHidden          Boolean             @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@index([targetId])
  @@index([authorId])
  @@index([rating])
}

// ============================================
// ğŸ’¬ MESSAGING
// ============================================

model Message {
  id                String              @id @default(uuid())
  
  senderId          String
  sender            User                @relation(fields: [senderId], references: [id])
  receiverId        String
  
  listingId         String?             // Ø§Ù„Ø³ÙŠØ§Ù‚ (Ø£ÙŠ Ø¥Ø¹Ù„Ø§Ù†)
  
  content           String              @db.Text
  attachments       String[]            // URLs
  
  isRead            Boolean             @default(false)
  readAt            DateTime?
  
  createdAt         DateTime            @default(now())
  
  @@index([senderId])
  @@index([receiverId])
  @@index([listingId])
  @@index([createdAt])
}

// ============================================
// ğŸ”” NOTIFICATIONS
// ============================================

enum NotificationType {
  NEW_MESSAGE
  LISTING_VIEWED
  LISTING_FAVORITED
  PRICE_DROP
  TRADE_IN_QUOTE
  BARTER_OFFER
  INSPECTION_SCHEDULED
  PAYMENT_RECEIVED
  DELIVERY_SCHEDULED
  REVIEW_RECEIVED
  SYSTEM_ANNOUNCEMENT
}

model Notification {
  id                String              @id @default(uuid())
  
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  
  type              NotificationType
  title             String
  message           String              @db.Text
  
  actionUrl         String?
  
  isRead            Boolean             @default(false)
  readAt            DateTime?
  
  createdAt         DateTime            @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// ğŸ”– FAVORITES & SAVED SEARCHES
// ============================================

model FavoriteListing {
  id                String              @id @default(uuid())
  
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  
  listingId         String
  listing           Listing             @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime            @default(now())
  
  @@unique([userId, listingId])
  @@index([userId])
}

model SavedSearch {
  id                String              @id @default(uuid())
  
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  
  name              String
  filters           Json                // {make: "Toyota", priceMax: 500000, ...}
  
  notifyOnNewListings Boolean           @default(false)
  
  createdAt         DateTime            @default(now())
  
  @@index([userId])
}

// ============================================
// ğŸ“Š ANALYTICS & TRACKING
// ============================================

model ListingView {
  id                String              @id @default(uuid())
  
  listingId         String
  
  viewerId          String?             // null if anonymous
  ipAddress         String
  userAgent         String?
  
  // Referral
  referrer          String?
  source            String?             // SEARCH, DIRECT, SOCIAL, etc.
  
  viewedAt          DateTime            @default(now())
  
  @@index([listingId])
  @@index([viewedAt])
}

model SearchQuery {
  id                String              @id @default(uuid())
  
  userId            String?
  query             String
  filters           Json?
  
  resultsCount      Int
  
  createdAt         DateTime            @default(now())
  
  @@index([createdAt])
}

// ============================================
// âš™ï¸ SYSTEM CONFIGURATION
// ============================================

model SystemConfig {
  id                String              @id @default(uuid())
  key               String              @unique
  value             Json
  description       String?
  
  updatedAt         DateTime            @updatedAt
}

// Examples:
// - platform_fees: {marketplace: 3, certified: 5, dealer: 4}
// - payment_providers: {paymob: {...}, fawry: {...}}
// - financing_partners: [{name: "Contact", ...}]
