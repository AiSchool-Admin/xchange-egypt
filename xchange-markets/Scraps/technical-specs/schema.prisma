// Xchange Scrap Marketplace - Prisma Schema
// Database: PostgreSQL 16

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserType {
  individual    // فرد
  collector     // روبابيكيا/جامع
  dealer        // تاجر
  company       // شركة
  recycler      // مصنع تدوير
  admin         // مدير النظام
}

enum ListingType {
  sell          // إعلان بيع
  buy           // إعلان شراء
  auction       // مزاد
}

enum ListingStatus {
  draft         // مسودة
  pending       // في انتظار المراجعة
  active        // نشط
  sold          // تم البيع
  expired       // منتهي
  cancelled     // ملغي
}

enum PickupStatus {
  pending       // في الانتظار
  assigned      // تم تعيين جامع
  confirmed     // تم التأكيد
  on_the_way    // في الطريق
  arrived       // وصل
  weighing      // جاري الوزن
  payment       // في انتظار الدفع
  completed     // مكتمل
  cancelled     // ملغي
  disputed      // نزاع
}

enum TransactionStatus {
  pending       // في الانتظار
  confirmed     // مؤكد
  in_progress   // جاري التنفيذ
  completed     // مكتمل
  cancelled     // ملغي
  disputed      // نزاع
}

enum PaymentMethod {
  cash          // نقداً
  wallet        // محفظة Xchange
  bank_transfer // تحويل بنكي
  fawry         // فوري
  vodafone_cash // فودافون كاش
  instapay      // انستاباي
}

enum PaymentStatus {
  pending       // في الانتظار
  paid          // تم الدفع
  refunded      // تم الاسترداد
  failed        // فشل
}

enum ContractStatus {
  draft              // مسودة
  pending_approval   // في انتظار الموافقة
  active             // نشط
  suspended          // موقوف
  completed          // مكتمل
  terminated         // منتهي
}

enum VehicleType {
  tricycle      // تروسيكل
  pickup        // بيك أب
  truck         // شاحنة
  van           // فان
  none          // بدون
}

enum DealerType {
  shop          // محل
  warehouse     // مخزن
  factory       // مصنع
  recycler      // مصنع تدوير
}

enum PriceSource {
  manual        // إدخال يدوي
  lme           // بورصة لندن
  market        // مسح السوق
  algorithm     // خوارزمية
}

enum TimeSlot {
  morning       // صباحاً (9-12)
  afternoon     // ظهراً (12-4)
  evening       // مساءً (4-8)
}

enum Unit {
  kg            // كيلوجرام
  ton           // طن
  piece         // قطعة
  unit          // وحدة
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                    String    @id @default(uuid())
  phone                 String    @unique
  phoneVerified         Boolean   @default(false) @map("phone_verified")
  email                 String?
  name                  String?
  nationalId            String?   @map("national_id")
  nationalIdVerified    Boolean   @default(false) @map("national_id_verified")
  userType              UserType  @default(individual) @map("user_type")
  
  // معلومات الشركة (إن وجدت)
  companyName           String?   @map("company_name")
  commercialRegister    String?   @map("commercial_register")
  taxId                 String?   @map("tax_id")
  
  // الصورة
  profileImageUrl       String?   @map("profile_image_url")
  
  // العنوان
  addressGovernorate    String?   @map("address_governorate")
  addressCity           String?   @map("address_city")
  addressStreet         String?   @map("address_street")
  addressLat            Decimal?  @map("address_lat") @db.Decimal(10, 8)
  addressLng            Decimal?  @map("address_lng") @db.Decimal(11, 8)
  
  // الإحصائيات
  ratingAvg             Decimal   @default(0) @map("rating_avg") @db.Decimal(3, 2)
  ratingCount           Int       @default(0) @map("rating_count")
  totalTransactions     Int       @default(0) @map("total_transactions")
  totalWeightKg         Decimal   @default(0) @map("total_weight_kg") @db.Decimal(12, 2)
  walletBalance         Decimal   @default(0) @map("wallet_balance") @db.Decimal(12, 2)
  
  // الحالة
  isVerified            Boolean   @default(false) @map("is_verified")
  isActive              Boolean   @default(true) @map("is_active")
  
  // التواريخ
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // العلاقات
  listings              Listing[]
  pickupRequestsAsUser  PickupRequest[] @relation("UserPickups")
  pickupRequestsAsCollector PickupRequest[] @relation("CollectorPickups")
  transactionsAsSeller  Transaction[] @relation("SellerTransactions")
  transactionsAsBuyer   Transaction[] @relation("BuyerTransactions")
  reviewsGiven          Review[] @relation("ReviewerRelation")
  reviewsReceived       Review[] @relation("ReviewedRelation")
  contractsAsSeller     B2BContract[] @relation("SellerContracts")
  contractsAsBuyer      B2BContract[] @relation("BuyerContracts")
  collector             Collector?
  dealer                Dealer?
  priceAlerts           PriceAlert[]
  notifications         Notification[]
  walletTransactions    WalletTransaction[]
  
  @@index([phone])
  @@index([userType])
  @@index([addressGovernorate])
  @@index([isVerified])
  @@map("users")
}

model OtpCode {
  id          String   @id @default(uuid())
  phone       String
  code        String
  attempts    Int      @default(0)
  expiresAt   DateTime @map("expires_at")
  verifiedAt  DateTime? @map("verified_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([phone, code])
  @@map("otp_codes")
}

model RefreshToken {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================
// MATERIALS & CATEGORIES
// ============================================

model MaterialCategory {
  id              String   @id @default(uuid())
  nameAr          String   @map("name_ar")
  nameEn          String   @map("name_en")
  slug            String   @unique
  parentId        String?  @map("parent_id")
  iconUrl         String?  @map("icon_url")
  descriptionAr   String?  @map("description_ar")
  descriptionEn   String?  @map("description_en")
  sortOrder       Int      @default(0) @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // العلاقات
  parent          MaterialCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        MaterialCategory[] @relation("CategoryHierarchy")
  materialTypes   MaterialType[]
  
  @@map("material_categories")
}

model MaterialType {
  id              String   @id @default(uuid())
  categoryId      String   @map("category_id")
  nameAr          String   @map("name_ar")
  nameEn          String   @map("name_en")
  slug            String   @unique
  descriptionAr   String?  @map("description_ar")
  descriptionEn   String?  @map("description_en")
  unit            Unit     @default(kg)
  minQuantity     Decimal  @default(1) @map("min_quantity") @db.Decimal(10, 2)
  imageUrl        String?  @map("image_url")
  qualityGrades   Json?    @map("quality_grades") // درجات الجودة المتاحة
  sortOrder       Int      @default(0) @map("sort_order")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // العلاقات
  category        MaterialCategory @relation(fields: [categoryId], references: [id])
  prices          Price[]
  listings        Listing[]
  pickupItems     PickupItem[]
  contracts       B2BContract[]
  priceAlerts     PriceAlert[]
  
  @@index([categoryId])
  @@index([slug])
  @@map("material_types")
}

// ============================================
// PRICING
// ============================================

model Price {
  id              String      @id @default(uuid())
  materialTypeId  String      @map("material_type_id")
  qualityGrade    String      @default("standard") @map("quality_grade")
  pricePerKg      Decimal     @map("price_per_kg") @db.Decimal(10, 2)
  pricePerTon     Decimal?    @map("price_per_ton") @db.Decimal(12, 2)
  currency        String      @default("EGP")
  source          PriceSource @default(manual)
  governorate     String?     // NULL = سعر عام
  effectiveDate   DateTime    @map("effective_date") @db.Date
  expiryDate      DateTime?   @map("expiry_date") @db.Date
  notes           String?
  createdById     String?     @map("created_by_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  
  // العلاقات
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id])
  
  @@unique([materialTypeId, qualityGrade, governorate, effectiveDate])
  @@index([materialTypeId])
  @@index([effectiveDate])
  @@index([governorate])
  @@map("prices")
}

model PriceAlert {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  materialTypeId  String   @map("material_type_id")
  alertType       String   @map("alert_type") // above, below, change_percent
  threshold       Decimal  @db.Decimal(10, 2)
  isActive        Boolean  @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // العلاقات
  user            User @relation(fields: [userId], references: [id])
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id])
  
  @@index([userId])
  @@index([materialTypeId])
  @@index([isActive])
  @@map("price_alerts")
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id                  String        @id @default(uuid())
  userId              String        @map("user_id")
  listingType         ListingType   @map("listing_type")
  materialTypeId      String        @map("material_type_id")
  title               String
  description         String?
  qualityGrade        String        @default("standard") @map("quality_grade")
  quantityKg          Decimal       @map("quantity_kg") @db.Decimal(12, 2)
  quantityEstimated   Boolean       @default(false) @map("quantity_estimated")
  pricePerKg          Decimal?      @map("price_per_kg") @db.Decimal(10, 2)
  priceTotal          Decimal?      @map("price_total") @db.Decimal(12, 2)
  priceNegotiable     Boolean       @default(true) @map("price_negotiable")
  minQuantityKg       Decimal?      @map("min_quantity_kg") @db.Decimal(10, 2)
  images              Json?         // array of image URLs
  
  // العنوان
  addressGovernorate  String        @map("address_governorate")
  addressCity         String?       @map("address_city")
  addressDetails      String?       @map("address_details")
  addressLat          Decimal?      @map("address_lat") @db.Decimal(10, 8)
  addressLng          Decimal?      @map("address_lng") @db.Decimal(11, 8)
  
  // خيارات التسليم
  pickupAvailable     Boolean       @default(true) @map("pickup_available")
  deliveryAvailable   Boolean       @default(false) @map("delivery_available")
  
  // الحالة والإحصائيات
  status              ListingStatus @default(pending)
  featured            Boolean       @default(false)
  viewsCount          Int           @default(0) @map("views_count")
  inquiriesCount      Int           @default(0) @map("inquiries_count")
  
  // التواريخ
  expiresAt           DateTime?     @map("expires_at")
  soldAt              DateTime?     @map("sold_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  
  // العلاقات
  user                User @relation(fields: [userId], references: [id])
  materialType        MaterialType @relation(fields: [materialTypeId], references: [id])
  inquiries           ListingInquiry[]
  
  @@index([userId])
  @@index([materialTypeId])
  @@index([listingType])
  @@index([status])
  @@index([addressGovernorate])
  @@index([createdAt(sort: Desc)])
  @@map("listings")
}

model ListingInquiry {
  id          String   @id @default(uuid())
  listingId   String   @map("listing_id")
  senderId    String   @map("sender_id")
  message     String
  offerPrice  Decimal? @map("offer_price") @db.Decimal(10, 2)
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")
  
  // العلاقات
  listing     Listing @relation(fields: [listingId], references: [id])
  
  @@index([listingId])
  @@index([senderId])
  @@map("listing_inquiries")
}

// ============================================
// PICKUP REQUESTS (C2B)
// ============================================

model PickupRequest {
  id                    String       @id @default(uuid())
  requestNumber         String       @unique @map("request_number") // XSP-2024-000001
  userId                String       @map("user_id")
  collectorId           String?      @map("collector_id")
  
  // التسعير
  estimatedPrice        Decimal?     @map("estimated_price") @db.Decimal(10, 2)
  finalPrice            Decimal?     @map("final_price") @db.Decimal(10, 2)
  platformFee           Decimal?     @map("platform_fee") @db.Decimal(10, 2)
  collectorPayout       Decimal?     @map("collector_payout") @db.Decimal(10, 2)
  
  // العنوان
  addressGovernorate    String       @map("address_governorate")
  addressCity           String       @map("address_city")
  addressStreet         String       @map("address_street")
  addressBuilding       String?      @map("address_building")
  addressFloor          String?      @map("address_floor")
  addressLandmark       String?      @map("address_landmark")
  addressLat            Decimal?     @map("address_lat") @db.Decimal(10, 8)
  addressLng            Decimal?     @map("address_lng") @db.Decimal(11, 8)
  
  // الموعد
  preferredDate         DateTime     @map("preferred_date") @db.Date
  preferredTimeSlot     TimeSlot     @default(morning) @map("preferred_time_slot")
  
  // الحالة
  status                PickupStatus @default(pending)
  
  // موقع الجامع (للتتبع)
  collectorLocationLat  Decimal?     @map("collector_location_lat") @db.Decimal(10, 8)
  collectorLocationLng  Decimal?     @map("collector_location_lng") @db.Decimal(11, 8)
  collectorLocationUpdatedAt DateTime? @map("collector_location_updated_at")
  
  // الملاحظات
  userNotes             String?      @map("user_notes")
  collectorNotes        String?      @map("collector_notes")
  cancellationReason    String?      @map("cancellation_reason")
  
  // التواريخ
  assignedAt            DateTime?    @map("assigned_at")
  confirmedAt           DateTime?    @map("confirmed_at")
  arrivedAt             DateTime?    @map("arrived_at")
  completedAt           DateTime?    @map("completed_at")
  cancelledAt           DateTime?    @map("cancelled_at")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  
  // العلاقات
  user                  User @relation("UserPickups", fields: [userId], references: [id])
  collector             User? @relation("CollectorPickups", fields: [collectorId], references: [id])
  items                 PickupItem[]
  transaction           Transaction?
  
  @@index([userId])
  @@index([collectorId])
  @@index([status])
  @@index([preferredDate])
  @@index([addressGovernorate])
  @@map("pickup_requests")
}

model PickupItem {
  id              String   @id @default(uuid())
  pickupRequestId String   @map("pickup_request_id")
  materialTypeId  String   @map("material_type_id")
  qualityGrade    String   @default("standard") @map("quality_grade")
  estimatedKg     Decimal  @map("estimated_kg") @db.Decimal(10, 2)
  actualKg        Decimal? @map("actual_kg") @db.Decimal(10, 2)
  pricePerKg      Decimal? @map("price_per_kg") @db.Decimal(10, 2)
  subtotal        Decimal? @db.Decimal(10, 2)
  
  // العلاقات
  pickupRequest   PickupRequest @relation(fields: [pickupRequestId], references: [id])
  materialType    MaterialType @relation(fields: [materialTypeId], references: [id])
  
  @@index([pickupRequestId])
  @@map("pickup_items")
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id                  String            @id @default(uuid())
  transactionNumber   String            @unique @map("transaction_number") // XST-2024-000001
  
  // الأطراف
  sellerId            String            @map("seller_id")
  buyerId             String            @map("buyer_id")
  
  // المصدر
  sourceType          String            @map("source_type") // listing, pickup, b2b_contract
  sourceId            String            @map("source_id")
  pickupRequestId     String?           @unique @map("pickup_request_id")
  
  // المالية
  totalWeightKg       Decimal           @map("total_weight_kg") @db.Decimal(12, 2)
  subtotal            Decimal           @db.Decimal(12, 2)
  platformFeeSeller   Decimal           @default(0) @map("platform_fee_seller") @db.Decimal(10, 2)
  platformFeeBuyer    Decimal           @default(0) @map("platform_fee_buyer") @db.Decimal(10, 2)
  deliveryFee         Decimal           @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  totalAmount         Decimal           @map("total_amount") @db.Decimal(12, 2)
  
  // الدفع
  paymentMethod       PaymentMethod     @map("payment_method")
  paymentStatus       PaymentStatus     @default(pending) @map("payment_status")
  paymentReference    String?           @map("payment_reference")
  paidAt              DateTime?         @map("paid_at")
  
  // الحالة
  status              TransactionStatus @default(pending)
  
  // التواريخ
  confirmedAt         DateTime?         @map("confirmed_at")
  completedAt         DateTime?         @map("completed_at")
  cancelledAt         DateTime?         @map("cancelled_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")
  
  // العلاقات
  seller              User @relation("SellerTransactions", fields: [sellerId], references: [id])
  buyer               User @relation("BuyerTransactions", fields: [buyerId], references: [id])
  pickupRequest       PickupRequest? @relation(fields: [pickupRequestId], references: [id])
  reviews             Review[]
  
  @@index([sellerId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("transactions")
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id              String   @id @default(uuid())
  transactionId   String   @map("transaction_id")
  reviewerId      String   @map("reviewer_id")
  reviewedId      String   @map("reviewed_id")
  rating          Int      // 1-5
  weightAccuracy  Int?     @map("weight_accuracy") // دقة الوزن
  qualityAccuracy Int?     @map("quality_accuracy") // دقة الجودة
  punctuality     Int?     // الالتزام بالموعد
  communication   Int?     // التواصل
  comment         String?
  images          Json?
  isVerified      Boolean  @default(true) @map("is_verified")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // العلاقات
  transaction     Transaction @relation(fields: [transactionId], references: [id])
  reviewer        User @relation("ReviewerRelation", fields: [reviewerId], references: [id])
  reviewed        User @relation("ReviewedRelation", fields: [reviewedId], references: [id])
  
  @@unique([transactionId, reviewerId])
  @@index([reviewedId])
  @@map("reviews")
}

// ============================================
// B2B CONTRACTS
// ============================================

model B2BContract {
  id                      String         @id @default(uuid())
  contractNumber          String         @unique @map("contract_number") // XSC-2024-000001
  sellerId                String         @map("seller_id")
  buyerId                 String         @map("buyer_id")
  
  // تفاصيل العقد
  materialTypeId          String         @map("material_type_id")
  qualityGrade            String         @map("quality_grade")
  quantityKgPerPeriod     Decimal        @map("quantity_kg_per_period") @db.Decimal(12, 2)
  periodType              String         @map("period_type") // weekly, monthly, quarterly
  pricePerKg              Decimal        @map("price_per_kg") @db.Decimal(10, 2)
  priceAdjustmentFormula  String?        @map("price_adjustment_formula")
  
  // المدة
  startDate               DateTime       @map("start_date") @db.Date
  endDate                 DateTime       @map("end_date") @db.Date
  autoRenew               Boolean        @default(false) @map("auto_renew")
  
  // الشروط
  deliveryTerms           String?        @map("delivery_terms")
  paymentTerms            String?        @map("payment_terms")
  qualityStandards        String?        @map("quality_standards")
  penalties               String?
  
  // الحالة
  status                  ContractStatus @default(draft)
  
  // ESG
  esgCertificateRequired  Boolean        @default(false) @map("esg_certificate_required")
  esgCertificateUrl       String?        @map("esg_certificate_url")
  
  // التواريخ
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")
  
  // العلاقات
  seller                  User @relation("SellerContracts", fields: [sellerId], references: [id])
  buyer                   User @relation("BuyerContracts", fields: [buyerId], references: [id])
  materialType            MaterialType @relation(fields: [materialTypeId], references: [id])
  
  @@index([sellerId])
  @@index([buyerId])
  @@index([status])
  @@map("b2b_contracts")
}

// ============================================
// COLLECTORS (الروبابيكيا)
// ============================================

model Collector {
  id                      String      @id @default(uuid())
  userId                  String      @unique @map("user_id")
  
  // معلومات المركبة
  vehicleType             VehicleType @default(tricycle) @map("vehicle_type")
  vehiclePlate            String?     @map("vehicle_plate")
  vehicleCapacityKg       Decimal?    @map("vehicle_capacity_kg") @db.Decimal(10, 2)
  
  // منطقة العمل
  serviceGovernorates     Json?       @map("service_governorates")
  serviceCities           Json?       @map("service_cities")
  serviceRadiusKm         Int         @default(10) @map("service_radius_km")
  
  // التوفر
  isAvailable             Boolean     @default(true) @map("is_available")
  workingHours            Json?       @map("working_hours")
  
  // الإحصائيات
  totalPickups            Int         @default(0) @map("total_pickups")
  totalWeightCollectedKg  Decimal     @default(0) @map("total_weight_collected_kg") @db.Decimal(12, 2)
  avgRating               Decimal     @default(0) @map("avg_rating") @db.Decimal(3, 2)
  completionRate          Decimal     @default(100) @map("completion_rate") @db.Decimal(5, 2)
  
  // الموقع الحالي
  currentLat              Decimal?    @map("current_lat") @db.Decimal(10, 8)
  currentLng              Decimal?    @map("current_lng") @db.Decimal(11, 8)
  locationUpdatedAt       DateTime?   @map("location_updated_at")
  
  // الحالة
  isVerified              Boolean     @default(false) @map("is_verified")
  isActive                Boolean     @default(true) @map("is_active")
  
  // التواريخ
  createdAt               DateTime    @default(now()) @map("created_at")
  updatedAt               DateTime    @updatedAt @map("updated_at")
  
  // العلاقات
  user                    User @relation(fields: [userId], references: [id])
  
  @@index([isAvailable, isActive])
  @@map("collectors")
}

// ============================================
// DEALERS (التجار)
// ============================================

model Dealer {
  id                    String     @id @default(uuid())
  userId                String     @unique @map("user_id")
  
  // معلومات المحل/المخزن
  businessName          String     @map("business_name")
  businessType          DealerType @map("business_type")
  specializations       Json?      // أنواع المواد المتخصص فيها
  
  // العنوان
  addressGovernorate    String     @map("address_governorate")
  addressCity           String     @map("address_city")
  addressStreet         String?    @map("address_street")
  addressLat            Decimal?   @map("address_lat") @db.Decimal(10, 8)
  addressLng            Decimal?   @map("address_lng") @db.Decimal(11, 8)
  
  // التواصل
  phoneSecondary        String?    @map("phone_secondary")
  whatsapp              String?
  
  // ساعات العمل
  workingHours          Json?      @map("working_hours")
  
  // المرافق
  hasScale              Boolean    @default(false) @map("has_scale")
  scaleCapacityKg       Decimal?   @map("scale_capacity_kg") @db.Decimal(10, 2)
  hasLoadingEquipment   Boolean    @default(false) @map("has_loading_equipment")
  acceptsSmallQuantities Boolean   @default(true) @map("accepts_small_quantities")
  minQuantityKg         Decimal    @default(1) @map("min_quantity_kg") @db.Decimal(10, 2)
  
  // الخدمات
  offersPickup          Boolean    @default(false) @map("offers_pickup")
  pickupFeePerKm        Decimal?   @map("pickup_fee_per_km") @db.Decimal(6, 2)
  
  // الإحصائيات
  totalTransactions     Int        @default(0) @map("total_transactions")
  totalWeightKg         Decimal    @default(0) @map("total_weight_kg") @db.Decimal(14, 2)
  avgRating             Decimal    @default(0) @map("avg_rating") @db.Decimal(3, 2)
  
  // الحالة
  isVerified            Boolean    @default(false) @map("is_verified")
  isFeatured            Boolean    @default(false) @map("is_featured")
  isActive              Boolean    @default(true) @map("is_active")
  
  // التواريخ
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")
  
  // العلاقات
  user                  User @relation(fields: [userId], references: [id])
  dealerPrices          DealerPrice[]
  images                DealerImage[]
  
  @@index([addressGovernorate])
  @@index([businessType])
  @@index([isVerified, isActive])
  @@map("dealers")
}

model DealerPrice {
  id              String   @id @default(uuid())
  dealerId        String   @map("dealer_id")
  materialTypeId  String   @map("material_type_id")
  qualityGrade    String   @default("standard") @map("quality_grade")
  buyPricePerKg   Decimal  @map("buy_price_per_kg") @db.Decimal(10, 2)
  sellPricePerKg  Decimal? @map("sell_price_per_kg") @db.Decimal(10, 2)
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // العلاقات
  dealer          Dealer @relation(fields: [dealerId], references: [id])
  
  @@unique([dealerId, materialTypeId, qualityGrade])
  @@map("dealer_prices")
}

model DealerImage {
  id          String   @id @default(uuid())
  dealerId    String   @map("dealer_id")
  imageUrl    String   @map("image_url")
  caption     String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  
  // العلاقات
  dealer      Dealer @relation(fields: [dealerId], references: [id])
  
  @@index([dealerId])
  @@map("dealer_images")
}

// ============================================
// WALLET & PAYMENTS
// ============================================

model WalletTransaction {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  type            String   // credit, debit, withdrawal, refund
  amount          Decimal  @db.Decimal(12, 2)
  balanceBefore   Decimal  @map("balance_before") @db.Decimal(12, 2)
  balanceAfter    Decimal  @map("balance_after") @db.Decimal(12, 2)
  reference       String?  // transaction_id, withdrawal_id, etc.
  referenceType   String?  @map("reference_type")
  description     String?
  status          String   @default("completed")
  createdAt       DateTime @default(now()) @map("created_at")
  
  // العلاقات
  user            User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("wallet_transactions")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String   // price_alert, pickup_update, transaction, system
  title       String
  body        String
  data        Json?
  isRead      Boolean  @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime @default(now()) @map("created_at")
  
  // العلاقات
  user        User @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

model ExchangeRate {
  id              String   @id @default(uuid())
  baseCurrency    String   @map("base_currency")
  targetCurrency  String   @map("target_currency")
  rate            Decimal  @db.Decimal(10, 4)
  source          String
  effectiveAt     DateTime @map("effective_at")
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([baseCurrency, targetCurrency])
  @@index([effectiveAt(sort: Desc)])
  @@map("exchange_rates")
}
