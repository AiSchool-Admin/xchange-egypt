# ğŸ“Š Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ - Ø³ÙˆÙ‚ Ø§Ù„Ø®Ø±Ø¯Ø©

## Smart Pricing Algorithm - Xchange Scrap Marketplace

---

## ğŸ“‹ Ø§Ù„ÙÙ‡Ø±Ø³

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©](#1-Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©)
2. [Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª](#2-Ù…ØµØ§Ø¯Ø±-Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
3. [Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ](#3-Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©-Ø§Ù„Ø³Ø¹Ø±-Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ)
4. [ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø¹Ø±](#4-ØªØ¹Ø¯ÙŠÙ„Ø§Øª-Ø§Ù„Ø³Ø¹Ø±)
5. [Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© C2B Pricing](#5-Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©-c2b-pricing)
6. [Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±](#6-Ù†Ø¸Ø§Ù…-ØªÙ†Ø¨ÙŠÙ‡Ø§Øª-Ø§Ù„Ø£Ø³Ø¹Ø§Ø±)
7. [Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ù„Ø¨](#7-Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©-Ù…Ø·Ø§Ø¨Ù‚Ø©-Ø§Ù„Ø¹Ø±Ø¶-ÙˆØ§Ù„Ø·Ù„Ø¨)
8. [Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ](#8-Ø§Ù„ØªÙ†ÙÙŠØ°-Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ)

---

## 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

### 1.1 Ø£Ù‡Ø¯Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Ø£Ù‡Ø¯Ø§Ù Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ±                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Ø§Ù„Ø´ÙØ§ÙÙŠØ©    â†’ Ø£Ø³Ø¹Ø§Ø± Ù…ÙˆØ­Ø¯Ø© ÙˆÙ…Ø¹Ù„Ù†Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹                â”‚
â”‚  2. Ø§Ù„Ø¹Ø¯Ø§Ù„Ø©     â†’ Ø³Ø¹Ø± Ø¹Ø§Ø¯Ù„ Ù„Ù„Ø¨Ø§Ø¦Ø¹ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠ                  â”‚
â”‚  3. Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© â†’ ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø± Ø­Ø³Ø¨ Ø§Ù„Ø³ÙˆÙ‚                    â”‚
â”‚  4. Ø§Ù„Ø±Ø¨Ø­ÙŠØ©     â†’ Ù‡Ø§Ù…Ø´ Ø±Ø¨Ø­ Ù„Ù„Ù…Ù†ØµØ© Ù…Ø³ØªØ¯Ø§Ù…                    â”‚
â”‚  5. Ø§Ù„ØªÙ†Ø§ÙØ³ÙŠØ©   â†’ Ø£Ø³Ø¹Ø§Ø± Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ØªØ¯ÙÙ‚ Ø§Ù„ØªØ³Ø¹ÙŠØ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ù…ØµØ§Ø¯Ø±     â”‚â”€â”€â”€â”€â†’â”‚  Ù…Ø­Ø±Ùƒ      â”‚â”€â”€â”€â”€â†’â”‚  Ø³Ø¹Ø±       â”‚
â”‚  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª   â”‚     â”‚  Ø§Ù„ØªØ³Ø¹ÙŠØ±    â”‚     â”‚  Ù†Ù‡Ø§Ø¦ÙŠ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                   â”‚                   â”‚
      â–¼                   â–¼                   â–¼
  â€¢ LME API          â€¢ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©        â€¢ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡
  â€¢ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù        â€¢ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª         â€¢ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
  â€¢ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ     â€¢ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯          â€¢ Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ù†ØµØ©
  â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
```

---

## 2. Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### 2.1 Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©

```typescript
interface ExternalDataSources {
  // Ø¨ÙˆØ±ØµØ© Ù„Ù†Ø¯Ù† Ù„Ù„Ù…Ø¹Ø§Ø¯Ù†
  lme: {
    endpoint: 'https://api.lme.com/v1/prices',
    metals: ['copper', 'aluminium', 'lead', 'zinc', 'nickel'],
    updateFrequency: '1h',
    currency: 'USD'
  };
  
  // Ø³Ø¹Ø± ØµØ±Ù Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
  exchangeRate: {
    endpoint: 'https://api.exchangerate.host/latest',
    baseCurrency: 'USD',
    targetCurrency: 'EGP',
    updateFrequency: '1h'
  };
  
  // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
  steelPrices: {
    endpoint: 'https://api.steelprices.com/v1/scrap',
    updateFrequency: '24h'
  };
}
```

### 2.2 Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø­Ù„ÙŠØ©

```typescript
interface LocalDataSources {
  // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ/Ù…Ø³Ø­ Ù…ÙŠØ¯Ø§Ù†ÙŠ)
  localMarket: {
    source: 'manual_survey',
    locations: ['Ø§Ù„Ø³Ø¨ØªÙŠØ©', 'Ø¹Ø²Ø¨Ø© Ø£Ø¨Ùˆ Ø­Ø´ÙŠØ´', 'Ù…Ù†Ø´Ø£Ø© Ù†Ø§ØµØ±'],
    updateFrequency: 'daily',
    fields: ['material_type', 'quality', 'price_buy', 'price_sell']
  };
  
  // Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
  platformData: {
    source: 'transactions_table',
    metrics: ['avg_price', 'volume', 'trend'],
    window: '7d'
  };
  
  // Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†
  dealerPrices: {
    source: 'dealer_prices_table',
    aggregation: 'weighted_average',
    weight: 'transaction_volume'
  };
}
```

### 2.3 Ø¬Ø¯ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

| Ø§Ù„Ù…ØµØ¯Ø± | Ø§Ù„ØªÙƒØ±Ø§Ø± | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Fallback |
|--------|---------|----------|----------|
| LME | ÙƒÙ„ Ø³Ø§Ø¹Ø© | Ø¹Ø§Ù„ÙŠØ© | Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ù…Ø¹Ø±ÙˆÙØ© |
| Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù | ÙƒÙ„ Ø³Ø§Ø¹Ø© | Ø­Ø±Ø¬Ø© | Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ |
| Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ | ÙŠÙˆÙ…ÙŠØ§Ù‹ | Ø¹Ø§Ù„ÙŠØ© | Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ |
| Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù†ØµØ© | ÙÙˆØ±ÙŠ | Ù…ØªÙˆØ³Ø·Ø© | - |
| Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªØ¬Ø§Ø± | ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª | Ù…ØªÙˆØ³Ø·Ø© | Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ |

---

## 3. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ

### 3.1 Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

```typescript
/**
 * Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù„Ù„Ù…Ø¹Ø¯Ù†
 * Reference Price = Weighted Average of Multiple Sources
 */
function calculateReferencePrice(
  materialType: MaterialType,
  governorate?: string
): ReferencePrice {
  
  // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø±
  const lmePrice = getLMEPrice(materialType);
  const exchangeRate = getExchangeRate('USD', 'EGP');
  const localMarketPrice = getLocalMarketPrice(materialType, governorate);
  const platformAvgPrice = getPlatformAveragePrice(materialType, '7d');
  const dealerAvgPrice = getDealerAveragePrice(materialType, governorate);
  
  // 2. ØªØ­ÙˆÙŠÙ„ LME Ø¥Ù„Ù‰ Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ
  const lmePriceEGP = lmePrice * exchangeRate;
  
  // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙˆØ²Ø§Ù† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
  const weights = getWeights(materialType);
  
  // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…ÙˆØ²ÙˆÙ†
  const referencePrice = 
    (lmePriceEGP * weights.lme) +
    (localMarketPrice * weights.local) +
    (platformAvgPrice * weights.platform) +
    (dealerAvgPrice * weights.dealer);
  
  return {
    price: Math.round(referencePrice * 100) / 100,
    confidence: calculateConfidence(weights, dataQuality),
    sources: { lme: lmePriceEGP, local: localMarketPrice, platform: platformAvgPrice },
    updatedAt: new Date()
  };
}
```

### 3.2 Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©

```typescript
const sourceWeights: Record<MaterialCategory, SourceWeights> = {
  // Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† ØºÙŠØ± Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠØ© (Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‚ÙˆØ© Ø¨Ù€ LME)
  'non_ferrous_metals': {
    lme: 0.40,      // 40% Ù…Ù† LME
    local: 0.30,    // 30% Ù…Ù† Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ
    platform: 0.20, // 20% Ù…Ù† Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù†ØµØ©
    dealer: 0.10    // 10% Ù…Ù† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªØ¬Ø§Ø±
  },
  
  // Ø§Ù„Ø­Ø¯ÙŠØ¯ ÙˆØ§Ù„ØµÙ„Ø¨ (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ù‡Ù…)
  'ferrous_metals': {
    lme: 0.20,
    local: 0.45,
    platform: 0.25,
    dealer: 0.10
  },
  
  // Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒ ÙˆØ§Ù„ÙˆØ±Ù‚ (Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·)
  'recyclables': {
    lme: 0.00,
    local: 0.50,
    platform: 0.35,
    dealer: 0.15
  },
  
  // Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª (Ù…Ø¹Ù‚Ø¯ - ÙŠØ­ØªØ§Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø®Ø§Øµ)
  'electronics': {
    lme: 0.15,      // Ù„Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ø«Ù…ÙŠÙ†Ø©
    local: 0.40,
    platform: 0.30,
    dealer: 0.15
  }
};
```

### 3.3 Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø«Ù‚Ø© (Confidence Score)

```typescript
/**
 * Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø«Ù‚Ø© ÙÙŠ Ø§Ù„Ø³Ø¹Ø±
 * 0-100 Ø­ÙŠØ« 100 = Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹
 */
function calculateConfidence(
  dataQuality: DataQuality,
  sourceAvailability: SourceAvailability
): number {
  let confidence = 100;
  
  // Ø®ØµÙ… Ù„Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ù…ØµØ§Ø¯Ø±
  if (!sourceAvailability.lme) confidence -= 15;
  if (!sourceAvailability.local) confidence -= 25;
  if (!sourceAvailability.platform) confidence -= 10;
  
  // Ø®ØµÙ… Ù„Ù‚Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const hoursOld = dataQuality.hoursOld;
  if (hoursOld > 24) confidence -= 20;
  else if (hoursOld > 12) confidence -= 10;
  else if (hoursOld > 6) confidence -= 5;
  
  // Ø®ØµÙ… Ù„Ù„ØªÙ‚Ù„Ø¨ Ø§Ù„Ø¹Ø§Ù„ÙŠ
  if (dataQuality.volatility > 10) confidence -= 15;
  else if (dataQuality.volatility > 5) confidence -= 5;
  
  return Math.max(0, Math.min(100, confidence));
}
```

---

## 4. ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø¹Ø±

### 4.1 ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø©

```typescript
const qualityMultipliers: Record<MaterialType, Record<QualityGrade, number>> = {
  'iron_scrap': {
    'premium': 1.08,    // +8% Ù„Ù„Ù…Ù…ØªØ§Ø²
    'standard': 1.00,   // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    'mixed': 0.92,      // -8% Ù„Ù„Ù…Ø®Ù„ÙˆØ·
    'low': 0.82         // -18% Ù„Ù„Ù…Ù†Ø®ÙØ¶
  },
  
  'copper_red': {
    'shiny': 1.12,      // +12% Ù„Ù„Ø§Ù…Ø¹ Ù†Ø¸ÙŠÙ
    'standard': 1.00,
    'mixed': 0.88,
    'burnt': 0.75       // -25% Ù„Ù„Ù…Ø­Ø±ÙˆÙ‚
  },
  
  'aluminium': {
    'clean': 1.10,
    'standard': 1.00,
    'painted': 0.85,    // -15% Ù„Ù„Ù…Ø¯Ù‡ÙˆÙ†
    'mixed': 0.80
  },
  
  'electronics': {
    'working': 1.80,    // +80% Ù„Ù„Ø¹Ø§Ù…Ù„
    'repairable': 1.30, // +30% Ù„Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥ØµÙ„Ø§Ø­
    'for_parts': 1.00,
    'scrap': 0.60       // -40% Ù„Ù„Ø®Ø±Ø¯Ø© ÙÙ‚Ø·
  }
};

function applyQualityAdjustment(
  basePrice: number,
  materialType: MaterialType,
  quality: QualityGrade
): number {
  const multiplier = qualityMultipliers[materialType]?.[quality] ?? 1.0;
  return basePrice * multiplier;
}
```

### 4.2 ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©

```typescript
/**
 * Ø®ØµÙ…/Ø¹Ù„Ø§ÙˆØ© Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ©
 * Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© = Ø³Ø¹Ø± Ø£ÙØ¶Ù„
 * Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ØµØºÙŠØ±Ø© = Ø®ØµÙ… Ø¨Ø³ÙŠØ·
 */
function applyQuantityAdjustment(
  basePrice: number,
  quantityKg: number,
  materialType: MaterialType
): number {
  const thresholds = getQuantityThresholds(materialType);
  
  if (quantityKg >= thresholds.bulk) {
    // ÙƒÙ…ÙŠØ© ÙƒØ¨ÙŠØ±Ø© (> 1 Ø·Ù† Ø¹Ø§Ø¯Ø©)
    return basePrice * 1.05; // +5%
  } else if (quantityKg >= thresholds.medium) {
    // ÙƒÙ…ÙŠØ© Ù…ØªÙˆØ³Ø·Ø© (100-1000 ÙƒØ¬Ù…)
    return basePrice * 1.00; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  } else if (quantityKg >= thresholds.small) {
    // ÙƒÙ…ÙŠØ© ØµØºÙŠØ±Ø© (10-100 ÙƒØ¬Ù…)
    return basePrice * 0.97; // -3%
  } else {
    // ÙƒÙ…ÙŠØ© ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (< 10 ÙƒØ¬Ù…)
    return basePrice * 0.93; // -7%
  }
}

const quantityThresholds: Record<MaterialCategory, QuantityThresholds> = {
  'metals': { bulk: 1000, medium: 100, small: 10 },
  'electronics': { bulk: 50, medium: 10, small: 2 },
  'recyclables': { bulk: 500, medium: 50, small: 5 }
};
```

### 4.3 ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹

```typescript
/**
 * ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
 * Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
 * Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø© = Ø®ØµÙ… Ù„Ù„Ù†Ù‚Ù„
 */
const locationMultipliers: Record<string, number> = {
  // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰ (Ø§Ù„Ù…Ø±Ø¬Ø¹)
  'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©': 1.00,
  'Ø§Ù„Ø¬ÙŠØ²Ø©': 1.00,
  'Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©': 0.98,
  
  // Ø§Ù„Ø¯Ù„ØªØ§ ÙˆØ§Ù„ÙˆØ¬Ù‡ Ø§Ù„Ø¨Ø­Ø±ÙŠ
  'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©': 0.97,
  'Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©': 0.95,
  'Ø§Ù„Ø´Ø±Ù‚ÙŠØ©': 0.96,
  'Ø§Ù„ØºØ±Ø¨ÙŠØ©': 0.95,
  'Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©': 0.96,
  'Ø§Ù„Ø¨Ø­ÙŠØ±Ø©': 0.94,
  
  // Ø§Ù„ØµØ¹ÙŠØ¯
  'Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ': 0.93,
  'Ø§Ù„Ù…Ù†ÙŠØ§': 0.91,
  'Ø£Ø³ÙŠÙˆØ·': 0.89,
  'Ø³ÙˆÙ‡Ø§Ø¬': 0.87,
  'Ù‚Ù†Ø§': 0.85,
  'Ø§Ù„Ø£Ù‚ØµØ±': 0.84,
  'Ø£Ø³ÙˆØ§Ù†': 0.82,
  
  // Ø§Ù„Ù‚Ù†Ø§Ø© ÙˆØ³ÙŠÙ†Ø§Ø¡
  'Ø§Ù„Ø³ÙˆÙŠØ³': 0.98,
  'Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©': 0.96,
  'Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯': 0.95,
  
  // Ù…Ù†Ø§Ø·Ù‚ ØµÙ†Ø§Ø¹ÙŠØ© (Ø£Ø³Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰)
  'Ø§Ù„Ø¹Ø§Ø´Ø± Ù…Ù† Ø±Ù…Ø¶Ø§Ù†': 1.02,
  '6 Ø£ÙƒØªÙˆØ¨Ø±': 1.02,
  'Ø§Ù„Ø³Ø§Ø¯Ø§Øª': 1.01
};

function applyLocationAdjustment(
  basePrice: number,
  governorate: string
): number {
  const multiplier = locationMultipliers[governorate] ?? 0.90;
  return basePrice * multiplier;
}
```

---

## 5. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© C2B Pricing

### 5.1 Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¹ÙŠØ± Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ù…Ø¹

```typescript
/**
 * Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¬Ù…Ø¹ Ù…Ù† Ø§Ù„Ø¨Ø§Ø¨
 * 
 * Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ = Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ - Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ù†ØµØ© - ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬Ù…Ø¹
 */
interface C2BPricingResult {
  customerPrice: number;      // Ù…Ø§ ÙŠØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¹Ù…ÙŠÙ„
  platformMargin: number;     // Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ù†ØµØ©
  collectorPayout: number;    // Ù…Ø§ ÙŠØ­ØµÙ„ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¬Ø§Ù…Ø¹
  breakdown: PriceBreakdown;
}

function calculateC2BPrice(
  materials: MaterialInput[],
  location: Location,
  options: C2BOptions
): C2BPricingResult {
  
  let totalReferencePrice = 0;
  let breakdown: PriceBreakdown[] = [];
  
  // 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©
  for (const material of materials) {
    const refPrice = calculateReferencePrice(material.type, location.governorate);
    const qualityAdjusted = applyQualityAdjustment(refPrice.price, material.type, material.quality);
    const quantityAdjusted = applyQuantityAdjustment(qualityAdjusted, material.weightKg, material.type);
    const locationAdjusted = applyLocationAdjustment(quantityAdjusted, location.governorate);
    
    const materialTotal = locationAdjusted * material.weightKg;
    totalReferencePrice += materialTotal;
    
    breakdown.push({
      materialType: material.type,
      weightKg: material.weightKg,
      pricePerKg: locationAdjusted,
      total: materialTotal
    });
  }
  
  // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´
  const platformMarginRate = getPlatformMarginRate(totalReferencePrice, location);
  const platformMargin = totalReferencePrice * platformMarginRate;
  
  // 3. Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„
  const customerPrice = totalReferencePrice - platformMargin;
  
  // 4. Ø­ØµØ© Ø§Ù„Ø¬Ø§Ù…Ø¹
  const collectorRate = getCollectorRate(location);
  const collectorPayout = platformMargin * collectorRate;
  
  return {
    customerPrice: Math.round(customerPrice),
    platformMargin: Math.round(platformMargin),
    collectorPayout: Math.round(collectorPayout),
    breakdown
  };
}
```

### 5.2 Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ù…Ù†ØµØ©

```typescript
/**
 * Ù‡Ø§Ù…Ø´ Ø§Ù„Ù…Ù†ØµØ© ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰:
 * 1. Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© (Ø£Ù‚Ù„ = Ù‡Ø§Ù…Ø´ Ø£Ø¹Ù„Ù‰)
 * 2. Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø¨Ø¹ÙŠØ¯ = Ù‡Ø§Ù…Ø´ Ø£Ø¹Ù„Ù‰)
 * 3. Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
 */
function getPlatformMarginRate(
  transactionValue: number,
  location: Location
): number {
  // Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
  let baseMargin: number;
  
  if (transactionValue < 100) {
    baseMargin = 0.25; // 25% Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹
  } else if (transactionValue < 500) {
    baseMargin = 0.20; // 20%
  } else if (transactionValue < 2000) {
    baseMargin = 0.15; // 15%
  } else if (transactionValue < 10000) {
    baseMargin = 0.12; // 12%
  } else {
    baseMargin = 0.10; // 10% Ù„Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
  }
  
  // ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  const locationFactor = getLocationCostFactor(location);
  
  return baseMargin * locationFactor;
}

// ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‡Ø§Ù…Ø´
const marginDistribution = {
  platformNet: 0.40,      // 40% ØµØ§ÙÙŠ Ø±Ø¨Ø­ Ø§Ù„Ù…Ù†ØµØ©
  collectorPayout: 0.50,  // 50% Ù„Ù„Ø¬Ø§Ù…Ø¹
  operations: 0.10        // 10% ØªÙƒØ§Ù„ÙŠÙ ØªØ´ØºÙŠÙ„ÙŠØ©
};
```

### 5.3 Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø·Ù„Ø¨

```typescript
const minimumOrderConfig = {
  // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨
  minOrderValue: 50, // 50 Ø¬Ù†ÙŠÙ‡
  
  // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙˆØ²Ù† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©
  minWeight: {
    'metals': 1,        // 1 ÙƒØ¬Ù…
    'electronics': 0.5, // 0.5 ÙƒØ¬Ù…
    'recyclables': 2    // 2 ÙƒØ¬Ù…
  },
  
  // Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
  smallOrderFee: {
    threshold: 100,     // Ø¥Ø°Ø§ Ø£Ù‚Ù„ Ù…Ù† 100 Ø¬Ù†ÙŠÙ‡
    fee: 10             // Ø±Ø³ÙˆÙ… 10 Ø¬Ù†ÙŠÙ‡
  }
};
```

---

## 6. Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø±

### 6.1 Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª

```typescript
interface PriceAlert {
  id: string;
  userId: string;
  materialTypeId: string;
  alertType: 'above' | 'below' | 'change_percent';
  threshold: number;
  isActive: boolean;
  lastTriggered?: Date;
  createdAt: Date;
}

// Ø£Ù…Ø«Ù„Ø©:
// - Ù†Ø¨Ù‡Ù†ÙŠ Ø¥Ø°Ø§ Ø§Ù„Ù†Ø­Ø§Ø³ ÙˆØµÙ„ 600 Ø¬/ÙƒØ¬Ù…
// - Ù†Ø¨Ù‡Ù†ÙŠ Ø¥Ø°Ø§ Ø§Ù„Ø­Ø¯ÙŠØ¯ Ù†Ø²Ù„ Ø¹Ù† 38 Ø¬/ÙƒØ¬Ù…
// - Ù†Ø¨Ù‡Ù†ÙŠ Ø¥Ø°Ø§ ØªØºÙŠØ± Ø£ÙŠ Ø³Ø¹Ø± Ø£ÙƒØ«Ø± Ù…Ù† 5%
```

### 6.2 Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª

```typescript
/**
 * ÙØ­Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
 */
async function checkPriceAlerts(
  materialTypeId: string,
  newPrice: number,
  oldPrice: number
): Promise<void> {
  
  // 1. Ø¬Ù„Ø¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø©
  const alerts = await getActiveAlerts(materialTypeId);
  
  for (const alert of alerts) {
    let shouldTrigger = false;
    let message = '';
    
    switch (alert.alertType) {
      case 'above':
        if (newPrice >= alert.threshold && oldPrice < alert.threshold) {
          shouldTrigger = true;
          message = `Ø³Ø¹Ø± ${alert.materialName} ÙˆØµÙ„ ${newPrice} Ø¬/ÙƒØ¬Ù…`;
        }
        break;
        
      case 'below':
        if (newPrice <= alert.threshold && oldPrice > alert.threshold) {
          shouldTrigger = true;
          message = `Ø³Ø¹Ø± ${alert.materialName} Ù†Ø²Ù„ Ø¥Ù„Ù‰ ${newPrice} Ø¬/ÙƒØ¬Ù…`;
        }
        break;
        
      case 'change_percent':
        const changePercent = ((newPrice - oldPrice) / oldPrice) * 100;
        if (Math.abs(changePercent) >= alert.threshold) {
          shouldTrigger = true;
          const direction = changePercent > 0 ? 'Ø§Ø±ØªÙØ¹' : 'Ø§Ù†Ø®ÙØ¶';
          message = `${alert.materialName} ${direction} ${Math.abs(changePercent).toFixed(1)}%`;
        }
        break;
    }
    
    if (shouldTrigger) {
      await sendNotification(alert.userId, {
        type: 'price_alert',
        title: 'ğŸ“Š ØªÙ†Ø¨ÙŠÙ‡ Ø³Ø¹Ø±',
        body: message,
        data: { materialTypeId, newPrice, alertId: alert.id }
      });
      
      await updateAlertLastTriggered(alert.id);
    }
  }
}
```

---

## 7. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø·Ù„Ø¨

### 7.1 Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©

```typescript
/**
 * Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡
 */
interface MatchResult {
  sellListing: Listing;
  buyListing: Listing;
  matchScore: number;
  priceGap: number;
  distanceKm: number;
  recommendation: 'high' | 'medium' | 'low';
}

async function findMatches(
  listing: Listing
): Promise<MatchResult[]> {
  
  const oppositeType = listing.listingType === 'sell' ? 'buy' : 'sell';
  
  // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø©
  const candidates = await getListings({
    type: oppositeType,
    materialTypeId: listing.materialTypeId,
    status: 'active',
    governorate: listing.governorate // Ù†ÙØ³ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹
  });
  
  // 2. Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
  const matches: MatchResult[] = [];
  
  for (const candidate of candidates) {
    const score = calculateMatchScore(listing, candidate);
    
    if (score.total >= 50) { // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 50%
      matches.push({
        sellListing: listing.listingType === 'sell' ? listing : candidate,
        buyListing: listing.listingType === 'buy' ? listing : candidate,
        matchScore: score.total,
        priceGap: score.priceGap,
        distanceKm: score.distance,
        recommendation: getRecommendation(score.total)
      });
    }
  }
  
  // 3. ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø£ÙØ¶Ù„ Ù…Ø·Ø§Ø¨Ù‚Ø©
  return matches.sort((a, b) => b.matchScore - a.matchScore);
}
```

### 7.2 Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©

```typescript
interface MatchScore {
  total: number;
  priceScore: number;
  quantityScore: number;
  qualityScore: number;
  locationScore: number;
  priceGap: number;
  distance: number;
}

function calculateMatchScore(
  listing1: Listing,
  listing2: Listing
): MatchScore {
  
  // 1. Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø³Ø¹Ø± (40% Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·)
  const priceDiff = Math.abs(listing1.pricePerKg - listing2.pricePerKg);
  const avgPrice = (listing1.pricePerKg + listing2.pricePerKg) / 2;
  const priceGapPercent = (priceDiff / avgPrice) * 100;
  
  let priceScore: number;
  if (priceGapPercent <= 5) priceScore = 100;
  else if (priceGapPercent <= 10) priceScore = 80;
  else if (priceGapPercent <= 15) priceScore = 60;
  else if (priceGapPercent <= 20) priceScore = 40;
  else priceScore = 20;
  
  // 2. Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ÙƒÙ…ÙŠØ© (25% Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·)
  const quantityRatio = Math.min(listing1.quantityKg, listing2.quantityKg) /
                        Math.max(listing1.quantityKg, listing2.quantityKg);
  const quantityScore = quantityRatio * 100;
  
  // 3. Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© (20% Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·)
  const qualityScore = listing1.qualityGrade === listing2.qualityGrade ? 100 :
                       areQualitiesCompatible(listing1.qualityGrade, listing2.qualityGrade) ? 70 : 40;
  
  // 4. Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ (15% Ù…Ù† Ø§Ù„Ù†Ù‚Ø§Ø·)
  const distance = calculateDistance(listing1.location, listing2.location);
  let locationScore: number;
  if (distance <= 5) locationScore = 100;
  else if (distance <= 20) locationScore = 80;
  else if (distance <= 50) locationScore = 60;
  else if (distance <= 100) locationScore = 40;
  else locationScore = 20;
  
  // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ÙˆØ²ÙˆÙ†
  const total = 
    (priceScore * 0.40) +
    (quantityScore * 0.25) +
    (qualityScore * 0.20) +
    (locationScore * 0.15);
  
  return {
    total: Math.round(total),
    priceScore,
    quantityScore,
    qualityScore,
    locationScore,
    priceGap: priceDiff,
    distance
  };
}
```

---

## 8. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ

### 8.1 Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ³Ø¹ÙŠØ± (PricingService)

```typescript
// services/pricing.service.ts

import { Injectable } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import { PrismaService } from './prisma.service';
import { LMEService } from './lme.service';
import { ExchangeRateService } from './exchange-rate.service';
import { NotificationService } from './notification.service';

@Injectable()
export class PricingService {
  constructor(
    private prisma: PrismaService,
    private lme: LMEService,
    private exchangeRate: ExchangeRateService,
    private notifications: NotificationService
  ) {}

  /**
   * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙƒÙ„ Ø³Ø§Ø¹Ø©
   */
  @Cron(CronExpression.EVERY_HOUR)
  async updatePrices(): Promise<void> {
    console.log('Starting price update job...');
    
    try {
      // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
      const lmePrices = await this.lme.fetchLatestPrices();
      const usdToEgp = await this.exchangeRate.getRate('USD', 'EGP');
      
      // 2. ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ù†ÙˆØ¹ Ù…Ø§Ø¯Ø©
      const materialTypes = await this.prisma.materialType.findMany({
        where: { isActive: true }
      });
      
      for (const material of materialTypes) {
        const oldPrice = await this.getCurrentPrice(material.id);
        const newPrice = await this.calculateNewPrice(material, lmePrices, usdToEgp);
        
        // 3. Ø­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        await this.savePrice(material.id, newPrice);
        
        // 4. ÙØ­Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
        if (oldPrice) {
          await this.checkPriceAlerts(material.id, newPrice.price, oldPrice.price);
        }
      }
      
      console.log('Price update completed successfully');
    } catch (error) {
      console.error('Price update failed:', error);
      // Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
      await this.notifications.alertAdmins('Price update failed', error);
    }
  }

  /**
   * Ø­Ø³Ø§Ø¨ Ø³Ø¹Ø± Ø·Ù„Ø¨ Ø¬Ù…Ø¹
   */
  async calculatePickupPrice(
    materials: { materialTypeId: string; weightKg: number; quality: string }[],
    governorate: string
  ): Promise<C2BPricingResult> {
    let totalCustomerPrice = 0;
    let totalPlatformMargin = 0;
    const breakdown: PriceBreakdown[] = [];
    
    for (const item of materials) {
      const price = await this.getCurrentPrice(item.materialTypeId);
      if (!price) continue;
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
      let adjustedPrice = price.price;
      adjustedPrice = this.applyQualityAdjustment(adjustedPrice, item.materialTypeId, item.quality);
      adjustedPrice = this.applyQuantityAdjustment(adjustedPrice, item.weightKg);
      adjustedPrice = this.applyLocationAdjustment(adjustedPrice, governorate);
      
      const itemTotal = adjustedPrice * item.weightKg;
      const itemMargin = itemTotal * this.getPlatformMarginRate(itemTotal, governorate);
      
      totalCustomerPrice += (itemTotal - itemMargin);
      totalPlatformMargin += itemMargin;
      
      breakdown.push({
        materialTypeId: item.materialTypeId,
        weightKg: item.weightKg,
        pricePerKg: adjustedPrice,
        subtotal: itemTotal,
        customerGets: itemTotal - itemMargin
      });
    }
    
    return {
      customerPrice: Math.round(totalCustomerPrice),
      platformMargin: Math.round(totalPlatformMargin),
      collectorPayout: Math.round(totalPlatformMargin * 0.5),
      breakdown,
      validUntil: new Date(Date.now() + 30 * 60 * 1000) // ØµØ§Ù„Ø­ Ù„Ù…Ø¯Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©
    };
  }

  /**
   * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
   */
  async getAllCurrentPrices(governorate?: string): Promise<PriceListItem[]> {
    const prices = await this.prisma.price.findMany({
      where: {
        effectiveDate: { lte: new Date() },
        OR: [
          { expiryDate: null },
          { expiryDate: { gt: new Date() } }
        ],
        governorate: governorate ?? null
      },
      include: {
        materialType: {
          include: { category: true }
        }
      },
      orderBy: [
        { materialType: { category: { sortOrder: 'asc' } } },
        { materialType: { sortOrder: 'asc' } }
      ]
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºÙŠØ±
    return Promise.all(prices.map(async (price) => {
      const yesterdayPrice = await this.getPriceAt(
        price.materialTypeId,
        new Date(Date.now() - 24 * 60 * 60 * 1000)
      );
      
      const change24h = yesterdayPrice 
        ? ((price.pricePerKg - yesterdayPrice.pricePerKg) / yesterdayPrice.pricePerKg) * 100
        : 0;
      
      return {
        ...price,
        change24h: Math.round(change24h * 10) / 10
      };
    }));
  }
}
```

### 8.2 API Endpoints

```typescript
// controllers/prices.controller.ts

@Controller('api/prices')
export class PricesController {
  constructor(private pricingService: PricingService) {}

  /**
   * GET /api/prices
   * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
   */
  @Get()
  async getAllPrices(
    @Query('governorate') governorate?: string,
    @Query('categoryId') categoryId?: string
  ): Promise<ApiResponse<PriceListItem[]>> {
    const prices = await this.pricingService.getAllCurrentPrices(governorate);
    
    const filtered = categoryId
      ? prices.filter(p => p.materialType.categoryId === categoryId)
      : prices;
    
    return {
      success: true,
      data: filtered,
      meta: {
        lastUpdated: new Date(),
        count: filtered.length
      }
    };
  }

  /**
   * POST /api/prices/calculate
   * Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø±Ø¯Ø©
   */
  @Post('calculate')
  async calculateValue(
    @Body() body: CalculateValueDto
  ): Promise<ApiResponse<C2BPricingResult>> {
    const result = await this.pricingService.calculatePickupPrice(
      body.materials,
      body.governorate
    );
    
    return {
      success: true,
      data: result
    };
  }

  /**
   * GET /api/prices/history/:materialTypeId
   * ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
   */
  @Get('history/:materialTypeId')
  async getPriceHistory(
    @Param('materialTypeId') materialTypeId: string,
    @Query('period') period: '7d' | '30d' | '90d' | '1y' = '30d'
  ): Promise<ApiResponse<PriceHistoryPoint[]>> {
    const history = await this.pricingService.getPriceHistory(materialTypeId, period);
    
    return {
      success: true,
      data: history
    };
  }
}
```

---

## ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª

| Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© | Ø§Ù„Ù‡Ø¯Ù | Ø§Ù„ØªÙƒØ±Ø§Ø± |
|------------|-------|---------|
| Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ | Ø³Ø¹Ø± Ù…ÙˆØ­Ø¯ Ù„Ù„Ø³ÙˆÙ‚ | ÙƒÙ„ Ø³Ø§Ø¹Ø© |
| ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø© | Ø¹Ø¯Ø§Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ÙŠØ© | Ù„Ø­Ø¸ÙŠ |
| ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© | Ø­ÙˆØ§ÙØ² Ù„Ù„ÙƒÙ…ÙŠØ§Øª | Ù„Ø­Ø¸ÙŠ |
| ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ | ØªØºØ·ÙŠØ© ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù†Ù‚Ù„ | Ù„Ø­Ø¸ÙŠ |
| C2B Pricing | Ø³Ø¹Ø± Ø¹Ø§Ø¯Ù„ + Ù‡Ø§Ù…Ø´ | Ù„Ø­Ø¸ÙŠ |
| ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± | Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† | Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠØ± |
| Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© | Ø±Ø¨Ø· Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¨Ø§Ù„Ù…Ø´ØªØ±ÙŠ | Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ |

---

*Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø¯ÙŠØ³Ù…Ø¨Ø± 2024*
*Xchange Egypt - Scrap Marketplace*
