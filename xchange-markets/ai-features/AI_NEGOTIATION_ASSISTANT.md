# ğŸ¤– Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø§Ù„Ø°ÙƒÙŠ - AI Negotiation Assistant
## Xchange AI-Powered Negotiation System

**Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:** ğŸ”¥ Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹
**Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:** +25% conversion rate
**ØµØ¹ÙˆØ¨Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±:** Ù…ØªÙˆØ³Ø·Ø©
**Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±:** 8-10 Ø£Ø³Ø§Ø¨ÙŠØ¹

---

## ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©](#Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©)
2. [Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©](#Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª-Ø§Ù„ØªÙ‚Ù†ÙŠØ©)
3. [Database Schema](#database-schema)
4. [API Endpoints](#api-endpoints)
5. [Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª AI](#Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª-ai)
6. [User Stories](#user-stories)
7. [Implementation Guide](#implementation-guide)
8. [Security & Privacy](#security-privacy)

---

## 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© {#Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©}

### 1.1 Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
- **40%** Ù…Ù† Ø§Ù„ØµÙÙ‚Ø§Øª ØªÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø§ØªÙØ§Ù‚ Ø³Ø¹Ø±ÙŠ
- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù„Ø§ ÙŠØ¹Ø±ÙÙˆÙ† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ Ù„Ù„ØªÙØ§ÙˆØ¶
- Ø§Ù„ØªÙØ§ÙˆØ¶ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ (Ù…Ø¹Ø¯Ù„ 5-7 Ø£ÙŠØ§Ù…)
- Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ³ÙŠØ· Ù…Ø­Ø§ÙŠØ¯ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ø±ÙÙŠÙ†

### 1.2 Ø§Ù„Ø­Ù„
Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØ¹Ù…Ù„ ÙƒÙ€ **ÙˆØ³ÙŠØ· Ù…Ø­Ø§ÙŠØ¯** ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠ Ø¹Ù„Ù‰:
- ÙÙ‡Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ Ù„Ù„Ù…Ù†ØªØ¬
- ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±ÙˆØ¶ Ù…Ù†Ø·Ù‚ÙŠØ©
- Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø§ØªÙØ§Ù‚ Ø³Ø±ÙŠØ¹ ÙˆØ¹Ø§Ø¯Ù„
- ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„ØªÙØ§ÙˆØ¶

### 1.3 Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ÙÙˆØ§Ø¦Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ù„Ù„Ù…Ø´ØªØ±ÙŠ:                                                   â”‚
â”‚  âœ… Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„                                      â”‚
â”‚  âœ… Ù†ØµØ§Ø¦Ø­ ØªÙØ§ÙˆØ¶ÙŠØ© Ø°ÙƒÙŠØ©                                      â”‚
â”‚  âœ… ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø§Ù„ (Ù…Ø¹Ø¯Ù„ 8-12%)                                â”‚
â”‚  âœ… ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª (50% Ø£Ø³Ø±Ø¹)                                  â”‚
â”‚                                                              â”‚
â”‚  Ù„Ù„Ø¨Ø§Ø¦Ø¹:                                                     â”‚
â”‚  âœ… Ø¨ÙŠØ¹ Ø£Ø³Ø±Ø¹ (Ù…Ø¹Ø¯Ù„ 3 Ø£ÙŠØ§Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 7)                       â”‚
â”‚  âœ… Ø³Ø¹Ø± Ø¹Ø§Ø¯Ù„ (Ù„Ø§ ØªÙØ±ÙŠØ·)                                     â”‚
â”‚  âœ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©                               â”‚
â”‚                                                              â”‚
â”‚  Ù„Ù„Ù…Ù†ØµØ©:                                                     â”‚
â”‚  âœ… Ø²ÙŠØ§Ø¯Ø© Ù…Ø¹Ø¯Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØµÙÙ‚Ø§Øª +25%                           â”‚
â”‚  âœ… ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                                     â”‚
â”‚  âœ… Ù…ÙŠØ²Ø© ØªÙ†Ø§ÙØ³ÙŠØ© ÙØ±ÙŠØ¯Ø©                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© {#Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª-Ø§Ù„ØªÙ‚Ù†ÙŠØ©}

### 2.1 Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ARCHITECTURE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  User    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  Next.js     â”‚                     â”‚
â”‚  â”‚ (Mobile/ â”‚         â”‚  Frontend    â”‚                     â”‚
â”‚  â”‚  Web)    â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                              â”‚
â”‚                               â–¼                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                    â”‚  API Gateway     â”‚                     â”‚
â”‚                    â”‚  (Express)       â”‚                     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                             â”‚                                â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚        â–¼                    â–¼                  â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚Negotiationâ”‚      â”‚  AI Engine   â”‚    â”‚Pricing   â”‚       â”‚
â”‚  â”‚ Service  â”‚      â”‚  (GPT-4 +    â”‚    â”‚Service   â”‚       â”‚
â”‚  â”‚          â”‚      â”‚   Custom ML) â”‚    â”‚          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
â”‚       â”‚                   â”‚                  â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                   â–¼                                          â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â”‚   PostgreSQL DB      â”‚                             â”‚
â”‚        â”‚  + Redis Cache       â”‚                             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                   â”‚                                          â”‚
â”‚                   â–¼                                          â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚        â”‚  External Services   â”‚                             â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚        â”‚ â€¢ OpenAI GPT-4       â”‚                             â”‚
â”‚        â”‚ â€¢ Sentiment Analysis â”‚                             â”‚
â”‚        â”‚ â€¢ Translation API    â”‚                             â”‚
â”‚        â”‚ â€¢ Notification Svc   â”‚                             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Technology Stack

| Component | Technology | Purpose |
|-----------|------------|---------|
| **Frontend** | Next.js 14, TypeScript, TailwindCSS | UI/UX |
| **Backend** | Node.js, Express, TypeScript | API Server |
| **AI/ML** | OpenAI GPT-4 Turbo, Custom ML models | Negotiation Intelligence |
| **Database** | PostgreSQL 16 | Primary data storage |
| **Cache** | Redis 7 | Real-time session data |
| **Queue** | Bull (Redis-based) | Async AI processing |
| **NLP** | spaCy, Transformers | Arabic text analysis |
| **Analytics** | Mixpanel, Custom ML | User behavior tracking |

### 2.3 System Requirements

**Performance:**
- Response time: < 1.5 seconds Ù„Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ©
- Concurrent users: 10,000+ simultaneous negotiations
- AI processing: < 3 seconds Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶

**Scalability:**
- Horizontal scaling Ù„Ù„Ù€ AI service
- Redis cluster Ù„Ù„Ù€ sessions
- PostgreSQL read replicas

---

## 3. Database Schema {#database-schema}

### 3.1 Prisma Schema

```prisma
// ============================================
// AI NEGOTIATION ASSISTANT SCHEMA
// ============================================

enum NegotiationStatus {
  INITIATED        // Ø¨Ø¯Ø£ Ø§Ù„ØªÙØ§ÙˆØ¶
  ONGOING          // Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙØ§ÙˆØ¶
  OFFER_MADE       // ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶
  COUNTER_OFFERED  // Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯
  AGREED           // ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚
  REJECTED         // Ù…Ø±ÙÙˆØ¶
  EXPIRED          // Ù…Ù†ØªÙ‡ÙŠ
  COMPLETED        // Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨ÙŠØ¹
}

enum MessageSender {
  BUYER            // Ø§Ù„Ù…Ø´ØªØ±ÙŠ
  SELLER           // Ø§Ù„Ø¨Ø§Ø¦Ø¹
  AI_ASSISTANT     // Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
  SYSTEM           // Ø§Ù„Ù†Ø¸Ø§Ù…
}

enum OfferType {
  INITIAL          // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠ
  COUNTER          // Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯
  FINAL            // Ø¹Ø±Ø¶ Ù†Ù‡Ø§Ø¦ÙŠ
  AI_SUGGESTED     // Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ù† AI
}

enum NegotiationStrategy {
  AGGRESSIVE       // Ù…ØªØ´Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø³Ø¹Ø±
  BALANCED         // Ù…ØªÙˆØ§Ø²Ù†
  FLEXIBLE         // Ù…Ø±Ù†
  QUICK_SALE       // Ø¨ÙŠØ¹ Ø³Ø±ÙŠØ¹
}

model NegotiationSession {
  id                    String              @id @default(uuid())

  // Parties
  listingId             String
  listing               Listing             @relation(fields: [listingId], references: [id])
  buyerId               String
  buyer                 User                @relation("NegotiationBuyer", fields: [buyerId], references: [id])
  sellerId              String
  seller                User                @relation("NegotiationSeller", fields: [sellerId], references: [id])

  // Session Details
  status                NegotiationStatus   @default(INITIATED)

  // Initial Context
  listingPrice          Float               // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù†
  buyerInitialOffer     Float?              // Ø£ÙˆÙ„ Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ

  // AI Analysis
  fairMarketValue       Float               // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯Ù„Ø© (Ù…Ù† AI)
  recommendedPrice      Float               // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡
  priceRange            Json                // {min, max, optimal}
  aiConfidence          Float               // Ø«Ù‚Ø© AI (0-100)

  // Negotiation Dynamics
  currentOffer          Float?              // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
  lastOfferedBy         String?             // Ø¢Ø®Ø± Ù…Ù† Ù‚Ø¯Ù… Ø¹Ø±Ø¶ (buyerId or sellerId)
  offerCount            Int                 @default(0)

  // AI Strategy
  buyerStrategy         NegotiationStrategy @default(BALANCED)
  sellerStrategy        NegotiationStrategy @default(BALANCED)

  // Sentiment Analysis
  buyerSentiment        String?             // positive, neutral, negative
  sellerSentiment       String?
  negotiationTone       String?             // friendly, tense, professional

  // Success Prediction
  successProbability    Float?              // Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ù†Ø¬Ø§Ø­ Ø§Ù„ØµÙÙ‚Ø© (0-100)
  suggestedNextAction   String?             // Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©

  // Messages & Offers
  messages              NegotiationMessage[]
  offers                NegotiationOffer[]

  // Timestamps
  startedAt             DateTime            @default(now())
  lastActivityAt        DateTime            @default(now())
  agreedAt              DateTime?
  expiresAt             DateTime            // ØªÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ 72 Ø³Ø§Ø¹Ø© Ù…Ù† Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
  completedAt           DateTime?

  // Metadata
  metadata              Json?               // Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([listingId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([lastActivityAt])
}

model NegotiationMessage {
  id                  String              @id @default(uuid())

  sessionId           String
  session             NegotiationSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Message Details
  sender              MessageSender
  senderUserId        String?             // null if AI or System
  senderUser          User?               @relation(fields: [senderUserId], references: [id])

  content             String              // Ø§Ù„Ù†Øµ
  contentAr           String?             // ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠØ©

  // AI Generation (if AI message)
  isAIGenerated       Boolean             @default(false)
  aiPrompt            String?             // Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  aiModel             String?             // gpt-4-turbo
  aiConfidence        Float?

  // Sentiment
  sentiment           String?             // positive, negative, neutral
  sentimentScore      Float?              // -1 to +1

  // Metadata
  metadata            Json?               // {translation, alternatives}

  createdAt           DateTime            @default(now())

  @@index([sessionId])
  @@index([sender])
  @@index([createdAt])
}

model NegotiationOffer {
  id                  String              @id @default(uuid())

  sessionId           String
  session             NegotiationSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Offer Details
  offerType           OfferType
  offeredBy           String              // userId (buyer or seller)
  offerer             User                @relation(fields: [offeredBy], references: [id])

  amount              Float               // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
  previousAmount      Float?              // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø§Ø¨Ù‚
  changePercent       Float?              // Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±

  // AI Analysis of this offer
  isFairOffer         Boolean?            // Ù‡Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ø§Ø¯Ù„ØŸ
  deviationFromFair   Float?              // Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø¹Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ (%)
  aiRecommendation    String?             // accept, reject, counter
  aiReasoning         String?             // Ø³Ø¨Ø¨ Ø§Ù„ØªÙˆØµÙŠØ©

  // Offer Context
  message             String?             // Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø¹Ø±Ø¶
  conditions          String?             // Ø´Ø±ÙˆØ· (cash only, no shipping, etc.)

  // Response
  isAccepted          Boolean?
  isCountered         Boolean?
  counterOfferId      String?             // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯

  // Timestamps
  expiresAt           DateTime?           // Ø§Ù„Ø¹Ø±Ø¶ ØµØ§Ù„Ø­ Ø­ØªÙ‰
  acceptedAt          DateTime?
  rejectedAt          DateTime?

  createdAt           DateTime            @default(now())

  @@index([sessionId])
  @@index([offeredBy])
  @@index([offerType])
  @@index([createdAt])
}

model NegotiationInsight {
  id                  String              @id @default(uuid())

  sessionId           String              @unique

  // Market Analysis
  similarListings     Json                // Ù‚ÙˆØ§Ø¦Ù… Ù…Ø´Ø§Ø¨Ù‡Ø©
  avgMarketPrice      Float
  marketDemand        String              // HIGH, MEDIUM, LOW

  // User Profiles
  buyerProfile        Json                // {avgSpent, negotiationStyle, successRate}
  sellerProfile       Json                // {avgDiscount, responseTime, flexibility}

  // Predictions
  predictedFinalPrice Float?              // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
  predictedDuration   Int?                // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)
  dealBreakers        String[]            // Ø¹ÙˆØ§Ù…Ù„ Ù‚Ø¯ ØªÙØ´Ù„ Ø§Ù„ØµÙÙ‚Ø©

  // Recommendations
  buyerTips           String[]            // Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù…Ø´ØªØ±ÙŠ
  sellerTips          String[]            // Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø¨Ø§Ø¦Ø¹

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

// Analytics Table
model NegotiationAnalytics {
  id                  String              @id @default(uuid())

  sessionId           String              @unique

  // Performance Metrics
  totalMessages       Int
  totalOffers         Int
  responseTimeAvg     Int                 // Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯ (Ø«ÙˆØ§Ù†ÙŠ)
  negotiationDuration Int                 // Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø¯Ù‚Ø§Ø¦Ù‚)

  // Price Dynamics
  startPrice          Float
  finalPrice          Float?
  priceChangePercent  Float?
  numberOfCounters    Int

  // Outcomes
  wasSuccessful       Boolean
  failureReason       String?

  // AI Performance
  aiMessagesCount     Int
  aiAccuracyScore     Float?              // Ø¯Ù‚Ø© ØªÙˆÙ‚Ø¹Ø§Øª AI
  userSatisfaction    Float?              // Ù…Ù† feedback

  createdAt           DateTime            @default(now())

  @@index([wasSuccessful])
  @@index([createdAt])
}
```

---

## 4. API Endpoints {#api-endpoints}

### 4.1 Negotiation Session Endpoints

#### **POST /api/negotiations/start**
Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© ØªÙØ§ÙˆØ¶ Ø¬Ø¯ÙŠØ¯Ø©

```typescript
// Request
{
  "listingId": "uuid",
  "initialOffer": 8000,        // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
  "message": "Ù‡Ù„ Ù…Ù…ÙƒÙ† 8 Ø¢Ù„Ø§ÙØŸ"
}

// Response
{
  "success": true,
  "data": {
    "sessionId": "uuid",
    "status": "INITIATED",
    "fairMarketValue": 8500,
    "recommendedPrice": 8200,
    "priceRange": {
      "min": 7800,
      "max": 9000,
      "optimal": 8200
    },
    "aiConfidence": 87.5,
    "aiMessage": "Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙˆÙ‚ØŒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‡Ùˆ 8500 Ø¬.Ù…. Ø¹Ø±Ø¶Ùƒ Ø¨Ù€ 8000 Ø¬.Ù… Ù…Ø¹Ù‚ÙˆÙ„ ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¹Ù„ÙŠÙ‡. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø¨Ø§Ø¦Ø¹ØŸ"
  }
}
```

#### **GET /api/negotiations/:sessionId**
Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø¬Ù„Ø³Ø© ØªÙØ§ÙˆØ¶

```typescript
// Response
{
  "success": true,
  "data": {
    "session": {
      "id": "uuid",
      "status": "ONGOING",
      "listing": {...},
      "buyer": {...},
      "seller": {...},
      "currentOffer": 8200,
      "fairMarketValue": 8500,
      "messages": [...],
      "offers": [...]
    },
    "insights": {
      "successProbability": 78,
      "suggestedNextAction": "counter_with_8300",
      "buyerTips": [
        "Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¹Ø§Ø¯Ø© ÙŠÙ‚Ø¨Ù„ 5-8% Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù†",
        "Ø£ÙØ¶Ù„ ÙˆÙ‚Øª Ù„Ù„ØªÙØ§ÙˆØ¶: Ø§Ù„Ù…Ø³Ø§Ø¡ (Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø£Ø³Ø±Ø¹)"
      ]
    }
  }
}
```

#### **POST /api/negotiations/:sessionId/offer**
ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯

```typescript
// Request
{
  "amount": 8300,
  "message": "Ø¢Ø®Ø± Ø³Ø¹Ø± 8300 Ø¬.Ù… Ù†Ù‚Ø¯Ø§Ù‹",
  "conditions": "cash_only"
}

// Response
{
  "success": true,
  "data": {
    "offer": {...},
    "aiAnalysis": {
      "isFairOffer": true,
      "deviationFromFair": -2.4,  // 2.4% Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¹Ø§Ø¯Ù„
      "recommendation": "LIKELY_ACCEPTED",
      "reasoning": "Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„. Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù‚Ø¨ÙˆÙ„ 82%.",
      "suggestedResponse": "Ø¹Ø±Ø¶Ùƒ Ù…Ù…ØªØ§Ø²! Ø³Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø¨Ø§Ø¦Ø¹ Ø§Ù„Ø¢Ù†."
    }
  }
}
```

#### **POST /api/negotiations/:sessionId/message**
Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ØªÙØ§ÙˆØ¶

```typescript
// Request
{
  "content": "Ù…Ù…ÙƒÙ† ØªÙ†Ø²Ù„ ÙƒÙ…Ø§Ù† 100 Ø¬Ù†ÙŠÙ‡ØŸ"
}

// Response
{
  "success": true,
  "data": {
    "message": {...},
    "aiResponse": {
      "content": "ÙÙ‡Ù…ØªØŒ ØªØ±ÙŠØ¯ Ø®ØµÙ… Ø¥Ø¶Ø§ÙÙŠ 100 Ø¬.Ù…. Ø¯Ø¹Ù†ÙŠ Ø£Ù‚ØªØ±Ø­ Ø·Ø±ÙŠÙ‚Ø© Ø£ÙØ¶Ù„ Ù„Ù„ØªÙØ§ÙˆØ¶...",
      "suggestions": [
        {
          "type": "counter_offer",
          "amount": 8200,
          "reason": "Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ ÙˆØ£ÙƒØ«Ø± Ù‚Ø¨ÙˆÙ„Ø§Ù‹"
        }
      ]
    }
  }
}
```

#### **POST /api/negotiations/:sessionId/accept**
Ù‚Ø¨ÙˆÙ„ Ø¹Ø±Ø¶

```typescript
// Request
{
  "offerId": "uuid"
}

// Response
{
  "success": true,
  "data": {
    "session": {
      "status": "AGREED",
      "finalPrice": 8300,
      "agreedAt": "2024-12-17T10:30:00Z"
    },
    "nextSteps": {
      "action": "create_order",
      "message": "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… Ø§Ù„Ø§ØªÙØ§Ù‚ Ø¹Ù„Ù‰ 8300 Ø¬.Ù…. Ø³Ù†Ù†ØªÙ‚Ù„ Ø§Ù„Ø¢Ù† Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡."
    }
  }
}
```

### 4.2 AI Assistant Endpoints

#### **POST /api/negotiations/:sessionId/ai-suggest**
Ø·Ù„Ø¨ Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ù† AI

```typescript
// Request
{
  "context": "Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø±ÙØ¶ Ø¹Ø±Ø¶ÙŠ Ø¨Ù€ 8000ØŒ Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ØŸ"
}

// Response
{
  "success": true,
  "data": {
    "suggestion": {
      "type": "counter_offer",
      "amount": 8300,
      "reasoning": "Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø¹Ù„Ù† Ø¨Ù€ 9000 Ø¬.Ù…. Ø±ÙØ¶Ù‡ Ù„Ù€ 8000 ÙŠØ¹Ù†ÙŠ Ø£Ù†Ù‡ Ù…Ø³ØªØ¹Ø¯ Ù„Ù„ØªÙØ§ÙˆØ¶ Ù„ÙƒÙ† Ù„ÙŠØ³ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø¯Ø±. Ø§Ù‚ØªØ±Ø§Ø­ÙŠ:\n\n1. Ù‚Ø¯Ù… Ø¹Ø±Ø¶ 8300 Ø¬.Ù… (8% Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù†)\n2. Ø£Ø¶Ù Ø´Ø±Ø· Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ (Ø¬Ø§Ø°Ø¨ Ù„Ù„Ø¨Ø§Ø¦Ø¹)\n3. Ø£Ø¸Ù‡Ø± Ø¬Ø¯ÙŠØªÙƒ Ø¨Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…\n\nØ§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù‚Ø¨ÙˆÙ„: 75%",
      "messageTemplate": "ØªÙ…Ø§Ù…ØŒ Ø£Ù†Ø§ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ 8300 Ø¬.Ù… Ù†Ù‚Ø¯Ø§Ù‹. Ù…ØªÙ‰ Ù…Ù…ÙƒÙ† Ø£Ø³ØªÙ„Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ØŸ"
    }
  }
}
```

#### **POST /api/negotiations/:sessionId/analyze**
ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„ØªÙØ§ÙˆØ¶

```typescript
// Response
{
  "success": true,
  "data": {
    "analysis": {
      "currentState": {
        "phase": "mid_negotiation",
        "momentum": "positive",
        "priceGap": 500,
        "gapPercent": 5.9
      },
      "marketContext": {
        "similarListings": 12,
        "avgPrice": 8450,
        "demandLevel": "HIGH",
        "competitiveAdvantage": "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù† ØªÙ†Ø§ÙØ³ÙŠ"
      },
      "userBehavior": {
        "buyerStyle": "BALANCED",
        "sellerStyle": "FLEXIBLE",
        "compatibilityScore": 82
      },
      "predictions": {
        "likelyFinalPrice": 8300,
        "estimatedDuration": "15-30 minutes",
        "successProbability": 78
      },
      "recommendations": {
        "buyer": [
          "Ù‚Ø¯Ù… 8300 Ø¬.Ù… ÙƒØ¹Ø±Ø¶ Ù†Ù‡Ø§Ø¦ÙŠ",
          "Ø£ÙƒØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙÙˆØ±ÙŠ",
          "Ø§Ø·Ù„Ø¨ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡"
        ],
        "seller": [
          "Ø§Ù‚Ø¨Ù„ 8300 Ø¬.Ù… Ø¥Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯ÙŠ",
          "Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
          "Ø§Ø­ØªÙ…Ø§Ù„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„: 70%"
        ]
      }
    }
  }
}
```

### 4.3 Analytics Endpoints

#### **GET /api/negotiations/analytics/summary**
Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© Ù„Ù„ØªÙØ§ÙˆØ¶

```typescript
// Response
{
  "success": true,
  "data": {
    "overall": {
      "totalSessions": 1543,
      "successfulSessions": 1157,
      "successRate": 75,
      "avgDuration": 32,  // minutes
      "avgDiscount": 7.8  // percent
    },
    "aiPerformance": {
      "predictionAccuracy": 84.2,
      "userSatisfaction": 4.6,  // out of 5
      "messagesGenerated": 8934,
      "acceptedSuggestions": 67  // percent
    }
  }
}
```

---

## 5. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª AI {#Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª-ai}

### 5.1 Fair Market Value Calculation

```typescript
/**
 * Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯Ù„Ø©
 * Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Multiple Linear Regression + Market Data
 */
interface FairValueInput {
  listing: Listing;
  marketData: MarketData;
  userContext: UserContext;
}

interface FairValueOutput {
  fairMarketValue: number;
  priceRange: { min: number; max: number; optimal: number };
  confidence: number;
  factors: PriceFactor[];
}

async function calculateFairMarketValue(
  input: FairValueInput
): Promise<FairValueOutput> {

  // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡Ø©
  const comparables = await findComparableListings({
    category: input.listing.category,
    brand: input.listing.brand,
    model: input.listing.model,
    ageRange: [input.listing.age - 1, input.listing.age + 1],
    conditionRange: getSimilarConditions(input.listing.condition),
    locationRadius: 50  // km
  });

  // 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ù† Comparables
  const basePrice = calculateMedianPrice(comparables);

  // 3. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  let adjustedPrice = basePrice;
  const factors: PriceFactor[] = [];

  // Condition adjustment
  const conditionFactor = getConditionMultiplier(input.listing.condition);
  adjustedPrice *= conditionFactor;
  factors.push({
    name: 'condition',
    impact: (conditionFactor - 1) * 100,
    weight: 0.25
  });

  // Age/Depreciation
  const depreciationFactor = calculateDepreciation(
    input.listing.age,
    input.listing.category
  );
  adjustedPrice *= depreciationFactor;
  factors.push({
    name: 'depreciation',
    impact: (depreciationFactor - 1) * 100,
    weight: 0.20
  });

  // Market demand
  const demandFactor = calculateDemandFactor(
    comparables,
    input.marketData.supplyDemandRatio
  );
  adjustedPrice *= demandFactor;
  factors.push({
    name: 'market_demand',
    impact: (demandFactor - 1) * 100,
    weight: 0.15
  });

  // Location
  const locationFactor = getLocationMultiplier(input.listing.governorate);
  adjustedPrice *= locationFactor;
  factors.push({
    name: 'location',
    impact: (locationFactor - 1) * 100,
    weight: 0.10
  });

  // Seller reputation
  const reputationFactor = getSellerReputationFactor(input.listing.seller);
  adjustedPrice *= reputationFactor;
  factors.push({
    name: 'seller_reputation',
    impact: (reputationFactor - 1) * 100,
    weight: 0.10
  });

  // Urgency/Time on market
  const urgencyFactor = calculateUrgencyFactor(input.listing.createdAt);
  adjustedPrice *= urgencyFactor;
  factors.push({
    name: 'urgency',
    impact: (urgencyFactor - 1) * 100,
    weight: 0.10
  });

  // 4. Ø­Ø³Ø§Ø¨ Ù…Ø¯Ù‰ Ø§Ù„Ø«Ù‚Ø©
  const confidence = calculateConfidence({
    comparablesCount: comparables.length,
    dataQuality: assessDataQuality(comparables),
    marketVolatility: input.marketData.priceVolatility
  });

  // 5. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±ÙŠ
  const stdDev = calculateStandardDeviation(comparables.map(c => c.price));
  const priceRange = {
    min: Math.max(adjustedPrice - stdDev, adjustedPrice * 0.85),
    max: Math.min(adjustedPrice + stdDev, adjustedPrice * 1.15),
    optimal: adjustedPrice
  };

  return {
    fairMarketValue: Math.round(adjustedPrice),
    priceRange: {
      min: Math.round(priceRange.min),
      max: Math.round(priceRange.max),
      optimal: Math.round(priceRange.optimal)
    },
    confidence,
    factors
  };
}
```

### 5.2 Negotiation Strategy Selection

```typescript
/**
 * Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙØ§ÙˆØ¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
 * Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Reinforcement Learning + User Profiling
 */

enum Strategy {
  AGGRESSIVE = 'aggressive',      // Ø®ØµÙ… 15-20%
  BALANCED = 'balanced',          // Ø®ØµÙ… 8-12%
  FLEXIBLE = 'flexible',          // Ø®ØµÙ… 3-7%
  QUICK_SALE = 'quick_sale'       // Ù‚Ø¨ÙˆÙ„ Ø£ÙˆÙ„ Ø¹Ø±Ø¶ Ù…Ø¹Ù‚ÙˆÙ„
}

interface UserProfile {
  userId: string;
  pastNegotiations: NegotiationHistory[];
  avgDiscount: number;
  avgDuration: number;
  successRate: number;
  preferredStrategy: Strategy;
  flexibility: number;  // 0-100
}

async function selectNegotiationStrategy(
  user: UserProfile,
  listing: Listing,
  marketConditions: MarketData
): Promise<Strategy> {

  // 1. ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚
  const userBehavior = analyzeUserBehavior(user.pastNegotiations);

  // 2. ØªÙ‚ÙŠÙŠÙ… Ø¸Ø±ÙˆÙ Ø§Ù„Ø³ÙˆÙ‚
  const marketScore = assessMarketConditions({
    demand: marketConditions.demandLevel,
    supply: marketConditions.availableListings,
    priceVolatility: marketConditions.volatility
  });

  // 3. ØªÙ‚ÙŠÙŠÙ… Ø¹Ø¬Ù„Ø© Ø§Ù„Ø¨Ø§Ø¦Ø¹/Ø§Ù„Ù…Ø´ØªØ±ÙŠ
  const urgencyScore = assessUrgency({
    listingAge: listing.age,
    viewsCount: listing.viewsCount,
    inquiriesCount: listing.inquiriesCount,
    userHistory: user.pastNegotiations
  });

  // 4. ML Model Prediction
  const strategyScores = await mlModel.predict({
    features: {
      user_flexibility: user.flexibility,
      user_avg_discount: user.avgDiscount,
      market_demand: marketScore.demand,
      listing_age_days: listing.ageInDays,
      price_vs_market: listing.price / marketConditions.avgPrice,
      seller_urgency: urgencyScore
    }
  });

  // 5. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø£ÙØ¶Ù„
  const bestStrategy = Object.entries(strategyScores)
    .sort(([, scoreA], [, scoreB]) => scoreB - scoreA)[0][0];

  return bestStrategy as Strategy;
}
```

### 5.3 GPT-4 Integration Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø°ÙƒÙŠØ©

```typescript
/**
 * ØªÙˆÙ„ÙŠØ¯ Ø±Ø³Ø§Ø¦Ù„ ØªÙØ§ÙˆØ¶ÙŠØ© Ø°ÙƒÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPT-4
 */

interface AIMessageRequest {
  sessionId: string;
  context: NegotiationContext;
  userIntent: string;
  tone: 'friendly' | 'professional' | 'assertive';
}

async function generateAIMessage(
  request: AIMessageRequest
): Promise<string> {

  const { context, userIntent, tone } = request;

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
  const systemPrompt = `
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªÙØ§ÙˆØ¶ Ø°ÙƒÙŠ ÙÙŠ Ù…Ù†ØµØ© Xchange Ù„Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø© ÙÙŠ Ù…ØµØ±.
Ø¯ÙˆØ±Ùƒ Ù‡Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ø¯Ù„ ÙˆÙØ¹Ù‘Ø§Ù„.

Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù‡Ù…Ø©:
1. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
2. ÙƒÙ† Ù…Ø­Ø§ÙŠØ¯Ø§Ù‹ ÙˆÙ…Ù†ØµÙØ§Ù‹ Ù„Ù„Ø·Ø±ÙÙŠÙ†
3. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø§ØªÙØ§Ù‚ win-win
4. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­Ù‚Ø§Ø¦Ù‚ ÙÙŠ ØªÙˆØµÙŠØ§ØªÙƒ
5. ÙƒÙ† Ù…Ø®ØªØµØ±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹ (Ù„Ø§ ØªØ²ÙŠØ¯ Ø¹Ù† 3-4 Ø¬Ù…Ù„)

Ø§Ù„Ù†Ø¨Ø±Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${tone}
  `.trim();

  const userPrompt = `
Ø§Ù„Ø³ÙŠØ§Ù‚:
- Ø§Ù„Ù…Ù†ØªØ¬: ${context.listing.title}
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù†: ${context.listing.price} Ø¬.Ù…
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ (AI): ${context.fairMarketValue} Ø¬.Ù…
- Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${context.currentOffer || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'} Ø¬.Ù…
- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶: ${context.offerCount}
- Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ§ÙˆØ¶: ${context.status}

${userIntent === 'suggest_offer' ? `
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø§Ù‚ØªØ±Ø­ Ø¹Ø±Ø¶Ø§Ù‹ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø´ØªØ±ÙŠ Ù…Ø¹ ØªØ¨Ø±ÙŠØ± Ù…Ù‚Ù†Ø¹.
` : userIntent === 'respond_to_offer' ? `
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠ Ø¨Ù€ ${context.currentOffer} Ø¬.Ù…
` : userIntent === 'encourage_acceptance' ? `
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø´Ø¬Ø¹ ${context.targetUser} Ø¹Ù„Ù‰ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø¹ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨
` : `
Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${userIntent}
`}

Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‚ØµÙŠØ±Ø© ÙˆÙ…Ù‚Ù†Ø¹Ø©:
  `.trim();

  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ GPT-4
  const response = await openai.chat.completions.create({
    model: 'gpt-4-turbo-preview',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt }
    ],
    temperature: 0.7,
    max_tokens: 200,
    presence_penalty: 0.3,
    frequency_penalty: 0.3
  });

  const aiMessage = response.choices[0].message.content.trim();

  // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ„Ø¯Ø©
  const sentiment = await analyzeSentiment(aiMessage);

  // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  await prisma.negotiationMessage.create({
    data: {
      sessionId: request.sessionId,
      sender: 'AI_ASSISTANT',
      content: aiMessage,
      isAIGenerated: true,
      aiPrompt: userPrompt,
      aiModel: 'gpt-4-turbo',
      sentiment: sentiment.label,
      sentimentScore: sentiment.score
    }
  });

  return aiMessage;
}
```

### 5.4 Success Probability Prediction

```typescript
/**
 * ØªÙˆÙ‚Ø¹ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ù†Ø¬Ø§Ø­ Ø§Ù„ØµÙÙ‚Ø©
 * Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gradient Boosting (XGBoost)
 */

interface SuccessPredictionInput {
  priceGap: number;              // Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ø·Ù„ÙˆØ¨
  offerCount: number;            // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶
  duration: number;              // Ù…Ø¯Ø© Ø§Ù„ØªÙØ§ÙˆØ¶ (Ø¯Ù‚Ø§Ø¦Ù‚)
  buyerProfile: UserProfile;
  sellerProfile: UserProfile;
  marketConditions: MarketData;
  sentimentScore: number;        // -1 to +1
}

async function predictSuccessProbability(
  input: SuccessPredictionInput
): Promise<number> {

  // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª (Features)
  const features = {
    // Price features
    price_gap_percent: (input.priceGap / input.fairMarketValue) * 100,
    price_gap_absolute: input.priceGap,
    current_offer_vs_fair: input.currentOffer / input.fairMarketValue,

    // Negotiation dynamics
    offer_count: input.offerCount,
    duration_minutes: input.duration,
    avg_response_time: input.duration / (input.offerCount || 1),

    // User profiles
    buyer_success_rate: input.buyerProfile.successRate,
    seller_success_rate: input.sellerProfile.successRate,
    buyer_flexibility: input.buyerProfile.flexibility,
    seller_flexibility: input.sellerProfile.flexibility,

    // Market
    market_demand: input.marketConditions.demandScore,
    similar_listings_count: input.marketConditions.similarCount,

    // Sentiment
    overall_sentiment: input.sentimentScore,

    // Behavioral
    buyer_engagement: input.buyerProfile.avgMessagesPerNegotiation,
    seller_engagement: input.sellerProfile.avgMessagesPerNegotiation
  };

  // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ XGBoost Ø§Ù„Ù…Ø¯Ø±Ø¨
  const prediction = await xgboostModel.predict(features);

  // ØªØ­ÙˆÙŠÙ„ Ù„Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© (0-100)
  const probability = Math.round(prediction * 100);

  return probability;
}
```

### 5.5 Sentiment Analysis

```typescript
/**
 * ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
 * Arabic Sentiment Analysis
 */

import { pipeline } from '@xenova/transformers';

let sentimentAnalyzer: any = null;

async function initSentimentAnalyzer() {
  if (!sentimentAnalyzer) {
    // Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¯Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    sentimentAnalyzer = await pipeline(
      'sentiment-analysis',
      'CAMeL-Lab/bert-base-arabic-camelbert-msa-sentiment'
    );
  }
  return sentimentAnalyzer;
}

interface SentimentResult {
  label: 'positive' | 'negative' | 'neutral';
  score: number;  // -1 to +1
  confidence: number;  // 0 to 1
}

async function analyzeSentiment(text: string): Promise<SentimentResult> {
  const analyzer = await initSentimentAnalyzer();

  const result = await analyzer(text);

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
  const label = result[0].label.toLowerCase();
  const confidence = result[0].score;

  let score: number;
  if (label === 'positive') score = confidence;
  else if (label === 'negative') score = -confidence;
  else score = 0;

  return {
    label: label as 'positive' | 'negative' | 'neutral',
    score,
    confidence
  };
}

/**
 * ØªØ­Ù„ÙŠÙ„ Ù†Ø¨Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
 */
async function analyzeConversationTone(
  messages: NegotiationMessage[]
): Promise<string> {

  const sentiments = await Promise.all(
    messages.map(msg => analyzeSentiment(msg.content))
  );

  const avgScore = sentiments.reduce((sum, s) => sum + s.score, 0) / sentiments.length;
  const variance = calculateVariance(sentiments.map(s => s.score));

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø¨Ø±Ø©
  if (avgScore > 0.3 && variance < 0.2) return 'friendly';
  if (avgScore < -0.3) return 'tense';
  if (variance > 0.5) return 'volatile';
  return 'professional';
}
```

---

## 6. User Stories {#user-stories}

### Story 1: Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙŠØ¨Ø¯Ø£ ØªÙØ§ÙˆØ¶
```
ÙƒÙ€ Ù…Ø´ØªØ±ÙŠ
Ø£Ø±ÙŠØ¯ Ø£Ù† Ø£Ø¨Ø¯Ø£ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬
Ø­ØªÙ‰ Ø£Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø£ÙØ¶Ù„

Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„:
âœ… ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø±Ø¤ÙŠØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙØ§ÙˆØ¶
âœ… AI ÙŠÙ‚ØªØ±Ø­ Ø¹Ù„ÙŠÙ‘ Ø¹Ø±Ø¶ Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù†Ø§Ø³Ø¨
âœ… Ø£Ø³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
âœ… Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ³ØªÙ„Ù… Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ

Ø§Ù„Ù…Ø«Ø§Ù„:
1. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙØ§ÙˆØ¶" Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù† Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¨Ù€ 9000 Ø¬.Ù…
2. AI ÙŠØ­Ù„Ù„: "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ 8500 Ø¬.Ù…ØŒ Ø§Ù‚ØªØ±Ø­ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù€ 8000 Ø¬.Ù…"
3. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙˆØ§ÙÙ‚ Ø£Ùˆ ÙŠØ¹Ø¯Ù„
4. Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ±Ø³Ù„ Ù„Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø¹ ØªÙˆØµÙŠØ© AI
```

### Story 2: Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ±Ø¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶
```
ÙƒÙ€ Ø¨Ø§Ø¦Ø¹
Ø£Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠ Ø¨Ø°ÙƒØ§Ø¡
Ø­ØªÙ‰ Ù„Ø§ Ø£ÙÙ‚Ø¯ Ø§Ù„Ø¨ÙŠØ¹ Ø£Ùˆ Ø£Ø¨ÙŠØ¹ Ø¨Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø©

Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„:
âœ… Ø£Ø±Ù‰ ØªØ­Ù„ÙŠÙ„ AI Ù„Ù„Ø¹Ø±Ø¶ (Ø¹Ø§Ø¯Ù„/Ù…Ù†Ø®ÙØ¶/Ø¬ÙŠØ¯)
âœ… AI ÙŠÙ‚ØªØ±Ø­ Ù„ÙŠ Ø±Ø¯ Ù…Ù†Ø§Ø³Ø¨
âœ… Ø£Ø³ØªØ·ÙŠØ¹ Ù‚Ø¨ÙˆÙ„/Ø±ÙØ¶/ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯
âœ… Ø¥Ø°Ø§ Ø±ÙØ¶ØªØŒ AI ÙŠØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø£ØµÙŠØº Ø§Ù„Ø±Ø¯

Ø§Ù„Ù…Ø«Ø§Ù„:
1. Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ³ØªÙ„Ù… Ø¹Ø±Ø¶ 8000 Ø¬.Ù… Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù† 9000 Ø¬.Ù…
2. AI: "Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù†Ø®ÙØ¶ 11% Ø¹Ù† Ø§Ù„Ø¹Ø§Ø¯Ù„. Ø§Ù‚ØªØ±Ø­ Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯ 8500 Ø¬.Ù…"
3. Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ®ØªØ§Ø± "Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯"
4. AI ÙŠÙƒØªØ¨: "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ! Ø§Ù„Ø³Ø¹Ø± Ù…Ø¹Ù‚ÙˆÙ„ Ù„ÙƒÙ† Ø¢Ø®Ø± Ø³Ø¹Ø± 8500 Ø¬.Ù… Ù†Ù‚Ø¯Ø§Ù‹"
```

### Story 3: Ø§Ù„ØªÙØ§ÙˆØ¶ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
```
ÙƒÙ€ Ù…Ø´ØªØ±ÙŠ/Ø¨Ø§Ø¦Ø¹
Ø£Ø±ÙŠØ¯ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø°ÙƒÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ§ÙˆØ¶
Ø­ØªÙ‰ Ø£ØµÙ„ Ù„Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ø¨Ø³Ø±Ø¹Ø©

Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„:
âœ… AI ÙŠØªØ§Ø¨Ø¹ Ø³ÙŠØ± Ø§Ù„ØªÙØ§ÙˆØ¶ ÙˆÙŠÙ‚Ø¯Ù… Ù†ØµØ§Ø¦Ø­
âœ… ÙŠØ­Ø°Ø±Ù†ÙŠ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶ ØºÙŠØ± Ø§Ù„Ø¹Ø§Ø¯Ù„Ø©
âœ… ÙŠØ´Ø¬Ø¹Ù†ÙŠ Ø¹Ù„Ù‰ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬ÙŠØ¯Ø§Ù‹
âœ… ÙŠØªÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø­ØªÙ…Ù„

Ø§Ù„Ù…Ø«Ø§Ù„:
- Ø¨Ø¹Ø¯ 3 Ø¹Ø±ÙˆØ¶ Ù…ØªØ¨Ø§Ø¯Ù„Ø©ØŒ Ø§Ù„ÙØ±Ù‚ 300 Ø¬.Ù… ÙÙ‚Ø·
- AI Ù„Ù„Ù…Ø´ØªØ±ÙŠ: "Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ù…Ø±Ù†. Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù‚Ø¨ÙˆÙ„ 85%"
- AI Ù„Ù„Ø¨Ø§Ø¦Ø¹: "Ø¹Ø±Ø¶ Ø¬ÙŠØ¯ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠ Ø¬Ø§Ø¯. Ù‚Ø¨ÙˆÙ„Ù‡ ÙŠÙˆÙØ± Ù„Ùƒ 5 Ø£ÙŠØ§Ù… Ø¨Ø­Ø« Ø¹Ù† Ù…Ø´ØªØ±ÙŠ Ø¢Ø®Ø±"
```

### Story 4: Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØµÙÙ‚Ø©
```
ÙƒÙ€ Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø´ØªØ±ÙŠ/Ø¨Ø§Ø¦Ø¹)
Ø£Ø±ÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØµÙÙ‚Ø© Ø¨Ø³Ù„Ø§Ø³Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø§ØªÙØ§Ù‚
Ø­ØªÙ‰ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ¹/Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø£Ù…Ø§Ù†

Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù‚Ø¨ÙˆÙ„:
âœ… Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ØŒ ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨
âœ… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ ÙŠØ«Ø¨Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
âœ… Ø´Ø±ÙˆØ· Ø§Ù„ØªÙØ§ÙˆØ¶ ØªÙ†Ù‚Ù„ Ù„Ù„Ø·Ù„Ø¨ (Ù†Ù‚Ø¯ÙŠ/Ø´Ø­Ù†/Ø¥Ù„Ø®)
âœ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§ÙˆØ¶ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©

Ø§Ù„Ù…Ø«Ø§Ù„:
1. Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠÙ‚Ø¨Ù„ Ø¹Ø±Ø¶ 8300 Ø¬.Ù…
2. AI: "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø§ØªÙÙ‚ØªÙ… Ø¹Ù„Ù‰ 8300 Ø¬.Ù…"
3. Ø²Ø± "Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡" ÙŠØ¸Ù‡Ø±
4. Ø§Ù„Ø·Ù„Ø¨ ÙŠÙÙ†Ø´Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§
```

---

## 7. Implementation Guide {#implementation-guide}

### 7.1 Phase 1: Core Infrastructure (Week 1-2)

**Tasks:**
```bash
# 1. Setup Database
npx prisma migrate dev --name add_negotiation_tables

# 2. Create Base Services
src/
  services/
    negotiation.service.ts       # Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶
    ai.service.ts                 # OpenAI integration
    pricing.service.ts            # Fair value calculation
    sentiment.service.ts          # Sentiment analysis
```

**Code Example: Negotiation Service**
```typescript
// src/services/negotiation.service.ts

import { PrismaClient } from '@prisma/client';
import { AIService } from './ai.service';
import { PricingService } from './pricing.service';

const prisma = new PrismaClient();

export class NegotiationService {

  async startNegotiation(data: {
    listingId: string;
    buyerId: string;
    initialOffer?: number;
    message?: string;
  }) {

    // 1. Get listing details
    const listing = await prisma.listing.findUnique({
      where: { id: data.listingId },
      include: { seller: true }
    });

    if (!listing) throw new Error('Listing not found');
    if (listing.sellerId === data.buyerId) {
      throw new Error('Cannot negotiate your own listing');
    }

    // 2. Calculate fair market value
    const fairValue = await PricingService.calculateFairValue(listing);

    // 3. Create negotiation session
    const session = await prisma.negotiationSession.create({
      data: {
        listingId: data.listingId,
        buyerId: data.buyerId,
        sellerId: listing.sellerId,
        status: 'INITIATED',
        listingPrice: listing.price,
        buyerInitialOffer: data.initialOffer,
        fairMarketValue: fairValue.value,
        recommendedPrice: fairValue.optimal,
        priceRange: fairValue.range,
        aiConfidence: fairValue.confidence,
        expiresAt: new Date(Date.now() + 72 * 60 * 60 * 1000) // 72 hours
      }
    });

    // 4. Generate AI welcome message
    const aiMessage = await AIService.generateWelcomeMessage({
      sessionId: session.id,
      fairValue: fairValue.value,
      initialOffer: data.initialOffer,
      listingPrice: listing.price
    });

    // 5. Save AI message
    await prisma.negotiationMessage.create({
      data: {
        sessionId: session.id,
        sender: 'AI_ASSISTANT',
        content: aiMessage,
        isAIGenerated: true,
        aiModel: 'gpt-4-turbo'
      }
    });

    // 6. Send notification to seller
    await this.notifySeller(session.id, listing.sellerId);

    return {
      session,
      aiMessage,
      fairValue
    };
  }

  async makeOffer(sessionId: string, userId: string, data: {
    amount: number;
    message?: string;
    conditions?: string;
  }) {

    const session = await prisma.negotiationSession.findUnique({
      where: { id: sessionId },
      include: { listing: true }
    });

    if (!session) throw new Error('Session not found');

    // Determine role
    const isBuyer = session.buyerId === userId;
    const isSeller = session.sellerId === userId;

    if (!isBuyer && !isSeller) {
      throw new Error('Unauthorized');
    }

    // Create offer
    const offer = await prisma.negotiationOffer.create({
      data: {
        sessionId,
        offerType: session.offerCount === 0 ? 'INITIAL' : 'COUNTER',
        offeredBy: userId,
        amount: data.amount,
        previousAmount: session.currentOffer,
        changePercent: session.currentOffer
          ? ((data.amount - session.currentOffer) / session.currentOffer) * 100
          : null,
        message: data.message,
        conditions: data.conditions,
        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000) // 24h
      }
    });

    // Update session
    await prisma.negotiationSession.update({
      where: { id: sessionId },
      data: {
        currentOffer: data.amount,
        lastOfferedBy: userId,
        offerCount: { increment: 1 },
        lastActivityAt: new Date(),
        status: 'OFFER_MADE'
      }
    });

    // AI analysis of the offer
    const aiAnalysis = await AIService.analyzeOffer({
      offer: data.amount,
      fairValue: session.fairMarketValue,
      previousOffer: session.currentOffer,
      role: isBuyer ? 'buyer' : 'seller'
    });

    // Update offer with AI analysis
    await prisma.negotiationOffer.update({
      where: { id: offer.id },
      data: {
        isFairOffer: aiAnalysis.isFair,
        deviationFromFair: aiAnalysis.deviation,
        aiRecommendation: aiAnalysis.recommendation,
        aiReasoning: aiAnalysis.reasoning
      }
    });

    // Notify other party
    const otherPartyId = isBuyer ? session.sellerId : session.buyerId;
    await this.notifyNewOffer(sessionId, otherPartyId, data.amount);

    return {
      offer,
      aiAnalysis
    };
  }
}
```

### 7.2 Phase 2: AI Integration (Week 3-4)

**OpenAI Integration:**
```typescript
// src/services/ai.service.ts

import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

export class AIService {

  static async generateWelcomeMessage(context: {
    sessionId: string;
    fairValue: number;
    initialOffer?: number;
    listingPrice: number;
  }): Promise<string> {

    const prompt = `
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªÙØ§ÙˆØ¶ Ø°ÙƒÙŠ. Ù…Ø´ØªØ±ÙŠ Ø¨Ø¯Ø£ ØªÙØ§ÙˆØ¶ Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬:
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù†: ${context.listingPrice} Ø¬.Ù…
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„Ù†Ø§): ${context.fairValue} Ø¬.Ù…
${context.initialOffer ? `- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠ: ${context.initialOffer} Ø¬.Ù…` : ''}

Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ÙŠØ© Ù‚ØµÙŠØ±Ø© (2-3 Ø¬Ù…Ù„) ØªÙˆØ¶Ø­:
1. Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„ Ù„Ù„Ù…Ù†ØªØ¬
2. ØªÙ‚ÙŠÙŠÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙŠ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
3. Ø®Ø·ÙˆØ© Ù…Ù‚ØªØ±Ø­Ø©

Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…ØµØ±ÙŠØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙˆØ¯ÙˆØ¯Ø©.
    `.trim();

    const response = await openai.chat.completions.create({
      model: 'gpt-4-turbo-preview',
      messages: [
        {
          role: 'system',
          content: 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªÙØ§ÙˆØ¶ Ù…Ø­ØªØ±Ù ÙÙŠ Ù…Ù†ØµØ© Xchange Ø§Ù„Ù…ØµØ±ÙŠØ©.'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 150
    });

    return response.choices[0].message.content?.trim() || '';
  }

  static async suggestCounterOffer(context: {
    currentOffer: number;
    fairValue: number;
    listingPrice: number;
    offerCount: number;
    role: 'buyer' | 'seller';
  }): Promise<{
    amount: number;
    reasoning: string;
    message: string;
  }> {

    const gap = context.listingPrice - context.currentOffer;
    const gapPercent = (gap / context.listingPrice) * 100;

    let suggestedAmount: number;

    if (context.role === 'buyer') {
      // Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙŠØ²ÙŠØ¯ Ø¹Ø±Ø¶Ù‡
      if (gapPercent > 15) {
        // ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø©: Ø²ÙŠØ§Ø¯Ø© 40% Ù…Ù† Ø§Ù„ÙØ¬ÙˆØ©
        suggestedAmount = context.currentOffer + (gap * 0.4);
      } else if (gapPercent > 8) {
        // ÙØ¬ÙˆØ© Ù…ØªÙˆØ³Ø·Ø©: Ø²ÙŠØ§Ø¯Ø© 50%
        suggestedAmount = context.currentOffer + (gap * 0.5);
      } else {
        // ÙØ¬ÙˆØ© ØµØºÙŠØ±Ø©: Ø²ÙŠØ§Ø¯Ø© 60%
        suggestedAmount = context.currentOffer + (gap * 0.6);
      }
    } else {
      // Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ®ÙØ¶ Ø³Ø¹Ø±Ù‡
      if (gapPercent > 15) {
        // ÙØ¬ÙˆØ© ÙƒØ¨ÙŠØ±Ø©: Ø®ÙØ¶ 30%
        suggestedAmount = context.listingPrice - (gap * 0.3);
      } else if (gapPercent > 8) {
        // ÙØ¬ÙˆØ© Ù…ØªÙˆØ³Ø·Ø©: Ø®ÙØ¶ 40%
        suggestedAmount = context.listingPrice - (gap * 0.4);
      } else {
        // ÙØ¬ÙˆØ© ØµØºÙŠØ±Ø©: Ø®ÙØ¶ 50%
        suggestedAmount = context.listingPrice - (gap * 0.5);
      }
    }

    // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 50
    suggestedAmount = Math.round(suggestedAmount / 50) * 50;

    // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ¨Ø±ÙŠØ± ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©
    const prompt = `
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªÙØ§ÙˆØ¶. Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:
- ${context.role === 'buyer' ? 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ' : 'Ø§Ù„Ø¨Ø§Ø¦Ø¹'}
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø¹Ù„Ù†: ${context.listingPrice} Ø¬.Ù…
- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„: ${context.fairValue} Ø¬.Ù…
- Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${context.currentOffer} Ø¬.Ù…
- Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ¨Ø§Ø¯Ù„Ø©: ${context.offerCount}

Ø£Ù‚ØªØ±Ø­ ${context.role === 'buyer' ? 'Ø²ÙŠØ§Ø¯Ø©' : 'Ø®ÙØ¶'} Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ ${suggestedAmount} Ø¬.Ù…

1. Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ (Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø©)
2. Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªÙØ§ÙˆØ¶ÙŠØ© Ù…Ù‚ØªØ±Ø­Ø© (Ø¬Ù…Ù„ØªÙŠÙ†)

JSON ÙÙ‚Ø·:
{
  "reasoning": "...",
  "message": "..."
}
    `.trim();

    const response = await openai.chat.completions.create({
      model: 'gpt-4-turbo-preview',
      messages: [{ role: 'user', content: prompt }],
      response_format: { type: 'json_object' },
      temperature: 0.7
    });

    const result = JSON.parse(response.choices[0].message.content || '{}');

    return {
      amount: suggestedAmount,
      reasoning: result.reasoning,
      message: result.message
    };
  }
}
```

### 7.3 Phase 3: Frontend UI (Week 5-6)

**React Components:**
```typescript
// src/components/NegotiationChat.tsx

'use client';

import { useState, useEffect } from 'react';
import { useNegotiation } from '@/hooks/useNegotiation';

export function NegotiationChat({ sessionId }: { sessionId: string }) {
  const {
    session,
    messages,
    sendMessage,
    makeOffer,
    acceptOffer,
    loading
  } = useNegotiation(sessionId);

  const [message, setMessage] = useState('');
  const [offerAmount, setOfferAmount] = useState<number | null>(null);

  if (!session) return <div>Loading...</div>;

  const isBuyer = session.buyerId === currentUserId;
  const fairValue = session.fairMarketValue;
  const currentOffer = session.currentOffer;

  return (
    <div className="flex flex-col h-screen">

      {/* Header: Fair Value Card */}
      <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
        <div className="flex justify-between items-center">
          <div>
            <h3 className="text-sm opacity-80">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„</h3>
            <p className="text-2xl font-bold">{fairValue.toLocaleString()} Ø¬.Ù…</p>
          </div>
          <div>
            <h3 className="text-sm opacity-80">Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
            <p className="text-2xl font-bold">
              {currentOffer?.toLocaleString() || '--'} Ø¬.Ù…
            </p>
          </div>
          <div>
            <h3 className="text-sm opacity-80">Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„Ù†Ø¬Ø§Ø­</h3>
            <p className="text-2xl font-bold">{session.successProbability}%</p>
          </div>
        </div>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg) => (
          <MessageBubble
            key={msg.id}
            message={msg}
            isCurrentUser={msg.senderUserId === currentUserId}
            isAI={msg.sender === 'AI_ASSISTANT'}
          />
        ))}
      </div>

      {/* AI Suggestions */}
      {session.suggestedNextAction && (
        <div className="bg-yellow-50 border-t border-yellow-200 p-4">
          <div className="flex items-start gap-3">
            <div className="text-2xl">ğŸ’¡</div>
            <div className="flex-1">
              <h4 className="font-semibold text-yellow-900 mb-1">
                Ø§Ù‚ØªØ±Ø§Ø­ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
              </h4>
              <p className="text-yellow-800 text-sm">
                {session.suggestedNextAction}
              </p>
              {session.aiSuggestedOffer && (
                <button
                  onClick={() => makeOffer(session.aiSuggestedOffer!)}
                  className="mt-2 px-4 py-2 bg-yellow-500 text-white rounded-lg"
                >
                  Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ ({session.aiSuggestedOffer.toLocaleString()} Ø¬.Ù…)
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Input Area */}
      <div className="border-t p-4 bg-white">
        <div className="flex gap-2">
          <input
            type="number"
            placeholder="Ø§ÙƒØªØ¨ Ø¹Ø±Ø¶Ùƒ..."
            value={offerAmount || ''}
            onChange={(e) => setOfferAmount(Number(e.target.value))}
            className="flex-1 px-4 py-2 border rounded-lg"
          />
          <button
            onClick={() => offerAmount && makeOffer(offerAmount)}
            disabled={!offerAmount || loading}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50"
          >
            Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶
          </button>
        </div>

        <div className="mt-2 flex gap-2">
          <input
            type="text"
            placeholder="Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            className="flex-1 px-4 py-2 border rounded-lg"
          />
          <button
            onClick={() => message && sendMessage(message)}
            disabled={!message || loading}
            className="px-6 py-2 bg-gray-600 text-white rounded-lg"
          >
            Ø¥Ø±Ø³Ø§Ù„
          </button>
        </div>
      </div>

    </div>
  );
}
```

### 7.4 Phase 4: Testing & Optimization (Week 7-8)

**Test Scenarios:**
```typescript
// tests/negotiation.test.ts

describe('Negotiation AI Assistant', () => {

  test('should calculate fair market value correctly', async () => {
    const listing = await createTestListing({
      price: 9000,
      category: 'mobiles',
      brand: 'Samsung'
    });

    const fairValue = await PricingService.calculateFairValue(listing);

    expect(fairValue.value).toBeGreaterThan(7000);
    expect(fairValue.value).toBeLessThan(10000);
    expect(fairValue.confidence).toBeGreaterThan(70);
  });

  test('should suggest appropriate counter offer', async () => {
    const session = await createTestSession({
      listingPrice: 9000,
      currentOffer: 7500,
      fairValue: 8500
    });

    const suggestion = await AIService.suggestCounterOffer({
      currentOffer: 7500,
      fairValue: 8500,
      listingPrice: 9000,
      offerCount: 1,
      role: 'seller'
    });

    // Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¹Ø±Ø¶ Ø¨ÙŠÙ† 8000-8700
    expect(suggestion.amount).toBeGreaterThan(8000);
    expect(suggestion.amount).toBeLessThan(8700);
  });

  test('should predict success probability accurately', async () => {
    const session = await createTestSession({
      listingPrice: 9000,
      currentOffer: 8500,
      fairValue: 8500,
      offerCount: 2
    });

    const probability = await predictSuccessProbability(session);

    // Ø¹Ø±Ø¶ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ø§Ø¯Ù„ = Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø¹Ø§Ù„ÙŠØ©
    expect(probability).toBeGreaterThan(75);
  });
});
```

---

## 8. Security & Privacy {#security-privacy}

### 8.1 Ø£Ù…Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

**Encryption:**
```typescript
// ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø³Ø§Ø³Ø©
import crypto from 'crypto';

const ENCRYPTION_KEY = process.env.MESSAGE_ENCRYPTION_KEY!;
const IV_LENGTH = 16;

export function encryptMessage(text: string): string {
  const iv = crypto.randomBytes(IV_LENGTH);
  const cipher = crypto.createCipheriv(
    'aes-256-cbc',
    Buffer.from(ENCRYPTION_KEY),
    iv
  );

  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');

  return iv.toString('hex') + ':' + encrypted;
}

export function decryptMessage(encrypted: string): string {
  const parts = encrypted.split(':');
  const iv = Buffer.from(parts[0], 'hex');
  const encryptedText = parts[1];

  const decipher = crypto.createDecipheriv(
    'aes-256-cbc',
    Buffer.from(ENCRYPTION_KEY),
    iv
  );

  let decrypted = decipher.update(encryptedText, 'hex', 'utf8');
  decrypted += decipher.final('utf8');

  return decrypted;
}
```

### 8.2 Rate Limiting

```typescript
// Ù…Ù†Ø¹ Ø¥Ø³Ø§Ø¡Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
import rateLimit from 'express-rate-limit';

export const negotiationRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 50, // 50 requests per window
  message: 'ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø©',
  standardHeaders: true,
  legacyHeaders: false
});

// Ù„Ù„Ù€ AI requests
export const aiRateLimiter = rateLimit({
  windowMs: 60 * 1000, // 1 minute
  max: 10, // 10 AI requests per minute
  message: 'Ø·Ù„Ø¨Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹',
  keyGenerator: (req) => req.user?.id || req.ip
});
```

### 8.3 Privacy Controls

```typescript
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©
interface PrivacySettings {
  showNegotiationHistory: boolean;  // Ø¥Ø¸Ù‡Ø§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ§ÙˆØ¶
  allowAIAnalysis: boolean;          // Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù€ AI Ø¨ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒÙŠ
  shareDataForImprovement: boolean;  // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø©
}

// Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ÙØªØ±Ø©
async function cleanupExpiredNegotiations() {
  // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¨Ø¹Ø¯ 90 ÙŠÙˆÙ…
  await prisma.negotiationSession.deleteMany({
    where: {
      completedAt: {
        lt: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
      }
    }
  });
}
```

---

## ğŸ“Š Success Metrics

### KPIs Ù„Ù„Ù‚ÙŠØ§Ø³:

| Metric | Target | Current | Status |
|--------|--------|---------|--------|
| **Conversion Rate** | +25% | TBD | ğŸ¯ |
| **Avg Negotiation Duration** | < 30 min | TBD | ğŸ¯ |
| **User Satisfaction** | > 4.5/5 | TBD | ğŸ¯ |
| **AI Accuracy** | > 80% | TBD | ğŸ¯ |
| **Success Rate** | > 70% | TBD | ğŸ¯ |

---

## ğŸš€ Deployment Checklist

- [ ] Database migrations applied
- [ ] OpenAI API key configured
- [ ] Redis cache setup
- [ ] Rate limiters enabled
- [ ] Privacy controls implemented
- [ ] Analytics tracking integrated
- [ ] Load testing completed
- [ ] Security audit passed
- [ ] User documentation ready
- [ ] A/B testing configured

---

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** Ø¯ÙŠØ³Ù…Ø¨Ø± 2024
**Ø§Ù„Ø¥ØµØ¯Ø§Ø±:** 1.0
**Ø§Ù„Ù…Ø·ÙˆØ±:** Xchange Egypt Platform Team
**Contact:** dev@xchange-egypt.com
